const e=document.getElementById("modal-produto"),t=e?.querySelector(".modal-overlay"),a=e?.querySelector(".modal-close"),n=document.getElementById("main-image"),o=document.getElementById("thumbnails-track"),i=e?.querySelector(".expand-btn"),c=document.getElementById("modal-imagem-expandida"),s=document.getElementById("imagem-expandida"),r=c?.querySelector(".modal-close-expandido"),l=c?.querySelector(".contador-imagens");let d=0,m=[],u=null,g=!1;const y=new Map,h=new Set,p=window.innerWidth<=768,v=navigator,f=v.connection&&"slow-2g"===v.connection.effectiveType||"2g"===v.connection?.effectiveType;function b(e,t=!1){return new Promise((a,n)=>{const o=function(e){if(!e.includes("supabase"))return e;try{const t=new URL(e);return p?(t.searchParams.set("width","800"),t.searchParams.set("quality",f?"70":"80"),t.searchParams.set("format","webp"),f&&(t.searchParams.set("resize","fill"),t.searchParams.set("width","600"),t.searchParams.set("quality","60"))):(t.searchParams.set("width","1200"),t.searchParams.set("quality","85"),t.searchParams.set("format","webp")),t.toString()}catch(t){return e}}(e);if(y.has(o))return void a(y.get(o));if(h.has(o)){const e=()=>{y.has(o)?a(y.get(o)):setTimeout(e,10)};return void e()}h.add(o);const i=new Image;(t||p)&&(i.fetchPriority="high",i.loading="eager"),i.onload=()=>{h.delete(o),y.set(o,i),y.set(e,i),a(i)},i.onerror=()=>{h.delete(o),o!==e?b(e,t).then(a).catch(n):n(new Error(`Failed to load image: ${e}`))},o.includes("supabase")&&(i.crossOrigin="anonymous"),i.src=o})}function w(e,t,a=!0,n=!1){if(a&&(e.style.background=p?"linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 25%, #1a1a1a 50%, #2a2a2a 75%, #1a1a1a 100%)":"linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%)",e.style.backgroundSize=p?"300% 100%":"200% 100%",e.style.animation=`skeleton-loading ${p?"1.2s":"1.5s"} ease-in-out infinite`,p)){const t=e.closest(".main-image-container");if(t&&!t.querySelector(".loading-indicator")){const e=document.createElement("div");e.className="loading-indicator",e.innerHTML='\n            <div class="loading-spinner"></div>\n            <span>Carregando imagem...</span>\n          ',t.appendChild(e)}}b(t,n||p).then(t=>{e.src=t.src,e.style.background="",e.style.animation="",e.style.opacity="0";const a=e.closest(".main-image-container"),n=a?.querySelector(".loading-indicator");n&&n.remove(),requestAnimationFrame(()=>{e.style.transition=p?"opacity 0.2s ease":"opacity 0.3s ease",e.style.opacity="1"})}).catch(t=>{e.style.background="",e.style.animation="";const a=e.closest(".main-image-container"),n=a?.querySelector(".loading-indicator");if(n&&n.remove(),e.alt="Erro ao carregar imagem",p){const e=document.createElement("div");e.className="image-error-mobile",e.textContent="Erro ao carregar",a?.appendChild(e)}})}function q(e){if(!n||!o)return;d=e;const t=m[e];y.has(t)?(n.style.opacity="0",setTimeout(()=>{n.src=y.get(t).src,n.style.opacity="1"},150)):w(n,t,!1);setTimeout(()=>{e+1<m.length&&b(m[e+1]).catch(()=>{}),e-1>=0&&b(m[e-1]).catch(()=>{})},100);const a=o.querySelectorAll(".thumbnail");a.forEach((t,a)=>{t.classList.toggle("active",a===e)});const i=a[e];i&&i.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})}function E(){g&&requestAnimationFrame(()=>{e?.classList.remove("active"),document.body.classList.remove("modal-open"),g=!1,d=0})}function L(e){c&&s&&l&&(d=e,w(s,m[d]),l.textContent=`${d+1} / ${m.length}`,requestAnimationFrame(()=>{c.classList.add("active")}))}function S(){requestAnimationFrame(()=>{c?.classList.remove("active")})}window.abrirModalProduto=function(e,t){let a;return function(...n){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),e(...n)},t)}}(t=>{if(!g&&(u=t,g=!0,t.imagens&&t.imagens.length>0&&(b(t.imagens[0],!0).catch(()=>{}),p&&t.imagens.length>1&&!f&&t.imagens.slice(1,4).forEach((e,t)=>{setTimeout(()=>{b(e,t<2).catch(()=>{})},25*t)})),e)){const a=e?.querySelector(".spec-item:nth-child(1)"),i=e?.querySelector(".spec-item:nth-child(2)"),c=e.querySelector(".modal-nome"),s=e.querySelector(".modal-descricao"),r=e.querySelector(".modal-preco"),l=e.querySelector(".modal-condicao"),u=e.querySelector(".modal-categoria"),g=e.querySelector(".modal-bateria"),y=e.querySelector(".modal-codigo"),h=e.querySelector(".modal-specs"),v=e.querySelector(".spec-fallback");c&&(c.textContent=t.nome),s&&(s.textContent=t.descricao),r&&(r.textContent=t.preco),l&&(l.textContent=t.condicao),u&&(u.textContent=t.categoria),null!==t.bateria&&void 0!==t.bateria&&""!==t.bateria?(g&&(g.textContent=`${t.bateria}%`),a&&(a.style.display="flex"),function(t){const a=e?.querySelector(".bateria-icon-wrapper"),n=e?.querySelector(".bateria-fill");if(!a||!n)return;const o=t/100*14;n.setAttribute("width",o.toString()),a.classList.remove("bateria-verde","bateria-vermelho"),t>=80?a.classList.add("bateria-verde"):a.classList.add("bateria-vermelho")}(t.bateria)):a&&(a.style.display="none"),null!==t.codigo&&void 0!==t.codigo&&""!==t.codigo?(y&&(y.textContent=t.codigo),i&&(i.style.display="flex")):i&&(i.style.display="none"),null!==t.codigo&&void 0!==t.codigo&&""!==t.codigo&&null!==t.bateria&&void 0!==t.bateria&&""!==t.bateria?(h&&(h.style.display="grid"),v&&(v.style.display="none")):(h&&(h.style.display="none"),v&&(v.style.display="flex")),m=t.imagens||[],function(e){if(!n||!o)return;if(d=0,0===e.length)return n.src="",n.style.display="none",void(o.innerHTML='<div class="no-images">Sem imagens disponíveis</div>');n.style.display="block",w(n,e[0],!0,!0),p&&!f?setTimeout(()=>{e.slice(1).forEach((e,t)=>{setTimeout(()=>{b(e,t<2).catch(()=>{})},50*t)})},100):p&&f?e.length>1&&setTimeout(()=>{b(e[1]).catch(()=>{})},300):e.length>1&&setTimeout(()=>{b(e[1]).catch(()=>{}),e.length>2&&setTimeout(()=>b(e[2]).catch(()=>{}),100)},200);const t=document.createDocumentFragment();e.forEach((e,a)=>{const n=document.createElement("div");n.className="thumbnail "+(0===a?"active":"");const o=document.createElement("img");o.alt=`Thumbnail ${a+1}`,o.loading="lazy",o.style.opacity="0",o.style.transition="opacity 0.3s ease";const i=document.createElement("div");i.className="thumb-overlay",n.appendChild(o),n.appendChild(i),n.dataset.index=a.toString();const c=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target;b(t.dataset.src).then(e=>{t.src=e.src,t.style.opacity="1",c.unobserve(t)}).catch(()=>{t.style.opacity="1",c.unobserve(t)})}})},{threshold:.1});o.dataset.src=e,c.observe(o),t.appendChild(n)}),o.innerHTML="",o.appendChild(t)}(m),requestAnimationFrame(()=>{e.classList.add("active"),document.body.classList.add("modal-open")})}},100),o?.addEventListener("click",e=>{const t=e.target.closest(".thumbnail");if(!t)return;q(parseInt(t.dataset.index||"0"))}),t?.addEventListener("click",E),a?.addEventListener("click",E),i?.addEventListener("click",()=>{m.length>0&&L(d)}),n?.addEventListener("click",()=>{m.length>0&&L(d)}),r?.addEventListener("click",S),c?.addEventListener("click",e=>{e.target===c&&S()}),document.addEventListener("keydown",t=>{c?.classList.contains("active")?"Escape"===t.key?S():"ArrowLeft"===t.key&&d>0?(q(d-1),L(d)):"ArrowRight"===t.key&&d<m.length-1&&(q(d+1),L(d)):e?.classList.contains("active")&&("Escape"===t.key?E():"ArrowLeft"===t.key&&d>0?q(d-1):"ArrowRight"===t.key&&d<m.length-1&&q(d+1))});const k=e?.querySelector(".btn-whatsapp");k?.addEventListener("click",e=>{if(e.preventDefault(),u){const e="5577981022246",t=`${window.location.origin}/produto/${encodeURIComponent(u.nome.toLowerCase().replace(/\s+/g,"-"))}`;let a=`Olá! Tenho interesse no *${u.nome}*`;u.codigo&&(a+=`\nCódigo: ${u.codigo}`),a+=`\n\nLink: ${t}`;const n=`https://wa.me/${e}?text=${encodeURIComponent(a)}`;window.open(n,"_blank")}});
