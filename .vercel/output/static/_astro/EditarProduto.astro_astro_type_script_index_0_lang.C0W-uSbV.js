import{p as e,c as t}from"./supabase.Cm9Ta47n.js";const o=document.getElementById("modal-editar-produto"),n=document.getElementById("form-editar-produto"),a=document.getElementById("editar-image-upload-area"),r=document.getElementById("editar-product-images"),i=document.getElementById("editar-image-preview-grid"),d=document.getElementById("editar-upload-progress"),s=o?.querySelector(".btn-cancel"),c=o?.querySelector(".modal-close"),l=document.getElementById("editar-produto-categoria"),u=n?.querySelector(".btn-submit");let m=[],g=[],p="";function v(e,t="info"){const o=document.createElement("div");o.className=`toast toast-${t}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.remove(),300)},3e3)}function y(e){const t=document.getElementById("editar-upload-placeholder"),o=m.length+g.length;if(5-o<=0)return void v("Máximo de 5 imagens atingido","warning");let n=0;Array.from(e).forEach(e=>{e.type.startsWith("image/")&&o+n<5&&(m.push(e),n++)}),n>0&&(h(),o+n>=5&&v("Limite de 5 imagens atingido","info")),g.length+m.length>0&&t&&t.classList.add("hidden")}function h(){if(!i)return;const e=document.getElementById("editar-upload-placeholder");i.innerHTML="",g.forEach((e,t)=>{!function(e,t){if(!i)return;const o=document.createElement("div");o.className="image-preview-item",o.innerHTML=`\n        <img src="${e}" alt="Preview ${t+1}" loading="lazy">\n        <button type="button" class="remove-image" data-index="${t}" data-existing="true" aria-label="Remover imagem">\n          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n          </svg>\n        </button>\n        <span class="image-number">${t+1}</span>\n      `;const n=o.querySelector(".remove-image");n?.addEventListener("click",e=>{e.stopPropagation();const t=parseInt(e.currentTarget.dataset.index||"0");"true"===e.currentTarget.dataset.existing?g.splice(t,1):m.splice(t-g.length,1),h(),v("Imagem removida","info")}),i.appendChild(o)}(e,t)}),m.forEach((e,t)=>{const o=new FileReader;o.onload=e=>{const o=document.createElement("div");o.className="image-preview-item";const n=g.length+t;o.innerHTML=`\n          <img src="${e.target?.result}" alt="Preview ${n+1}" loading="lazy">\n          <button type="button" class="remove-image" data-index="${n}" data-existing="false" aria-label="Remover imagem">\n            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n          </button>\n          <span class="image-number">${n+1}</span>\n        `;const a=o.querySelector(".remove-image");a?.addEventListener("click",e=>{e.stopPropagation(),m.splice(t,1),h(),v("Imagem removida","info")}),i.appendChild(o)},o.readAsDataURL(e)});g.length+m.length>0&&e?e.classList.add("hidden"):e&&e.classList.remove("hidden")}function f(){const e=document.getElementById("editar-upload-placeholder");if(o?.classList.remove("active"),document.body.style.overflow="",n?.reset(),m=[],g=[],p="",i&&(i.innerHTML=""),e&&e.classList.remove("hidden"),d){d.classList.remove("active");const e=d.querySelector(".progress-fill");e&&(e.style.width="0%")}}a?.addEventListener("click",()=>{m.length+g.length>=5?v("Máximo de 5 imagens permitido","warning"):r?.click()}),a?.addEventListener("dragover",e=>{e.preventDefault(),a.style.borderColor="#fff"}),a?.addEventListener("dragleave",()=>{a.style.borderColor="rgba(255, 255, 255, 0.1)"}),a?.addEventListener("drop",e=>{e.preventDefault(),a.style.borderColor="rgba(255, 255, 255, 0.1)";const t=e.dataTransfer?.files;t&&y(t)}),r?.addEventListener("change",e=>{const t=e.target,o=t.files;o&&y(o),t.value=""}),n?.addEventListener("submit",async t=>{if(t.preventDefault(),function(){if(0===g.length+m.length)return v("Adicione pelo menos uma imagem do produto","warning"),a?.scrollIntoView({behavior:"smooth",block:"center"}),!1;if(parseFloat(document.getElementById("editar-produto-preco").value)<=0)return v("O preço deve ser maior que zero","warning"),!1;const e=document.getElementById("editar-produto-bateria");if(e.value){const t=parseInt(e.value);if(t<0||t>100)return v("A bateria deve estar entre 0 e 100%","warning"),!1}return!0}())try{u&&(u.disabled=!0,u.querySelector(".btn-text").textContent="Salvando...",u.querySelector(".btn-spinner").setAttribute("style","display: inline-block")),document.body.style.overflow="hidden";const t=d?.querySelector(".progress-fill");m.length>0&&d?.classList.add("active");const o=[];for(let n=0;n<m.length;n++){const a=await e.uploadImage(m[n]);if(o.push(a),t&&m.length>0){const e=(n+1)/m.length*100;t.style.width=`${e}%`}}d?.classList.remove("active");const a=[...g,...o],r=new FormData(n),i=r.get("bateria"),s={codigo:r.get("codigo"),nome:r.get("nome"),descricao:r.get("descricao"),preco:parseFloat(r.get("preco")),condicao:r.get("condicao"),bateria:i?parseInt(i):0,categoria_id:r.get("categoria"),imagens:a};await e.update(p,s),window.dispatchEvent(new Event("produtos-updated")),f(),v("Produto atualizado com sucesso!","success")}catch(o){v(`Erro ao atualizar produto: ${o?.message||JSON.stringify(o)||"Erro desconhecido"}`,"error")}finally{u&&(u.disabled=!1,u.querySelector(".btn-text").textContent="Salvar Alterações",u.querySelector(".btn-spinner").setAttribute("style","display: none")),d?.classList.remove("active"),document.body.style.overflow=""}}),s?.addEventListener("click",f),c?.addEventListener("click",f),o?.querySelector(".modal-overlay")?.addEventListener("click",f),document.addEventListener("keydown",e=>{"Escape"===e.key&&o?.classList.contains("active")&&f()});const E=o?.querySelector(".btn-delete");E?.addEventListener("click",async()=>{if(confirm("Tem certeza que deseja excluir este produto? Esta ação não pode ser desfeita."))try{await e.delete(p),window.dispatchEvent(new Event("produtos-updated")),f(),v("Produto excluído com sucesso!","success")}catch(t){v("Erro ao excluir produto","error")}}),window.abrirModalEditarProduto=function(e){p=e.id,g=[...e.imagens||[]],m=[],document.getElementById("editar-produto-id").value=e.id,document.getElementById("editar-produto-nome").value=e.nome,document.getElementById("editar-produto-codigo").value=e.codigo||"",document.getElementById("editar-produto-preco").value=e.preco.toString(),document.getElementById("editar-produto-bateria").value=e.bateria?e.bateria.toString():"",document.getElementById("editar-produto-condicao").value=e.condicao,document.getElementById("editar-produto-descricao").value=e.descricao||"",async function(){if(l)try{const e=await t.getAll();l.innerHTML='<option value="">Selecione a categoria...</option>',e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.nome,l.appendChild(t)})}catch(e){v("Erro ao carregar categorias","error")}}().then(()=>{document.getElementById("editar-produto-categoria").value=e.categoria_id}),h(),o?.classList.add("active"),document.body.style.overflow="hidden",window.innerWidth>=768&&setTimeout(()=>{document.getElementById("editar-produto-nome")?.focus()},300)};
