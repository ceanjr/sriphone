---
// src/components/ModalProduto.astro
import '../styles/components/modal-produto.css';
---

<div id="modal-produto" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-drag-handle"></div>
        
        <button class="modal-close" aria-label="Fechar">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>

        <div class="modal-body">
            <!-- Galeria - Hero em Mobile -->
            <div class="modal-gallery">
                <div class="carousel">
                    <button class="carousel-btn prev" aria-label="Anterior">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="carousel-track"></div>
                    <button class="carousel-btn next" aria-label="Próximo">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <div class="carousel-dots"></div>
            </div>

            <!-- Informações - Compactas e Elegantes -->
            <div class="modal-info">
                <div class="info-header">
                    <div class="modal-badges">
                        <span class="modal-condicao"></span>
                        <span class="modal-categoria"></span>
                    </div>
                    <h2 class="modal-nome"></h2>
                </div>

                <div class="info-body">
                    <p class="modal-descricao"></p>
                    
                    <div class="modal-specs">
                        <div class="spec-item">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2" y="7" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M20 10H22V14H20" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <div>
                                <span class="spec-label">Bateria</span>
                                <span class="spec-value modal-bateria"></span>
                            </div>
                        </div>
                        <div class="spec-item">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7 7H17M7 12H17M7 17H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <div>
                                <span class="spec-label">Código</span>
                                <span class="spec-value modal-codigo"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-footer">
                    <div class="modal-preco"></div>
                    <a href="#" class="btn-whatsapp" target="_blank" rel="noopener noreferrer">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.472 14.382C17.015 14.153 14.98 13.146 14.571 12.996C14.162 12.846 13.868 12.771 13.573 13.229C13.278 13.687 12.463 14.617 12.206 14.912C11.949 15.207 11.692 15.245 11.235 15.016C10.778 14.787 9.26 14.285 7.463 12.676C6.06 11.418 5.146 9.867 4.889 9.409C4.632 8.951 4.861 8.712 5.09 8.483C5.296 8.277 5.547 7.947 5.776 7.69C6.005 7.433 6.081 7.252 6.231 6.957C6.381 6.662 6.306 6.405 6.192 6.176C6.081 5.947 5.146 3.912 4.775 2.996C4.418 2.108 4.051 2.228 3.78 2.215C3.522 2.202 3.228 2.202 2.933 2.202C2.638 2.202 2.143 2.316 1.734 2.774C1.325 3.232 0.242 4.239 0.242 6.274C0.242 8.309 1.772 10.269 1.997 10.564C2.226 10.859 5.146 15.229 9.588 17.002C10.627 17.458 11.437 17.725 12.064 17.923C13.108 18.254 14.057 18.206 14.813 18.092C15.654 17.964 17.31 17.077 17.681 16.099C18.052 15.121 18.052 14.305 17.938 14.115C17.824 13.925 17.529 13.811 17.072 13.582" fill="currentColor"/>
                        </svg>
                        Consultar no WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Imagem Expandida -->
    <div id="modal-imagem-expandida" class="modal-imagem-expandida">
        <button class="modal-close-expandido" aria-label="Fechar">×</button>
        <div class="imagem-expandida-container">
            <button class="nav-btn prev-expandido" aria-label="Anterior">‹</button>
            <img id="imagem-expandida" src="" alt="Imagem expandida" />
            <button class="nav-btn next-expandido" aria-label="Próximo">›</button>
        </div>
        <div class="contador-imagens"></div>
    </div>
</div>

<script>
    import type { Product } from '../types';

    const modal = document.getElementById('modal-produto');
    const modalOverlay = modal?.querySelector('.modal-overlay');
    const modalClose = modal?.querySelector('.modal-close');
    const carouselTrack = modal?.querySelector('.carousel-track');
    const carouselDots = modal?.querySelector('.carousel-dots');
    const btnPrev = modal?.querySelector('.carousel-btn.prev');
    const btnNext = modal?.querySelector('.carousel-btn.next');
    
    const modalImagemExpandida = document.getElementById('modal-imagem-expandida') as HTMLElement | null;
    const imagemExpandida = document.getElementById('imagem-expandida') as HTMLImageElement | null;
    const btnCloseExpandido = modalImagemExpandida?.querySelector('.modal-close-expandido') as HTMLButtonElement | null;
    const btnPrevExpandido = modalImagemExpandida?.querySelector('.prev-expandido') as HTMLButtonElement | null;
    const btnNextExpandido = modalImagemExpandida?.querySelector('.next-expandido') as HTMLButtonElement | null;
    const contadorImagens = modalImagemExpandida?.querySelector('.contador-imagens');
    
    let currentSlide = 0;
    let totalSlides = 0;
    let produtoAtual: Product | null = null;
    let startX = 0;
    let endX = 0;
    let currentX = 0;
    let isDragging = false;
    let imagensAtuais: string[] = [];

    (window as any).abrirModalProduto = (produto: any) => {
        produtoAtual = produto;
        
        if (modal) {
            const modalNome = modal.querySelector('.modal-nome');
            const modalDescricao = modal.querySelector('.modal-descricao');
            const modalPreco = modal.querySelector('.modal-preco');
            const modalCondicao = modal.querySelector('.modal-condicao');
            const modalCategoria = modal.querySelector('.modal-categoria');
            const modalBateria = modal.querySelector('.modal-bateria');
            const modalCodigo = modal.querySelector('.modal-codigo');
            
            if (modalNome) modalNome.textContent = produto.nome;
            if (modalDescricao) modalDescricao.textContent = produto.descricao;
            if (modalPreco) modalPreco.textContent = produto.preco;
            if (modalCondicao) modalCondicao.textContent = produto.condicao;
            if (modalCategoria) modalCategoria.textContent = produto.categoria;
            if (modalBateria) modalBateria.textContent = `${produto.bateria}%`;
            if (modalCodigo) modalCodigo.textContent = produto.codigo;
            
            imagensAtuais = produto.imagens || [];
            createCarousel(imagensAtuais);
            
            modal.classList.add('active');
            document.body.classList.add('modal-open');
            
            // Prevenir scroll do body
            const scrollY = window.scrollY;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.width = '100%';
        }
    };

    function fecharModal() {
        modal?.classList.remove('active');
        
        // Restaurar scroll do body
        const scrollY = document.body.style.top;
        document.body.classList.remove('modal-open');
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        window.scrollTo(0, parseInt(scrollY || '0') * -1);
        
        currentSlide = 0;
    }

    modalOverlay?.addEventListener('click', fecharModal);
    modalClose?.addEventListener('click', fecharModal);

    function createCarousel(imagens: string[]) {
        if (!carouselTrack || !carouselDots) return;

        carouselTrack.innerHTML = '';
        carouselDots.innerHTML = '';
        totalSlides = imagens.length;

        if (totalSlides === 0) {
            carouselTrack.innerHTML = `
                <div class="carousel-slide">
                    <svg class="carousel-placeholder" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 16V8C21 6.89543 20.1046 6 19 6H5C3.89543 6 3 6.89543 3 8V16C3 17.1046 3.89543 18 5 18H19C20.1046 18 21 17.1046 21 16Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M9 12L12 9L15 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
            `;
            return;
        }

        imagens.forEach((img, index) => {
            const slide = document.createElement('div');
            slide.className = 'carousel-slide';
            slide.innerHTML = `<img src="${img}" alt="Produto ${index + 1}" loading="lazy" draggable="false">`;
            slide.addEventListener('click', () => abrirImagemExpandida(index));
            carouselTrack.appendChild(slide);

            const dot = document.createElement('div');
            dot.className = `dot ${index === 0 ? 'active' : ''}`;
            dot.addEventListener('click', () => goToSlide(index));
            carouselDots.appendChild(dot);
        });

        setupSwipeHandlers();
    }

    function setupSwipeHandlers() {
        if (!carouselTrack) return;

        carouselTrack.addEventListener('touchstart', handleTouchStart, { passive: true });
        carouselTrack.addEventListener('touchmove', handleTouchMove, { passive: false });
        carouselTrack.addEventListener('touchend', handleTouchEnd, { passive: true });
    }

    function handleTouchStart(e: TouchEvent) {
        startX = e.touches[0].clientX;
        currentX = startX;
        isDragging = true;
        carouselTrack?.classList.add('swiping');
    }

    function handleTouchMove(e: TouchEvent) {
        if (!isDragging || !carouselTrack) return;
        
        e.preventDefault();
        currentX = e.touches[0].clientX;
        const diff = currentX - startX;
        const currentOffset = -currentSlide * 100;
        const dragPercentage = (diff / window.innerWidth) * 100;
        
        // Aplicar movimento em tempo real com limite de arrasto
        const maxDrag = 30; // Limite de 30% de arrasto além das bordas
        let newOffset = currentOffset + dragPercentage;
        
        // Limitar arrasto nas bordas
        if (currentSlide === 0 && diff > 0) {
            newOffset = Math.min(newOffset, maxDrag);
        } else if (currentSlide === totalSlides - 1 && diff < 0) {
            newOffset = Math.max(newOffset, currentOffset - maxDrag);
        }
        
        (carouselTrack as HTMLElement).style.transform = `translateX(${newOffset}%)`;
    }

function handleTouchEnd() {
        if (!isDragging || !carouselTrack) return;
        
        carouselTrack.classList.remove('swiping');
        isDragging = false;
        
        const diffX = startX - currentX;
        const threshold = window.innerWidth * 0.15; // 15% da largura da tela
        const velocity = Math.abs(diffX);

        // Swipe com velocidade ou distância suficiente
        if (Math.abs(diffX) > threshold || velocity > 50) {
            if (diffX > 0 && currentSlide < totalSlides - 1) {
                // Swipe para esquerda - próxima imagem
                nextSlide();
            } else if (diffX < 0 && currentSlide > 0) {
                // Swipe para direita - imagem anterior
                prevSlide();
            } else {
                // Voltar para posição atual
                goToSlide(currentSlide);
            }
        } else {
            // Voltar para posição atual se não passou do threshold
            goToSlide(currentSlide);
        }
        
        // Resetar valores para o próximo swipe
        startX = 0;
        currentX = 0;
        endX = 0;
    }

    function goToSlide(index: number) {
        if (!carouselTrack) return;
        currentSlide = index;
        const track = carouselTrack as HTMLElement;
        track.style.transform = `translateX(-${currentSlide * 100}%)`;
        
        document.querySelectorAll('.dot').forEach((dot, i) => {
            dot.classList.toggle('active', i === currentSlide);
        });
    }

    function nextSlide() {
        if (currentSlide < totalSlides - 1) {
            goToSlide(currentSlide + 1);
        }
    }

    function prevSlide() {
        if (currentSlide > 0) {
            goToSlide(currentSlide - 1);
        }
    }

    btnPrev?.addEventListener('click', prevSlide);
    btnNext?.addEventListener('click', nextSlide);

    function abrirImagemExpandida(index: number) {
        if (!modalImagemExpandida || !imagemExpandida || !contadorImagens) return;

        currentSlide = index;
        imagemExpandida.src = imagensAtuais[currentSlide];
        if (contadorImagens) {
            contadorImagens.textContent = `${currentSlide + 1} / ${imagensAtuais.length}`;
        }
        
        modalImagemExpandida.classList.add('active');

        imagemExpandida.addEventListener('touchstart', handleTouchStart, { passive: true });
        imagemExpandida.addEventListener('touchmove', handleTouchMove, { passive: true });
        imagemExpandida.addEventListener('touchend', () => {
            handleTouchEnd();
            atualizarImagemExpandida();
        });
    }

    function atualizarImagemExpandida() {
        if (!imagemExpandida || !contadorImagens) return;
        imagemExpandida.src = imagensAtuais[currentSlide];
        contadorImagens.textContent = `${currentSlide + 1} / ${imagensAtuais.length}`;
    }

    function fecharImagemExpandida() {
        modalImagemExpandida?.classList.remove('active');
    }

    btnCloseExpandido?.addEventListener('click', fecharImagemExpandida);
    modalImagemExpandida?.addEventListener('click', (e) => {
        if (e.target === modalImagemExpandida) {
            fecharImagemExpandida();
        }
    });

    btnPrevExpandido?.addEventListener('click', () => {
        prevSlide();
        atualizarImagemExpandida();
    });

    btnNextExpandido?.addEventListener('click', () => {
        nextSlide();
        atualizarImagemExpandida();
    });

    const btnWhatsapp = modal?.querySelector('.btn-whatsapp');
    btnWhatsapp?.addEventListener('click', (e) => {
        e.preventDefault();
        if (produtoAtual) {
            const telefone = '5577981022246';
            const mensagem = `Olá! Tenho interesse no *${produtoAtual.nome}*\n${produtoAtual.descricao}\n${produtoAtual.preco}`;
            const url = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');
        }
    });

    document.addEventListener('keydown', (e: KeyboardEvent) => {
        if (modal?.classList.contains('active')) {
            if (e.key === 'Escape') {
                fecharModal();
            } else if (e.key === 'ArrowLeft') {
                prevSlide();
            } else if (e.key === 'ArrowRight') {
                nextSlide();
            }
        }
        
        if (modalImagemExpandida?.classList.contains('active')) {
            if (e.key === 'Escape') {
                fecharImagemExpandida();
            } else if (e.key === 'ArrowLeft') {
                prevSlide();
                atualizarImagemExpandida();
            } else if (e.key === 'ArrowRight') {
                nextSlide();
                atualizarImagemExpandida();
            }
        }
    });
</script>