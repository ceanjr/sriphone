---
// src/components/ModalProduto.astro
---

<div id="modal-produto" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <button class="modal-close" aria-label="Fechar">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>

        <div class="modal-body">
            <div class="modal-gallery">
                <div class="carousel">
                    <button class="carousel-btn prev" aria-label="Anterior">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="carousel-track"></div>
                    <button class="carousel-btn next" aria-label="Próximo">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <div class="carousel-dots"></div>
            </div>

            <div class="modal-info">
                <div class="modal-badges">
                    <span class="modal-condicao"></span>
                    <span class="modal-categoria"></span>
                </div>
                <h2 class="modal-nome"></h2>
                <p class="modal-descricao"></p>
                <div class="modal-specs">
                    <div class="spec-item">
                        <span class="spec-label">Bateria</span>
                        <div class="spec-bateria">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2" y="7" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M20 10H22V14H20" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span class="modal-bateria"></span>
                        </div>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">Código</span>
                        <span class="modal-codigo"></span>
                    </div>
                </div>
                <div class="modal-preco"></div>
            </div>
        </div>

        <div class="modal-footer">
            <a href="#" class="btn-whatsapp" target="_blank" rel="noopener noreferrer">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.472 14.382C17.015 14.153 14.98 13.146 14.571 12.996C14.162 12.846 13.868 12.771 13.573 13.229C13.278 13.687 12.463 14.617 12.206 14.912C11.949 15.207 11.692 15.245 11.235 15.016C10.778 14.787 9.26 14.285 7.463 12.676C6.06 11.418 5.146 9.867 4.889 9.409C4.632 8.951 4.861 8.712 5.09 8.483C5.296 8.277 5.547 7.947 5.776 7.69C6.005 7.433 6.081 7.252 6.231 6.957C6.381 6.662 6.306 6.405 6.192 6.176C6.081 5.947 5.146 3.912 4.775 2.996C4.418 2.108 4.051 2.228 3.78 2.215C3.522 2.202 3.228 2.202 2.933 2.202C2.638 2.202 2.143 2.316 1.734 2.774C1.325 3.232 0.242 4.239 0.242 6.274C0.242 8.309 1.772 10.269 1.997 10.564C2.226 10.859 5.146 15.229 9.588 17.002C10.627 17.458 11.437 17.725 12.064 17.923C13.108 18.254 14.057 18.206 14.813 18.092C15.654 17.964 17.31 17.077 17.681 16.099C18.052 15.121 18.052 14.305 17.938 14.115C17.824 13.925 17.529 13.811 17.072 13.582" fill="currentColor"/>
                </svg>
                Consultar no WhatsApp
            </a>
        </div>
    </div>

    <!-- Modal de Imagem Expandida -->
    <div id="modal-imagem-expandida" class="modal-imagem-expandida">
        <button class="modal-close-expandido" aria-label="Fechar">×</button>
        <div class="imagem-expandida-container">
            <button class="nav-btn prev-expandido" aria-label="Anterior">‹</button>
            <img id="imagem-expandida" src="" alt="Imagem expandida" />
            <button class="nav-btn next-expandido" aria-label="Próximo">›</button>
        </div>
        <div class="contador-imagens"></div>
    </div>
</div>

<style>
    .modal {
        position: fixed;
        inset: 0;
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .modal.active {
        display: flex;
    }

    .modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        position: relative;
        background: #0a0a0a;
        border: 1px solid #2a2a2a;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1;
        display: flex;
        flex-direction: column;
    }

    @media (min-width: 768px) {
        .modal {
            padding: 1rem;
        }

        .modal-content {
            border-radius: 24px;
            max-width: 1100px;
            max-height: 90vh;
            height: auto;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid #2a2a2a;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
    }

    .modal-close:hover {
        background: #fff;
        color: #000;
        transform: rotate(90deg);
    }

    .modal-close svg {
        width: 20px;
        height: 20px;
    }

    .modal-body {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
    }

    @media (min-width: 768px) {
        .modal-body {
            flex-direction: row;
        }
    }

    .modal-gallery {
        position: relative;
        background: #000;
        flex: 1;
    }

    @media (min-width: 768px) {
        .modal-gallery {
            border-radius: 24px 0 0 0;
        }
    }

    .carousel {
        position: relative;
        aspect-ratio: 1;
        overflow: hidden;
    }

    @media (min-width: 768px) {
        .carousel {
            aspect-ratio: 4/3;
        }
    }

    .carousel-track {
        display: flex;
        height: 100%;
        transition: transform 0.4s ease;
        touch-action: pan-y pinch-zoom;
    }

    .carousel-slide {
        min-width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #0a0a0a;
        cursor: pointer;
    }

    .carousel-slide img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        user-select: none;
        padding: 1rem;
    }

    .carousel-placeholder {
        width: 120px;
        height: 120px;
        color: #333;
    }

    .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.95);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 5;
    }

    @media (max-width: 767px) {
        .carousel-btn {
            display: none;
        }
    }

    .carousel-btn:hover {
        background: #fff;
        transform: translateY(-50%) scale(1.1);
    }

    .carousel-btn.prev {
        left: 1rem;
    }

    .carousel-btn.next {
        right: 1rem;
    }

    .carousel-btn svg {
        width: 20px;
        height: 20px;
    }

    .carousel-dots {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
        background: #000;
    }

    .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #333;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .dot.active {
        background: #fff;
        width: 24px;
        border-radius: 4px;
    }

    .modal-info {
        padding: 1.5rem;
        display: none;
        flex-direction: column;
    }

    @media (min-width: 768px) {
        .modal-info {
            display: flex;
            flex: 1;
            max-width: 450px;
            overflow-y: auto;
        }
    }

    .modal-badges {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .modal-condicao,
    .modal-categoria {
        display: inline-block;
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .modal-condicao {
        background: #1a1a1a;
        color: #fff;
    }

    .modal-categoria {
        background: #0a0a0a;
        border: 1px solid #2a2a2a;
        color: #999;
    }

    .modal-nome {
        font-family: "Halenoir", sans-serif;
        font-size: 1.5rem;
        color: var(--cor-primaria);
        margin-bottom: 0.5rem;
    }

    @media (min-width: 768px) {
        .modal-nome {
            font-size: 2rem;
        }
    }

    .modal-descricao {
        color: #999;
        font-size: 1rem;
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    @media (min-width: 768px) {
        .modal-descricao {
            font-size: 1.1rem;
        }
    }

    .modal-specs {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #0a0a0a;
        border: 1px solid #1a1a1a;
        border-radius: 12px;
        flex-wrap: wrap;
    }

    .spec-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex: 1;
        min-width: 120px;
    }

    .spec-label {
        font-size: 0.75rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .spec-bateria {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #22c55e;
        font-weight: 600;
    }

    .spec-bateria svg {
        width: 24px;
        height: 24px;
    }

    .modal-codigo {
        font-family: 'Courier New', monospace;
        color: #fff;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .modal-preco {
        font-family: "Halenoir", sans-serif;
        font-size: 2rem;
        color: var(--cor-primaria);
        font-weight: 900;
        margin-bottom: 1rem;
    }

    @media (min-width: 768px) {
        .modal-preco {
            font-size: 2.5rem;
        }
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #1a1a1a;
        background: #0a0a0a;
    }

    .btn-whatsapp {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        background: transparent;
        border: 2px solid #2a2a2a;
        color: #fff;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        width: 100%;
    }

    .btn-whatsapp:hover {
        border-color: #25D366;
        background: rgba(37, 211, 102, 0.1);
    }

    .btn-whatsapp svg {
        width: 24px;
        height: 24px;
        fill: #25D366;
    }

    /* Modal de Imagem Expandida */
    .modal-imagem-expandida {
        position: fixed;
        inset: 0;
        z-index: 2000;
        background: rgba(0, 0, 0, 0.98);
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal-imagem-expandida.active {
        display: flex;
    }

    .modal-close-expandido {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #fff;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        font-size: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
    }

    .modal-close-expandido:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .imagem-expandida-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    #imagem-expandida {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        user-select: none;
    }

    .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #fff;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        font-size: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .prev-expandido {
        left: 2rem;
    }

    .next-expandido {
        right: 2rem;
    }

    .contador-imagens {
        position: absolute;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
    }
</style>

<script>
    import type { Product } from '../types';

    const modal = document.getElementById('modal-produto');
    const modalOverlay = modal?.querySelector('.modal-overlay');
    const modalClose = modal?.querySelector('.modal-close');
    const carouselTrack = modal?.querySelector('.carousel-track');
    const carouselDots = modal?.querySelector('.carousel-dots');
    const btnPrev = modal?.querySelector('.carousel-btn.prev');
    const btnNext = modal?.querySelector('.carousel-btn.next');
    
    const modalImagemExpandida = document.getElementById('modal-imagem-expandida') as HTMLElement | null;
    const imagemExpandida = document.getElementById('imagem-expandida') as HTMLImageElement | null;
    const btnCloseExpandido = modalImagemExpandida?.querySelector('.modal-close-expandido') as HTMLButtonElement | null;
    const btnPrevExpandido = modalImagemExpandida?.querySelector('.prev-expandido') as HTMLButtonElement | null;
    const btnNextExpandido = modalImagemExpandida?.querySelector('.next-expandido') as HTMLButtonElement | null;
    const contadorImagens = modalImagemExpandida?.querySelector('.contador-imagens');
    
    let currentSlide = 0;
    let totalSlides = 0;
    let produtoAtual: Product | null = null;
    let startX = 0;
    let endX = 0;
    let imagensAtuais: string[] = [];

    // Função para abrir modal (será chamada de fora)
    (window as any).abrirModalProduto = (produto: any) => {
        produtoAtual = produto;
        
        if (modal) {
            const modalNome = modal.querySelector('.modal-nome');
            const modalDescricao = modal.querySelector('.modal-descricao');
            const modalPreco = modal.querySelector('.modal-preco');
            const modalCondicao = modal.querySelector('.modal-condicao');
            const modalCategoria = modal.querySelector('.modal-categoria');
            const modalBateria = modal.querySelector('.modal-bateria');
            const modalCodigo = modal.querySelector('.modal-codigo');
            
            if (modalNome) modalNome.textContent = produto.nome;
            if (modalDescricao) modalDescricao.textContent = produto.descricao;
            if (modalPreco) modalPreco.textContent = produto.preco;
            if (modalCondicao) modalCondicao.textContent = produto.condicao;
            if (modalCategoria) modalCategoria.textContent = produto.categoria;
            if (modalBateria) modalBateria.textContent = `${produto.bateria}%`;
            if (modalCodigo) modalCodigo.textContent = produto.codigo;
            
            imagensAtuais = produto.imagens || [];
            createCarousel(imagensAtuais);
            
            modal.classList.add('active');
            const body = document.body as HTMLBodyElement;
            body.style.overflow = 'hidden';
        }
    };

    function fecharModal() {
        modal?.classList.remove('active');
        const body = document.body as HTMLBodyElement;
        body.style.overflow = '';
        currentSlide = 0;
    }

    modalOverlay?.addEventListener('click', fecharModal);
    modalClose?.addEventListener('click', fecharModal);

    function createCarousel(imagens: string[]) {
        if (!carouselTrack || !carouselDots) return;

        carouselTrack.innerHTML = '';
        carouselDots.innerHTML = '';
        totalSlides = imagens.length;

        if (totalSlides === 0) {
            carouselTrack.innerHTML = `
                <div class="carousel-slide">
                    <svg class="carousel-placeholder" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 16V8C21 6.89543 20.1046 6 19 6H5C3.89543 6 3 6.89543 3 8V16C3 17.1046 3.89543 18 5 18H19C20.1046 18 21 17.1046 21 16Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M9 12L12 9L15 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
            `;
            return;
        }

        imagens.forEach((img, index) => {
            const slide = document.createElement('div');
            slide.className = 'carousel-slide';
            slide.innerHTML = `<img src="${img}" alt="Produto ${index + 1}" loading="lazy">`;
            slide.addEventListener('click', () => abrirImagemExpandida(index));
            carouselTrack.appendChild(slide);

            const dot = document.createElement('div');
            dot.className = `dot ${index === 0 ? 'active' : ''}`;
            dot.addEventListener('click', () => goToSlide(index));
            carouselDots.appendChild(dot);
        });

        // Touch events para mobile
        carouselTrack.addEventListener('touchstart', handleTouchStart, { passive: true });
        carouselTrack.addEventListener('touchmove', handleTouchMove, { passive: true });
        carouselTrack.addEventListener('touchend', handleTouchEnd);
    }

    function handleTouchStart(e: TouchEvent) {
        startX = e.touches[0].clientX;
    }

    function handleTouchMove(e: TouchEvent) {
        endX = e.touches[0].clientX;
    }

    function handleTouchEnd() {
        const diff = startX - endX;
        const threshold = 50;

        if (Math.abs(diff) > threshold) {
            if (diff > 0) {
                // Swipe left - próxima imagem
                nextSlide();
            } else {
                // Swipe right - imagem anterior
                prevSlide();
            }
        }
    }

    function goToSlide(index: number) {
        if (!carouselTrack) return;
        currentSlide = index;
        const track = carouselTrack as HTMLElement;
        track.style.transform = `translateX(-${currentSlide * 100}%)`;
        
        document.querySelectorAll('.dot').forEach((dot, i) => {
            dot.classList.toggle('active', i === currentSlide);
        });
    }

    function nextSlide() {
        currentSlide = currentSlide < totalSlides - 1 ? currentSlide + 1 : 0;
        goToSlide(currentSlide);
    }

    function prevSlide() {
        currentSlide = currentSlide > 0 ? currentSlide - 1 : totalSlides - 1;
        goToSlide(currentSlide);
    }

    btnPrev?.addEventListener('click', prevSlide);
    btnNext?.addEventListener('click', nextSlide);

    // Modal de imagem expandida
    function abrirImagemExpandida(index: number) {
        if (!modalImagemExpandida || !imagemExpandida || !contadorImagens) return;

        currentSlide = index;
        imagemExpandida.src = imagensAtuais[currentSlide];
        if (contadorImagens) {
            contadorImagens.textContent = `${currentSlide + 1} / ${imagensAtuais.length}`;
        }
        
        modalImagemExpandida.classList.add('active');

        // Touch events para swipe no modal expandido
        imagemExpandida.addEventListener('touchstart', handleTouchStart, { passive: true });
        imagemExpandida.addEventListener('touchmove', handleTouchMove, { passive: true });
        imagemExpandida.addEventListener('touchend', () => {
            handleTouchEnd();
            atualizarImagemExpandida();
        });
    }

    function atualizarImagemExpandida() {
        if (!imagemExpandida || !contadorImagens) return;
        imagemExpandida.src = imagensAtuais[currentSlide];
        contadorImagens.textContent = `${currentSlide + 1} / ${imagensAtuais.length}`;
    }

    function fecharImagemExpandida() {
        modalImagemExpandida?.classList.remove('active');
    }

    btnCloseExpandido?.addEventListener('click', fecharImagemExpandida);
    modalImagemExpandida?.addEventListener('click', (e) => {
        if (e.target === modalImagemExpandida) {
            fecharImagemExpandida();
        }
    });

    btnPrevExpandido?.addEventListener('click', () => {
        prevSlide();
        atualizarImagemExpandida();
    });

    btnNextExpandido?.addEventListener('click', () => {
        nextSlide();
        atualizarImagemExpandida();
    });

    const btnWhatsapp = modal?.querySelector('.btn-whatsapp');
    btnWhatsapp?.addEventListener('click', (e) => {
        e.preventDefault();
        if (produtoAtual) {
            const telefone = '5577981022246';
            const mensagem = `Olá! Tenho interesse no *${produtoAtual.nome}*\n${produtoAtual.descricao}\n${produtoAtual.preco}`;
            const url = `https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');
        }
    });

    document.addEventListener('keydown', (e: KeyboardEvent) => {
        if (modal?.classList.contains('active')) {
            if (e.key === 'Escape') {
                fecharModal();
            } else if (e.key === 'ArrowLeft') {
                prevSlide();
            } else if (e.key === 'ArrowRight') {
                nextSlide();
            }
        }
        
        if (modalImagemExpandida?.classList.contains('active')) {
            if (e.key === 'Escape') {
                fecharImagemExpandida();
            } else if (e.key === 'ArrowLeft') {
                prevSlide();
                atualizarImagemExpandida();
            } else if (e.key === 'ArrowRight') {
                nextSlide();
                atualizarImagemExpandida();
            }
        }
    });
</script>