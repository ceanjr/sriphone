---
import { authService } from '../../lib/supabase';
import '../../styles/admin-header.css';
---

<header class="dashboard-header mobile-only">
  <div class="dashboard-header-left">
    <h1 class="dashboard-title">Dashboard</h1>
    <p class="dashboard-subtitle">Bem-vindo(a) ao painel administrativo</p>
  </div>

  <button
    type="button"
    id="logout-btn"
    class="logout-btn"
    aria-label="Sair da conta"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
      ></path>
    </svg>
    Sair
  </button>

  <script>
    import { authService } from '../../lib/supabase';

    console.log('[DashboardHeader] Script iniciado');

    const logoutBtn = document.getElementById('logout-btn');

    if (!logoutBtn) {
      console.error('[DashboardHeader Logout] Botão de logout não encontrado!');
    } else {
      console.log('[DashboardHeader Logout] Botão de logout encontrado, adicionando listener');

      logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('[DashboardHeader Logout] Botão clicado');

        if (confirm('Tem certeza que deseja sair?')) {
          console.log('[DashboardHeader Logout] Usuário confirmou logout');

          try {
            // Desabilitar botão para evitar cliques múltiplos
            logoutBtn.setAttribute('disabled', 'true');
            logoutBtn.textContent = 'Saindo...';

            // 1. Limpar sessão do Supabase no cliente
            console.log('[DashboardHeader Logout] Passo 1/3: Limpando sessão do Supabase...');
            await authService.signOut();
            console.log('[DashboardHeader Logout] ✅ Passo 1/3: Sessão do Supabase limpa');

            // 2. Limpar cookies no servidor
            console.log('[DashboardHeader Logout] Passo 2/3: Chamando API de logout...');
            const response = await fetch('/api/admin/auth/logout', {
              method: 'POST',
              credentials: 'include',
            });

            if (response.ok) {
              console.log('[DashboardHeader Logout] ✅ Passo 2/3: Cookies limpos no servidor');
            } else {
              console.warn('[DashboardHeader Logout] ⚠️ Falha ao limpar cookies, mas continuando...');
            }

            // 3. Redirecionar para login
            console.log('[DashboardHeader Logout] Passo 3/3: Redirecionando para /admin/login...');

            // Usar window.location.href ao invés de replace para forçar reload completo
            window.location.href = '/admin/login';

            // Fallback após 1 segundo
            setTimeout(() => {
              console.log('[DashboardHeader Logout] Fallback: Forçando redirecionamento...');
              window.location.replace('/admin/login');
            }, 1000);

          } catch (error) {
            console.error('[DashboardHeader Logout] ❌ Erro ao fazer logout:', error);
            console.error('[DashboardHeader Logout] Stack trace:', error);

            // Limpar localStorage manualmente em caso de erro
            try {
              localStorage.clear();
            } catch (e) {
              console.error('[DashboardHeader Logout] Erro ao limpar localStorage:', e);
            }

            // Mesmo com erro, redirecionar
            window.location.href = '/admin/login';
          }
        } else {
          console.log('[DashboardHeader Logout] Usuário cancelou logout');
        }
      });
    }
  </script>
</header>
