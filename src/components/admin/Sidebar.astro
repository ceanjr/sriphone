---
const menuItems = [
  {
    title: 'Dashboard',
    icon: 'layout-dashboard',
    href: '/admin/dashboard',
  },
  {
    title: 'Produtos',
    icon: 'package',
    href: '/admin/produtos',
  },
  {
    title: 'Categorias',
    icon: 'folder-tree',
    href: '/admin/categorias',
  },
];

const currentPath = Astro.url.pathname;
---

<div class="sidebar-container">
  <!-- Logo -->
  <a href="/admin/dashboard" class="sidebar-logo">
    <div class="sidebar-logo-image">
      <img
        src="/images/logo-fundo.webp"
        alt="Sr. IPHONE Logo"
        width="40"
        height="40"
      />
    </div>
    <div class="sidebar-logo-text">
      <h1>Sr. IPHONE VCA</h1>
      <p>Admin</p>
    </div>
  </a>

  <!-- Menu -->
  <nav class="sidebar-nav">
    <ul class="sidebar-menu">
      {
        menuItems.map((item) => {
          const isActive =
            currentPath === item.href ||
            currentPath.startsWith(item.href + '/');
          return (
            <li>
              <a
                href={item.href}
                class={`sidebar-menu-item ${isActive ? 'active' : ''}`}
              >
                <span aria-hidden="true">
                  {item.icon === 'layout-dashboard' && (
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                      />
                    </svg>
                  )}
                  {item.icon === 'package' && (
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                      />
                    </svg>
                  )}
                  {item.icon === 'folder-tree' && (
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                      />
                    </svg>
                  )}
                </span>
                {item.title}
              </a>
            </li>
          );
        })
      }
    </ul>

    <div class="sidebar-divider"></div>

    <!-- Link para o Catálogo -->
    <ul class="sidebar-menu">
      <li>
        <a
          href="/catalogo"
          class="sidebar-menu-item"
        >
          <span aria-hidden="true">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
              ></path>
            </svg>
          </span>
          Ver Catálogo
        </a>
      </li>
    </ul>
  </nav>

  <!-- Botão de Logout -->
  <div class="sidebar-footer">
    <button id="sidebar-logout-btn" class="sidebar-logout-btn">
      <span aria-hidden="true">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
          ></path>
        </svg>
      </span>
      Sair
    </button>
  </div>
</div>

<script is:inline>
  (function() {
    console.log('[Sidebar] Script iniciado');
    console.log('[Sidebar] URL atual:', window.location.href);

    // Aguardar DOM estar pronto
    function initSidebar() {
      const sidebarLogoutBtn = document.getElementById('sidebar-logout-btn');

      if (!sidebarLogoutBtn) {
        console.error('[Sidebar Logout] Botão de logout não encontrado!');
        return;
      }

      console.log('[Sidebar Logout] Botão de logout encontrado, adicionando listener');

      sidebarLogoutBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('[Sidebar Logout] Botão clicado');

        if (confirm('Tem certeza que deseja sair?')) {
          console.log('[Sidebar Logout] Usuário confirmou logout');

          try {
            // Desabilitar botão para evitar cliques múltiplos
            sidebarLogoutBtn.setAttribute('disabled', 'true');
            sidebarLogoutBtn.textContent = 'Saindo...';

            // 1. Limpar localStorage manualmente
            console.log('[Sidebar Logout] Passo 1/3: Limpando localStorage...');
            try {
              // Limpar TODOS os tokens do Supabase
              const keysToRemove = [];
              for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('sb-')) {
                  keysToRemove.push(key);
                }
              }
              keysToRemove.forEach(key => {
                console.log('[Sidebar Logout] Removendo:', key);
                localStorage.removeItem(key);
              });
              console.log('[Sidebar Logout] ✅ Passo 1/3: localStorage limpo');
            } catch (err) {
              console.error('[Sidebar Logout] Erro ao limpar localStorage:', err);
            }

            // 2. Limpar cookies no servidor
            console.log('[Sidebar Logout] Passo 2/3: Chamando API de logout...');
            const response = await fetch('/api/admin/auth/logout', {
              method: 'POST',
              credentials: 'include',
            });

            if (response.ok) {
              console.log('[Sidebar Logout] ✅ Passo 2/3: Cookies limpos no servidor');
            } else {
              console.warn('[Sidebar Logout] ⚠️ Falha ao limpar cookies, mas continuando...');
            }

            // 3. Redirecionar para login
            console.log('[Sidebar Logout] Passo 3/3: Redirecionando para /admin/login...');

            // Usar window.location.href ao invés de replace para forçar reload completo
            window.location.href = '/admin/login';

            // Fallback após 1 segundo
            setTimeout(function() {
              console.log('[Sidebar Logout] Fallback: Forçando redirecionamento...');
              window.location.replace('/admin/login');
            }, 1000);

          } catch (error) {
            console.error('[Sidebar Logout] ❌ Erro ao fazer logout:', error);
            console.error('[Sidebar Logout] Stack trace:', error.stack);

            // Limpar localStorage manualmente em caso de erro
            try {
              localStorage.clear();
            } catch (e) {
              console.error('[Sidebar Logout] Erro ao limpar localStorage:', e);
            }

            // Mesmo com erro, redirecionar
            window.location.href = '/admin/login';
          }
        } else {
          console.log('[Sidebar Logout] Usuário cancelou logout');
        }
      });

      // Debug: Log de todos os links do sidebar
      const sidebarLinks = document.querySelectorAll('.sidebar-menu-item');
      console.log('[Sidebar] Total de links encontrados:', sidebarLinks.length);

      sidebarLinks.forEach(function(link, index) {
        console.log('[Sidebar] Link ' + (index + 1) + ':', link.getAttribute('href'));

        // Adicionar listener para debug
        link.addEventListener('click', function(e) {
          console.log('[Sidebar] Link clicado:', link.getAttribute('href'));
          console.log('[Sidebar] Target:', e.target);
          console.log('[Sidebar] CurrentTarget:', e.currentTarget);
        });
      });
    }

    // Executar quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSidebar);
    } else {
      initSidebar();
    }
  })();
</script>
