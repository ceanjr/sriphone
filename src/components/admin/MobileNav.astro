---
import '../../styles/components/mobile-nav.css';

const menuItems = [
  { title: 'Dashboard', icon: 'layout-dashboard', href: '/admin/dashboard' },
  { title: 'Produtos', icon: 'package', href: '/admin/produtos' },
  { title: 'Categorias', icon: 'folder-tree', href: '/admin/categorias' },
  { title: 'Catálogo', icon: 'external-link', href: '/catalogo' },
];

const currentPath = Astro.url.pathname;
---
<nav class="mobile-bottom-nav">
  {menuItems.map((item) => {
    const isActive =
      currentPath === item.href || currentPath.startsWith(item.href + '/');
    return (
      <a
        href={item.href}
        class={`mobile-nav-item ${isActive ? 'active' : ''}`}
        target={item.title === 'Catálogo' ? '_self' : '_self'}
        rel="noopener noreferrer"
      >
        <span class="mobile-nav-icon">
          <!-- Ícones simples (você pode substituir por lucide-react depois) -->
          {item.icon === 'layout-dashboard' && (
            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
              <rect x="3" y="3" width="7" height="7" stroke-width="2" />
              <rect x="14" y="3" width="7" height="7" stroke-width="2" />
              <rect x="14" y="14" width="7" height="7" stroke-width="2" />
              <rect x="3" y="14" width="7" height="7" stroke-width="2" />
            </svg>
          )}
          {item.icon === 'package' && (
            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
              <path
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4a2 2 0 0 0 1-1.73z"
              />
            </svg>
          )}
          {item.icon === 'folder-tree' && (
            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
              <path
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 3v6h6V3H6zm0 12v6h6v-6H6zm6-6h6v6h-6z"
              />
            </svg>
          )}
          {item.icon === 'external-link' && (
            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none">
              <path
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10 13l9-9m0 0h-5m5 0v5M21 21H3V3"
              />
            </svg>
          )}
        </span>
        <span class="mobile-nav-label">{item.title}</span>
      </a>
    );
  })}
</nav>

<script is:inline>
  (function() {
    console.log('[MobileNav] Script iniciado');

    function initMobileNav() {
      const menuBtn = document.getElementById('mobile-menu-btn');
      const mobileMenu = document.getElementById('mobile-menu');
      const backdrop = document.getElementById('mobile-backdrop');
      const menuIcon = document.getElementById('menu-icon');
      const closeIcon = document.getElementById('close-icon');
      const logoutBtn = document.getElementById('mobile-logout-btn');

      console.log('[MobileNav] Elementos carregados', {
        menuBtn: menuBtn ? 'OK' : 'FALTANDO',
        mobileMenu: mobileMenu ? 'OK' : 'FALTANDO',
        backdrop: backdrop ? 'OK' : 'FALTANDO',
        logoutBtn: logoutBtn ? 'OK' : 'FALTANDO'
      });

      function toggleMenu() {
        if (!mobileMenu || !backdrop) {
          console.error('[MobileNav] Elementos não encontrados');
          return;
        }

        const isOpen = !mobileMenu.classList.contains('hidden');

        console.log('[MobileNav] Toggle menu', { isOpen: isOpen });

        if (isOpen) {
          mobileMenu.classList.add('hidden');
          backdrop.classList.add('hidden');
          if (menuIcon) menuIcon.classList.remove('hidden');
          if (closeIcon) closeIcon.classList.add('hidden');
          document.body.style.overflow = '';
        } else {
          mobileMenu.classList.remove('hidden');
          backdrop.classList.remove('hidden');
          if (menuIcon) menuIcon.classList.add('hidden');
          if (closeIcon) closeIcon.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      }

      if (menuBtn) {
        menuBtn.addEventListener('click', function(e) {
          console.log('[MobileNav] Botão menu clicado');
          e.preventDefault();
          e.stopPropagation();
          toggleMenu();
        });
      }

      if (backdrop) {
        backdrop.addEventListener('click', function() {
          console.log('[MobileNav] Backdrop clicado');
          toggleMenu();
        });
      }

      if (logoutBtn) {
        console.log('[MobileNav Logout] Botão de logout encontrado, adicionando listener');

        logoutBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('[MobileNav Logout] Botão clicado');

          if (confirm('Tem certeza que deseja sair?')) {
            console.log('[MobileNav Logout] Usuário confirmou logout');

            try {
              // Desabilitar botão para evitar cliques múltiplos
              logoutBtn.setAttribute('disabled', 'true');
              logoutBtn.textContent = 'Saindo...';

              // 1. Limpar localStorage manualmente
              console.log('[MobileNav Logout] Passo 1/3: Limpando localStorage...');
              try {
                // Limpar TODOS os tokens do Supabase
                var keysToRemove = [];
                for (var i = 0; i < localStorage.length; i++) {
                  var key = localStorage.key(i);
                  if (key && key.startsWith('sb-')) {
                    keysToRemove.push(key);
                  }
                }
                keysToRemove.forEach(function(key) {
                  console.log('[MobileNav Logout] Removendo:', key);
                  localStorage.removeItem(key);
                });
                console.log('[MobileNav Logout] ✅ Passo 1/3: localStorage limpo');
              } catch (err) {
                console.error('[MobileNav Logout] Erro ao limpar localStorage:', err);
              }

              // 2. Limpar cookies no servidor
              console.log('[MobileNav Logout] Passo 2/3: Chamando API de logout...');
              var response = await fetch('/api/admin/auth/logout', {
                method: 'POST',
                credentials: 'include',
              });

              if (response.ok) {
                console.log('[MobileNav Logout] ✅ Passo 2/3: Cookies limpos no servidor');
              } else {
                console.warn('[MobileNav Logout] ⚠️ Falha ao limpar cookies, mas continuando...');
              }

              // 3. Redirecionar para login
              console.log('[MobileNav Logout] Passo 3/3: Redirecionando para /admin/login...');

              // Usar window.location.href para forçar reload completo
              window.location.href = '/admin/login';

              // Fallback após 1 segundo
              setTimeout(function() {
                console.log('[MobileNav Logout] Fallback: Forçando redirecionamento...');
                window.location.replace('/admin/login');
              }, 1000);

            } catch (error) {
              console.error('[MobileNav Logout] ❌ Erro ao fazer logout:', error);
              console.error('[MobileNav Logout] Stack trace:', error.stack);

              // Limpar localStorage manualmente em caso de erro
              try {
                localStorage.clear();
              } catch (e) {
                console.error('[MobileNav Logout] Erro ao limpar localStorage:', e);
              }

              // Mesmo com erro, redirecionar
              window.location.href = '/admin/login';
            }
          } else {
            console.log('[MobileNav Logout] Usuário cancelou logout');
          }
        });
      } else {
        console.error('[MobileNav Logout] Botão de logout não encontrado!');
      }
    }

    // Executar quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMobileNav);
    } else {
      initMobileNav();
    }
  })();
</script>
