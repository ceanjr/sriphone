---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../../lib/supabaseAdmin';
import '../../../../styles/admin-form.css';

export const prerender = false;

// Headers anti-cache para Vercel
Astro.response.headers.set('Cache-Control', 'private, no-store, no-cache, must-revalidate, max-age=0');
Astro.response.headers.set('CDN-Cache-Control', 'no-store');
Astro.response.headers.set('Vercel-CDN-Cache-Control', 'no-store');

const { id } = Astro.params;

const { data: produto, error } = await supabaseAdmin
  .from('produtos')
  .select('*')
  .eq('id', id)
  .single();

if (error || !produto) {
  return Astro.redirect('/admin/produtos');
}

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout title="Editar Produto" description="Editar produto do catálogo">
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar para Produtos
        </a>
        <h1 class="form-title">Editar Produto</h1>
        <p class="form-subtitle">Atualize as informações do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <input type="hidden" id="produto_id" name="produto_id" value={produto.id} />
          <input type="hidden" id="existing-images-json" value={JSON.stringify(produto.imagens || [])} />

          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (até 5)</label>
            <input
              id="foto-upload"
              type="file"
              accept="image/*"
              multiple
              style="display: none;"
            />
            <div class="form-image-upload" id="upload-area"></div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome do Produto
              <span class="form-label-required">*</span>
            </label>
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              placeholder="Ex: iPhone 13 Pro Max 256GB"
              value={produto.nome}
              required
            />
          </div>

          <!-- Código e Preço -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">Código</label>
              <input
                id="codigo"
                name="codigo"
                type="text"
                class="form-input"
                placeholder="Ex: IP13PM256"
                value={produto.codigo || ''}
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Preço
                <span class="form-label-required">*</span>
              </label>
              <!-- type="text" com inputmode para Safari -->
              <input
                id="preco"
                name="preco"
                type="text"
                inputmode="decimal"
                pattern="[0-9]*[.,]?[0-9]*"
                class="form-input"
                placeholder="0.00"
                value={produto.preco}
                required
              />
            </div>
          </div>

          <!-- Categoria e Condição -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria
                <span class="form-label-required">*</span>
              </label>
              <select id="categoria_id" name="categoria_id" class="form-select" required>
                <option value="">Selecione uma categoria</option>
                {
                  categorias?.map((categoria) => (
                    <option value={categoria.id} selected={categoria.id === produto.categoria_id}>
                      {categoria.nome}
                    </option>
                  ))
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condição</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo" selected={produto.condicao === 'Novo'}>Novo</option>
                <option value="Seminovo" selected={produto.condicao === 'Seminovo'}>Seminovo</option>
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (%)</label>
            <!-- type="text" com inputmode para Safari -->
            <input
              id="bateria"
              name="bateria"
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              class="form-input"
              placeholder="Ex: 85"
              value={produto.bateria || ''}
            />
          </div>

          <!-- Descrição -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descrição</label>
            <textarea
              id="descricao"
              name="descricao"
              class="form-textarea"
              placeholder="Descreva o produto, suas características e estado..."
            >{produto.descricao || ''}</textarea>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel">Cancelar</a>
            <button type="submit" id="submit-btn" class="form-btn form-btn-submit">
              <span id="submit-text">Salvar Alterações</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // ============================================================================
  // VERSÃO HÍBRIDA - fetch (funciona desktop) + type=text (funciona Safari)
  // ============================================================================

  console.log('[EDITAR PRODUTO] Script iniciado');

  const form = document.getElementById('product-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text') as HTMLSpanElement;
  const produtoIdInput = document.getElementById('produto_id') as HTMLInputElement;
  const fileInput = document.getElementById('foto-upload') as HTMLInputElement;
  const uploadArea = document.getElementById('upload-area');
  const existingImagesInput = document.getElementById('existing-images-json') as HTMLInputElement;

  const MAX_IMAGES = 5;
  const MAX_FILE_SIZE = 10 * 1024 * 1024;

  let existingImageUrls: string[] = [];
  let newImageFiles: File[] = [];
  let formDirty = false;
  let isSubmitting = false;

  const blobUrls: string[] = [];

  function cleanupBlobUrls() {
    blobUrls.forEach(url => URL.revokeObjectURL(url));
    blobUrls.length = 0;
  }

  // Carregar imagens existentes
  try {
    existingImageUrls = JSON.parse(existingImagesInput.value || '[]');
    console.log('[EDITAR] Imagens existentes:', existingImageUrls.length);
  } catch (e) {
    console.error('Erro ao parsear imagens:', e);
  }

  // ============================================================================
  // RENDERIZAÇÃO DE PREVIEW
  // ============================================================================

  function renderPreviews() {
    if (!uploadArea) return;
    cleanupBlobUrls();

    const totalImages = existingImageUrls.length + newImageFiles.length;

    if (totalImages === 0) {
      uploadArea.innerHTML = `
        <div class="upload-placeholder">
          <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
            </path>
          </svg>
          <p>Clique para adicionar imagens</p>
          <small>JPG, PNG até 10MB cada (máximo 5 imagens)</small>
        </div>
      `;
      return;
    }

    // Imagens existentes
    const existingImagesHtml = existingImageUrls.map((url, index) => {
      const isPrincipal = index === 0 && newImageFiles.length === 0;
      return `
        <div class="preview-item ${isPrincipal ? 'main' : ''}"
          ${!isPrincipal ? `onclick="event.stopPropagation(); window.setMainExistingImage(${index})"` : ''}
          title="${isPrincipal ? 'Imagem principal' : 'Clique para tornar principal'}"
        >
          <img src="${url}" alt="Imagem ${index + 1}" />
          <button type="button" class="remove-btn"
            onclick="event.stopPropagation(); event.preventDefault(); window.removeExistingImage(${index})"
            title="Remover imagem">×</button>
          ${isPrincipal ? '<span class="main-badge">Principal</span>' : ''}
        </div>
      `;
    }).join('');

    // Novas imagens
    const newImagesHtml = newImageFiles.map((file, index) => {
      const url = URL.createObjectURL(file);
      blobUrls.push(url);
      const globalIndex = existingImageUrls.length + index;
      const isPrincipal = globalIndex === 0;
      return `
        <div class="preview-item ${isPrincipal ? 'main' : ''}"
          ${!isPrincipal ? `onclick="event.stopPropagation(); window.setMainNewImage(${index})"` : ''}
          title="${isPrincipal ? 'Imagem principal' : 'Clique para tornar principal'}"
        >
          <img src="${url}" alt="${file.name}" />
          <button type="button" class="remove-btn"
            onclick="event.stopPropagation(); event.preventDefault(); window.removeNewImage(${index})"
            title="Remover imagem">×</button>
          ${isPrincipal ? '<span class="main-badge">Principal</span>' : ''}
          <span class="new-badge">Nova</span>
        </div>
      `;
    }).join('');

    const addButtonHtml = totalImages < MAX_IMAGES ? `
      <div class="add-more-btn">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span>Adicionar</span>
      </div>
    ` : '';

    uploadArea.innerHTML = `
      <div class="images-preview-grid">
        ${existingImagesHtml}
        ${newImagesHtml}
        ${addButtonHtml}
      </div>
    `;
  }

  // ============================================================================
  // HANDLERS
  // ============================================================================

  (window as any).removeExistingImage = (index: number) => {
    existingImageUrls.splice(index, 1);
    renderPreviews();
    window.showToast('Imagem removida', 'success');
  };

  (window as any).removeNewImage = (index: number) => {
    newImageFiles.splice(index, 1);
    renderPreviews();
    window.showToast('Imagem removida', 'success');
  };

  (window as any).setMainExistingImage = (index: number) => {
    if (index === 0 && newImageFiles.length === 0) return;
    const [selectedImage] = existingImageUrls.splice(index, 1);
    existingImageUrls.unshift(selectedImage);
    renderPreviews();
    window.showToast('Imagem principal alterada', 'success');
  };

  (window as any).setMainNewImage = (index: number) => {
    const [selectedImage] = newImageFiles.splice(index, 1);
    newImageFiles.unshift(selectedImage);
    renderPreviews();
    window.showToast('Imagem principal alterada', 'success');
  };

  // Click na área de upload
  uploadArea?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.closest('button') || target.closest('.preview-item')) return;

    const totalImages = existingImageUrls.length + newImageFiles.length;
    if (totalImages < MAX_IMAGES) {
      fileInput?.click();
    } else {
      window.showToast(`Máximo de ${MAX_IMAGES} imagens`, 'warning');
    }
  });

  // Seleção de arquivos
  fileInput?.addEventListener('change', (e) => {
    const input = e.target as HTMLInputElement;
    const files = input.files;
    if (!files || files.length === 0) return;

    const totalImages = existingImageUrls.length + newImageFiles.length;
    const remainingSlots = MAX_IMAGES - totalImages;
    const filesToAdd = Array.from(files).slice(0, remainingSlots);
    let added = 0;

    for (const file of filesToAdd) {
      if (file.size > MAX_FILE_SIZE) {
        window.showToast(`${file.name} é muito grande (máx 10MB)`, 'error');
        continue;
      }

      if (!file.type.startsWith('image/')) {
        window.showToast(`${file.name} não é uma imagem`, 'error');
        continue;
      }

      newImageFiles.push(file);
      added++;
    }

    input.value = '';
    renderPreviews();

    if (added > 0) {
      window.showToast(`${added} imagem(ns) adicionada(s)`, 'success');
    }
  });

  // ============================================================================
  // FUNÇÃO DE UPLOAD - USANDO FETCH (funcionava no desktop)
  // ============================================================================

  async function uploadAllImages(files: File[]): Promise<string[]> {
    const batchId = Date.now() + '_' + Math.random().toString(36).substring(2, 9);
    console.log('[UPLOAD] Batch:', batchId, 'Arquivos:', files.length);

    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
      formData.append('file' + i, files[i], 'image_' + i + '.jpg');
    }

    const response = await fetch('/api/admin/upload?batch=' + batchId, {
      method: 'POST',
      body: formData,
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Erro no upload');
    }

    const result = await response.json();
    console.log('[UPLOAD] Sucesso:', result.count, 'imagens');

    return result.urls;
  }

  // ============================================================================
  // SUBMIT DO FORMULÁRIO
  // ============================================================================

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (isSubmitting) return;
    isSubmitting = true;
    submitBtn.disabled = true;
    submitText.innerHTML = '<div class="form-spinner"></div> Salvando...';

    try {
      // Upload das novas imagens
      let newImageUrls: string[] = [];
      if (newImageFiles.length > 0) {
        submitText.innerHTML = '<div class="form-spinner"></div> Enviando imagens...';
        newImageUrls = await uploadAllImages(newImageFiles);
      }

      // Combinar imagens
      const allImageUrls = [...existingImageUrls, ...newImageUrls];

      // Pegar valores do form - parseando manualmente para Safari
      const nome = (form.nome as HTMLInputElement).value.trim();
      const codigo = (form.codigo as HTMLInputElement).value.trim() || null;
      const precoStr = (form.preco as HTMLInputElement).value.replace(',', '.').trim();
      const preco = parseFloat(precoStr);
      const bateriaStr = (form.bateria as HTMLInputElement).value.trim();
      const bateria = bateriaStr ? parseInt(bateriaStr, 10) : null;
      const condicao = (form.condicao as HTMLSelectElement).value;
      const categoria_id = (form.categoria_id as HTMLSelectElement).value;
      const descricao = (form.descricao as HTMLTextAreaElement).value.trim() || null;

      if (isNaN(preco) || preco <= 0) {
        throw new Error('Preço inválido');
      }

      const produto = {
        nome,
        codigo,
        preco,
        bateria,
        condicao,
        categoria_id,
        descricao,
        imagens: allImageUrls,
      };

      console.log('[SUBMIT] Produto:', produto);

      const produtoId = produtoIdInput.value;
      const response = await fetch(`/api/admin/produtos/${produtoId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(produto),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro ao atualizar produto');
      }

      window.showToast('Produto atualizado com sucesso!', 'success');

      setTimeout(() => {
        window.location.href = `/admin/produtos?_t=${Date.now()}`;
      }, 1000);

    } catch (error: any) {
      console.error('[SUBMIT] Erro:', error);
      window.showToast(error.message || 'Erro ao salvar produto', 'error');
      isSubmitting = false;
      submitBtn.disabled = false;
      submitText.textContent = 'Salvar Alterações';
    }
  });

  // ============================================================================
  // PROTEÇÃO CONTRA RELOAD
  // ============================================================================

  form?.addEventListener('input', () => { formDirty = true; });

  window.addEventListener('beforeunload', (e) => {
    const hasChanges = formDirty || newImageFiles.length > 0;
    if (hasChanges && !isSubmitting) {
      e.preventDefault();
      e.returnValue = 'Você tem alterações não salvas. Deseja realmente sair?';
      return e.returnValue;
    }
  });

  window.addEventListener('pagehide', cleanupBlobUrls);

  renderPreviews();
</script>

<style>
  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
  }

  .upload-placeholder svg {
    color: #9ca3af;
    margin-bottom: 16px;
  }

  .upload-placeholder p {
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 4px;
  }

  .upload-placeholder small {
    font-size: 12px;
    color: #9ca3af;
  }

  .preview-item {
    position: relative;
    aspect-ratio: 1 / 1;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #e5e7eb;
    background: #1a1a1a;
    cursor: pointer;
    transition: all 0.2s;
  }

  .preview-item.main {
    border-color: #3b82f6;
    cursor: default;
  }

  .preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .preview-item .remove-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    z-index: 10;
  }

  .preview-item .main-badge {
    position: absolute;
    bottom: 6px;
    left: 6px;
    background: rgba(59, 130, 246, 0.95);
    color: white;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 600;
    z-index: 5;
  }

  .preview-item .new-badge {
    position: absolute;
    top: 6px;
    left: 6px;
    background: rgba(34, 197, 94, 0.95);
    color: white;
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    z-index: 5;
  }

  .add-more-btn {
    aspect-ratio: 1 / 1;
    border-radius: 8px;
    border: 2px dashed #d1d5db;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: #0A0A0A;
    transition: all 0.2s;
  }

  .add-more-btn:hover {
    border-color: #f9fafb;
    background: #121212;
  }

  .add-more-btn svg {
    width: 32px;
    height: 32px;
    color: #f9fafb;
    margin-bottom: 6px;
  }

  .add-more-btn span {
    font-size: 12px;
    color: #f9fafb;
    font-weight: 500;
  }
</style>

<style is:global>
  .images-preview-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 12px;
    padding: 16px;
  }

  @media (min-width: 768px) {
    .images-preview-grid {
      grid-template-columns: repeat(5, 1fr) !important;
    }
  }
</style>
