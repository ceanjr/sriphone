---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../../lib/supabaseAdmin';
import '../../../../styles/admin-form.css';

export const prerender = false;

const { id } = Astro.params;

const { data: produto, error } = await supabaseAdmin
  .from('produtos')
  .select('*')
  .eq('id', id)
  .single();

if (error || !produto) {
  return Astro.redirect('/admin/produtos');
}

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout title="Editar Produto" description="Editar produto do catálogo">
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar para Produtos
        </a>
        <h1 class="form-title">Editar Produto</h1>
        <p class="form-subtitle">Atualize as informações do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <input
            type="hidden"
            id="produto_id"
            name="produto_id"
            value={produto.id}
          />
          <input
            type="hidden"
            id="existing-images-json"
            value={JSON.stringify(produto.imagens || [])}
          />

          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (até 5)</label>
            <input
              id="foto-upload"
              type="file"
              accept="image/*"
              multiple
              style="display: none;"
            />
            <div class="form-image-upload" id="upload-area">
              <!-- Conteúdo dinâmico: placeholder ou grid de imagens -->
            </div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome do Produto
              <span class="form-label-required">*</span>
            </label>
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              placeholder="Ex: iPhone 13 Pro Max 256GB"
              value={produto.nome}
              required
            />
          </div>

          <!-- Código e Preço -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">Código</label>
              <input
                id="codigo"
                name="codigo"
                type="text"
                class="form-input"
                placeholder="Ex: IP13PM256"
                value={produto.codigo || ''}
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Preço
                <span class="form-label-required">*</span>
              </label>
              <input
                id="preco"
                name="preco"
                type="text"
                inputmode="decimal"
                pattern="[0-9]*[.,]?[0-9]*"
                class="form-input"
                placeholder="0.00"
                value={produto.preco}
                required
              />
            </div>
          </div>

          <!-- Categoria e Condição -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria
                <span class="form-label-required">*</span>
              </label>
              <select
                id="categoria_id"
                name="categoria_id"
                class="form-select"
                required
              >
                <option value="">Selecione uma categoria</option>
                {
                  categorias?.map((categoria) => (
                    <option
                      value={categoria.id}
                      selected={categoria.id === produto.categoria_id}
                    >
                      {categoria.nome}
                    </option>
                  ))
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condição</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo" selected={produto.condicao === 'Novo'}
                  >Novo</option
                >
                <option
                  value="Semi-novo"
                  selected={produto.condicao === 'Semi-novo'}>Semi-novo</option
                >
                <option value="Usado" selected={produto.condicao === 'Usado'}
                  >Usado</option
                >
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (%)</label>
            <input
              id="bateria"
              name="bateria"
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              class="form-input"
              placeholder="Ex: 80"
              value={produto.bateria || ''}
            />
          </div>

          <!-- Descrição -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descrição</label>
            <textarea
              id="descricao"
              name="descricao"
              class="form-textarea"
              placeholder="Descreva o produto, suas características e estado..."
              >{produto.descricao || ''}</textarea
            >
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel"
              >Cancelar</a
            >
            <button
              type="submit"
              id="submit-btn"
              class="form-btn form-btn-submit"
            >
              <span id="submit-text">Salvar Alterações</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // ============================================================================
  // CORREÇÃO DEFINITIVA: Cache-busting + Preview correto + DOM Ready Fix
  // ============================================================================

  // State
  let existingImageUrls: string[] = [];
  let newUploadedUrls: string[] = [];
  let isUploading = false;

  // Elements (serão inicializados após DOM ready)
  let form: HTMLFormElement | null;
  let fileInput: HTMLInputElement | null;
  let uploadArea: HTMLElement | null;
  let submitBtn: HTMLButtonElement | null;
  let submitText: HTMLSpanElement | null;
  let existingImagesInput: HTMLInputElement | null;
  let productIdInput: HTMLInputElement | null;

  // Constants
  const MAX_IMAGES = 5;
  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

  function initElements() {
    form = document.getElementById('product-form') as HTMLFormElement;
    fileInput = document.getElementById('foto-upload') as HTMLInputElement;
    uploadArea = document.getElementById('upload-area') as HTMLElement;
    submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    submitText = document.getElementById('submit-text') as HTMLSpanElement;
    existingImagesInput = document.getElementById(
      'existing-images-json'
    ) as HTMLInputElement;
    productIdInput = document.getElementById('produto_id') as HTMLInputElement;
  }

  function init() {
    console.log('[EDIT INIT] Iniciando sistema de upload...');

    initElements();

    console.log('[EDIT INIT] Elements:', {
      form: !!form,
      fileInput: !!fileInput,
      uploadArea: !!uploadArea,
      submitBtn: !!submitBtn,
    });

    if (!form) {
      console.error('[EDIT INIT] Formulário não encontrado!');
      return;
    }

    // Load initial state
    try {
      const json = existingImagesInput?.value;
      existingImageUrls = json ? JSON.parse(json) : [];
      console.log('[EDIT INIT] Imagens existentes:', existingImageUrls.length);
    } catch (e) {
      console.error('Error parsing existing images', e);
      existingImageUrls = [];
    }
    newUploadedUrls = [];

    renderPreviews();

    // Event Listeners
    console.log('[EDIT INIT] Adicionando event listeners...');

    fileInput?.addEventListener('change', handleFileSelect);
    console.log('[EDIT INIT] ✓ Listener de change adicionado');

    uploadArea?.addEventListener('click', handleAreaClick);
    console.log('[EDIT INIT] ✓ Listener de click adicionado');

    form.addEventListener('submit', handleSubmit);
    console.log('[EDIT INIT] ✓ Listener de submit adicionado');

    // Global helpers
    (window as any).removeExistingImage = removeExistingImage;
    (window as any).removeNewImage = removeNewImage;
    (window as any).setMainExistingImage = setMainExistingImage;
    (window as any).setMainNewImage = setMainNewImage;

    console.log('[EDIT INIT] ✅ Inicialização completa!');
  }

  function updateSubmitButton() {
    if (!submitBtn) return;
    submitBtn.disabled = isUploading;
    submitText.innerHTML = isUploading
      ? 'Aguarde o upload...'
      : 'Salvar Alterações';
  }

  function handleAreaClick(e: MouseEvent) {
    const target = e.target as HTMLElement;
    if (target.closest('button') || target.closest('.preview-card')) return;

    const total = existingImageUrls.length + newUploadedUrls.length;
    if (total < MAX_IMAGES) {
      fileInput?.click();
    } else {
      window.showToast(`Máximo de ${MAX_IMAGES} imagens`, 'warning');
    }
  }

  async function handleFileSelect(e: Event) {
    console.log('[EDIT FILE SELECT] Evento disparado!', e);

    const input = e.target as HTMLInputElement;
    const files = Array.from(input.files || []);

    console.log(`[EDIT FILE SELECT] ${files.length} arquivo(s) selecionado(s)`);

    // CRÍTICO: Limpar input IMEDIATAMENTE
    input.value = '';

    const currentTotal = existingImageUrls.length + newUploadedUrls.length;
    const remainingSlots = MAX_IMAGES - currentTotal;
    const filesToProcess = files.slice(0, remainingSlots);

    if (filesToProcess.length === 0) {
      window.showToast(`Limite de ${MAX_IMAGES} imagens atingido`, 'warning');
      return;
    }

    isUploading = true;
    updateSubmitButton();

    console.log(`[EDIT UPLOAD START] ${filesToProcess.length} arquivo(s)`);

    let successCount = 0;

    for (let i = 0; i < filesToProcess.length; i++) {
      const file = filesToProcess[i];
      const tempId = `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

      console.log(
        `[EDIT UPLOAD ${i + 1}/${filesToProcess.length}] Arquivo: ${file.name}, Tamanho: ${(file.size / 1024).toFixed(2)}KB`
      );

      try {
        if (file.size > MAX_FILE_SIZE) throw new Error('Arquivo muito grande');
        if (!file.type.startsWith('image/')) throw new Error('Apenas imagens');

        renderLoadingPlaceholder(tempId);

        const compressed = await compressImage(file);
        const url = await uploadImage(compressed, file.name);

        // CRÍTICO: Adicionar cache-busting
        const urlWithCacheBust = `${url}?v=${Date.now()}`;

        console.log(`[EDIT UPLOAD SUCCESS] URL: ${urlWithCacheBust}`);

        removeLoadingPlaceholder(tempId);
        newUploadedUrls.push(urlWithCacheBust);
        successCount++;
        renderPreviews();
      } catch (error: any) {
        console.error(`[EDIT UPLOAD ERROR] ${file.name}:`, error);
        window.showToast(
          `Erro ao enviar ${file.name}: ${error.message}`,
          'error'
        );
        removeLoadingPlaceholder(tempId);
      }
    }

    isUploading = false;
    updateSubmitButton();

    if (successCount > 0) {
      window.showToast(`${successCount} imagem(ns) adicionada(s)`, 'success');
    }
  }

  // --- Image Processing ---
  async function compressImage(file: File): Promise<File> {
    try {
      const imageCompression = (await import('browser-image-compression'))
        .default;
      return await imageCompression(file, {
        maxSizeMB: 1.5,
        maxWidthOrHeight: 1920,
        useWebWorker: true,
        initialQuality: 0.8,
      });
    } catch {
      return file;
    }
  }

  async function uploadImage(
    file: File,
    originalName: string
  ): Promise<string> {
    const formData = new FormData();
    const uniqueName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${originalName.replace(/[^a-zA-Z0-9._-]/g, '_')}`;
    formData.append('file', file, uniqueName);

    const uploadUrl = `/api/admin/upload?t=${Date.now()}&r=${Math.random()}`;
    console.log(`[FETCH] POST ${uploadUrl}`);

    const response = await fetch(uploadUrl, {
      method: 'POST',
      body: formData,
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        Pragma: 'no-cache',
      },
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('[UPLOAD RESPONSE ERROR]:', errorText);
      throw new Error('Falha no upload');
    }

    const data = await response.json();
    console.log('[UPLOAD RESPONSE]:', data);

    if (!data.urls || !data.urls[0]) {
      throw new Error('Nenhuma URL retornada');
    }

    return data.urls[0];
  }

  // --- Rendering ---
  function renderLoadingPlaceholder(id: string) {
    const grid = document.querySelector('.images-preview-grid');
    if (!grid) {
      uploadArea.innerHTML = '<div class="images-preview-grid"></div>';
      renderLoadingPlaceholder(id);
      return;
    }
    const placeholder = document.createElement('div');
    placeholder.id = id;
    placeholder.className = 'preview-card loading';
    placeholder.innerHTML = '<div class="form-spinner"></div>';

    const addBtn = grid.querySelector('.add-more-btn');
    if (addBtn) grid.insertBefore(placeholder, addBtn);
    else grid.appendChild(placeholder);
  }

  function removeLoadingPlaceholder(id: string) {
    document.getElementById(id)?.remove();
    const grid = document.querySelector('.images-preview-grid');
    if (grid && grid.children.length === 0) renderPreviews();
  }

  function renderPreviews() {
    if (!uploadArea) return;
    const total = existingImageUrls.length + newUploadedUrls.length;

    if (total === 0) {
      uploadArea.innerHTML = `
        <div class="upload-placeholder">
          <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p>Clique para adicionar imagens</p>
          <small>JPG, PNG até 10MB cada (máximo 5 imagens)</small>
        </div>
      `;
      return;
    }

    const existingHtml = existingImageUrls
      .map((url, index) => {
        const isMain = index === 0;
        return `
        <div class="preview-card ${isMain ? 'is-main' : ''}"
             onclick="window.setMainExistingImage(${index})"
             title="Clique para tornar principal">
          <img src="${url}" alt="Imagem ${index + 1}" loading="eager" />
          <button type="button" class="remove-btn" onclick="event.stopPropagation(); window.removeExistingImage(${index})">×</button>
          ${isMain ? '<span class="main-badge">Principal</span>' : ''}
        </div>
      `;
      })
      .join('');

    const newHtml = newUploadedUrls
      .map((url, index) => {
        const isMain = existingImageUrls.length === 0 && index === 0;
        return `
        <div class="preview-card ${isMain ? 'is-main' : ''} is-new"
             onclick="window.setMainNewImage(${index})"
             title="Clique para tornar principal">
          <img src="${url}" alt="Nova Imagem ${index + 1}" loading="eager" />
          <button type="button" class="remove-btn" onclick="event.stopPropagation(); window.removeNewImage(${index})">×</button>
          <span class="new-badge">Nova</span>
          ${isMain ? '<span class="main-badge">Principal</span>' : ''}
        </div>
      `;
      })
      .join('');

    const addButtonHtml =
      total < MAX_IMAGES
        ? `
      <div class="add-more-btn" onclick="document.getElementById('foto-upload').click()">
        <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span>Adicionar</span>
      </div>
    `
        : '';

    uploadArea.innerHTML = `
      <div class="images-preview-grid">
        ${existingHtml}
        ${newHtml}
        ${addButtonHtml}
      </div>
    `;
  }

  // --- Actions ---
  function removeExistingImage(index: number) {
    existingImageUrls.splice(index, 1);
    renderPreviews();
  }

  function removeNewImage(index: number) {
    newUploadedUrls.splice(index, 1);
    renderPreviews();
  }

  function setMainExistingImage(index: number) {
    if (index === 0 && newUploadedUrls.length === 0) return;
    const item = existingImageUrls.splice(index, 1)[0];
    existingImageUrls.unshift(item);
    renderPreviews();
    window.showToast('Imagem principal definida', 'success');
  }

  function setMainNewImage(index: number) {
    const item = newUploadedUrls.splice(index, 1)[0];
    existingImageUrls.unshift(item);
    renderPreviews();
    window.showToast('Imagem principal definida', 'success');
  }

  async function handleSubmit(e: Event) {
    e.preventDefault();
    if (isUploading) return window.showToast('Aguarde o upload', 'warning');

    const finalImages = [...existingImageUrls, ...newUploadedUrls];
    if (finalImages.length === 0)
      return window.showToast('Adicione uma imagem', 'warning');

    submitBtn.disabled = true;
    submitText.innerHTML = '<div class="form-spinner"></div> Salvando...';

    try {
      const formData = new FormData(form);

      // Remover cache-busting antes de salvar
      const cleanUrls = finalImages.map((url) => url.split('?')[0]);

      const produto = {
        nome: formData.get('nome'),
        codigo: formData.get('codigo'),
        preco:
          parseFloat((formData.get('preco') as string).replace(',', '.')) || 0,
        bateria: formData.get('bateria')
          ? parseInt(formData.get('bateria') as string)
          : null,
        condicao: formData.get('condicao'),
        categoria_id: formData.get('categoria_id'),
        descricao: formData.get('descricao') || null,
        imagens: cleanUrls,
      };

      console.log('[SUBMIT] Payload:', produto);

      const response = await fetch(
        `/api/admin/produtos/${productIdInput.value}`,
        {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache',
          },
          body: JSON.stringify(produto),
        }
      );

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'Erro ao salvar');
      }

      window.showToast('Produto atualizado!', 'success');
      setTimeout(() => (window.location.href = '/admin/produtos'), 500);
    } catch (error: any) {
      console.error('Submit error:', error);
      window.showToast(error.message, 'error');
      submitBtn.disabled = false;
      submitText.textContent = 'Salvar Alterações';
    }
  }

  // Garantir que o código só execute após o DOM estar pronto
  if (document.readyState === 'loading') {
    console.log('[EDIT DOM] Aguardando DOMContentLoaded...');
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[EDIT DOM] DOMContentLoaded disparado');
      try {
        init();
      } catch (error) {
        console.error('[EDIT INIT ERROR]:', error);
      }
    });
  } else {
    console.log('[EDIT DOM] DOM já está pronto');
    try {
      init();
    } catch (error) {
      console.error('[EDIT INIT ERROR]:', error);
    }
  }
</script>

<style>
  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    background: #0a0a0a;
    border-radius: 8px;
    border: 2px dashed #333;
    transition: all 0.2s;
  }
  .upload-placeholder:hover {
    border-color: #555;
    background: #111;
  }
  .upload-placeholder svg {
    color: #666;
    margin-bottom: 16px;
  }
  .upload-placeholder p {
    font-size: 14px;
    font-weight: 500;
    color: #888;
    margin-bottom: 4px;
  }
  .upload-placeholder small {
    font-size: 12px;
    color: #555;
  }
</style>

<style is:global>
  .images-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    padding: 12px;
    background: #111;
    border-radius: 8px;
    border: 1px solid #333;
  }

  .preview-card {
    position: relative;
    aspect-ratio: 1/1;
    border-radius: 6px;
    overflow: hidden;
    background: #000;
    border: 2px solid #333;
    cursor: pointer;
    transition: all 0.2s;
  }

  .preview-card.is-main {
    border-color: #3b82f6;
  }
  .preview-card.is-new {
    border-color: #22c55e;
  }
  .preview-card:hover {
    border-color: #555;
    transform: translateY(-2px);
  }
  .preview-card.is-main:hover {
    border-color: #2563eb;
  }

  .preview-card.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #1a1a1a;
  }

  .preview-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(239, 68, 68, 0.95);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    line-height: 1;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s;
  }

  .remove-btn:hover {
    background: #dc2626;
    transform: scale(1.1);
  }

  .main-badge {
    position: absolute;
    bottom: 4px;
    left: 4px;
    background: rgba(59, 130, 246, 0.95);
    color: white;
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .new-badge {
    position: absolute;
    top: 4px;
    left: 4px;
    background: rgba(34, 197, 94, 0.95);
    color: white;
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .add-more-btn {
    aspect-ratio: 1/1;
    border-radius: 6px;
    border: 2px dashed #444;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: #151515;
    color: #888;
    transition: all 0.2s;
  }
  .add-more-btn:hover {
    border-color: #666;
    background: #222;
    color: #fff;
    transform: translateY(-2px);
  }
  .add-more-btn svg {
    margin-bottom: 4px;
  }
  .add-more-btn span {
    font-size: 11px;
    font-weight: 500;
  }
</style>
