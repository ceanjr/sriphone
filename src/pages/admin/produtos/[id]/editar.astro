---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../../lib/supabaseAdmin';
import '../../../../styles/admin-form.css';

export const prerender = false; // For√ßa SSR sem cache para admin

const { id } = Astro.params;

const { data: produto, error } = await supabaseAdmin
  .from('produtos')
  .select('*')
  .eq('id', id)
  .single();

if (error || !produto) {
  return Astro.redirect('/admin/produtos');
}

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout title="Editar Produto" description="Editar produto do cat√°logo">
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar para Produtos
        </a>
        <h1 class="form-title">Editar Produto</h1>
        <p class="form-subtitle">Atualize as informa√ß√µes do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <input
            type="hidden"
            id="produto_id"
            name="produto_id"
            value={produto.id}
          />
          <input
            type="hidden"
            id="existing-images-json"
            value={JSON.stringify(produto.imagens || [])}
          />

          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (at√© 5)</label>
            <input
              id="foto-upload"
              type="file"
              accept="image/*"
              multiple
              style="display: none;"
            />
            <div class="form-image-upload" id="upload-area">
              <!-- Conte√∫do din√¢mico: placeholder ou grid de imagens -->
            </div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome do Produto
              <span class="form-label-required">*</span>
            </label>
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              placeholder="Ex: iPhone 13 Pro Max 256GB"
              value={produto.nome}
              required
            />
          </div>

          <!-- C√≥digo e Pre√ßo -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">C√≥digo</label>
              <input
                id="codigo"
                name="codigo"
                type="text"
                class="form-input"
                placeholder="Ex: IP13PM256"
                value={produto.codigo || ''}
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Pre√ßo
                <span class="form-label-required">*</span>
              </label>
              <input
                id="preco"
                name="preco"
                type="number"
                step="0.01"
                class="form-input"
                placeholder="0.00"
                value={produto.preco}
                required
              />
            </div>
          </div>

          <!-- Categoria e Condi√ß√£o -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria
                <span class="form-label-required">*</span>
              </label>
              <select
                id="categoria_id"
                name="categoria_id"
                class="form-select"
                required
              >
                <option value="">Selecione uma categoria</option>
                {
                  categorias?.map((categoria) => (
                    <option
                      value={categoria.id}
                      selected={categoria.id === produto.categoria_id}
                    >
                      {categoria.nome}
                    </option>
                  ))
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condi√ß√£o</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo" selected={produto.condicao === 'Novo'}
                  >Novo</option
                >
                <option
                  value="Semi-novo"
                  selected={produto.condicao === 'Semi-novo'}>Semi-novo</option
                >
                <option value="Usado" selected={produto.condicao === 'Usado'}
                  >Usado</option
                >
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (mAh)</label>
            <input
              id="bateria"
              name="bateria"
              type="number"
              class="form-input"
              placeholder="Ex: 4352"
              value={produto.bateria || ''}
            />
          </div>

          <!-- Descri√ß√£o -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descri√ß√£o</label>
            <textarea
              id="descricao"
              name="descricao"
              class="form-textarea"
              placeholder="Descreva o produto, suas caracter√≠sticas e estado..."
              >{produto.descricao || ''}</textarea
            >
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel"
              >Cancelar</a
            >
            <button
              type="submit"
              id="submit-btn"
              class="form-btn form-btn-submit"
            >
              <span id="submit-text">Salvar Altera√ß√µes</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  const form = document.getElementById('product-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text') as HTMLSpanElement;
  const produtoIdInput = document.getElementById(
    'produto_id'
  ) as HTMLInputElement;
  const fileInput = document.getElementById('foto-upload') as HTMLInputElement;
  const uploadArea = document.getElementById('upload-area');
  const existingImagesInput = document.getElementById(
    'existing-images-json'
  ) as HTMLInputElement;

  const MAX_IMAGES = 5;

  // Estado das imagens:
  // - existingImageUrls: URLs das imagens j√° salvas no produto (strings)
  // - newImageFiles: Novos arquivos selecionados mas ainda n√£o enviados (File objects)
  let existingImageUrls: string[] = [];
  let newImageFiles: File[] = [];

  // Estado do formul√°rio para prevenir reload acidental
  let formDirty = false;
  let isSubmitting = false;

  // ============================================================================
  // GEST√ÉO DE MEM√ìRIA - Blob URLs
  // ============================================================================

  // Armazenar URLs criadas para limpar depois
  const blobUrls: string[] = [];

  // Fun√ß√£o para limpar URLs antigas
  function cleanupBlobUrls() {
    blobUrls.forEach((url) => {
      URL.revokeObjectURL(url);
    });
    blobUrls.length = 0;
    console.log('üßπ [MEMORY] Blob URLs limpas');
  }

  // Carregar imagens existentes do produto
  try {
    existingImageUrls = JSON.parse(existingImagesInput.value || '[]');
    console.log('üì∏ Imagens existentes carregadas:', existingImageUrls.length);
  } catch (e) {
    console.error('‚ùå Erro ao parsear imagens existentes:', e);
  }

  // Click na √°rea de upload abre o file input
  uploadArea?.addEventListener('click', (e) => {
    // N√£o abrir file input se clicar em bot√£o de remover
    if ((e.target as HTMLElement).closest('button')) return;

    const totalImages = existingImageUrls.length + newImageFiles.length;
    if (totalImages < MAX_IMAGES) {
      fileInput?.click();
    } else {
      window.showToast(`M√°ximo de ${MAX_IMAGES} imagens permitido`, 'warning');
    }
  });

  // Renderizar preview das imagens
  function renderPreviews() {
    if (!uploadArea) return;

    // Limpar blob URLs antigas antes de criar novas
    cleanupBlobUrls();

    const totalImages = existingImageUrls.length + newImageFiles.length;

    if (totalImages === 0) {
      // Placeholder quando n√£o h√° imagens
      uploadArea.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 48px 24px;">
          <svg
            style="width: 48px; height: 48px; color: #9ca3af; margin-bottom: 16px;"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
          <p style="font-size: 14px; font-weight: 500; color: #6b7280; margin-bottom: 4px;">
            Clique para adicionar imagens
          </p>
          <small style="font-size: 12px; color: #9ca3af;">JPG, PNG at√© 10MB cada (m√°ximo 5 imagens)</small>
        </div>
      `;
      return;
    }

    // Grid de imagens: primeiro as existentes, depois as novas - Layout responsivo
    const existingImagesHtml = existingImageUrls
      .map((url, index) => {
        const isPrincipal = index === 0 && newImageFiles.length === 0;
        return `
        <div style="position: relative; aspect-ratio: 1 / 1; border-radius: 8px; overflow: hidden; border: 2px solid ${isPrincipal ? '#3b82f6' : '#e5e7eb'}; background: #f9fafb; cursor: ${isPrincipal ? 'default' : 'pointer'}; transition: all 0.2s;"
          onclick="${isPrincipal ? '' : `event.stopPropagation(); window.setMainExistingImage(${index})`}"
          onmouseover="${isPrincipal ? '' : `this.style.borderColor='#3b82f6'; this.style.transform='scale(1.02)'`}"
          onmouseout="${isPrincipal ? '' : `this.style.borderColor='#e5e7eb'; this.style.transform='scale(1)'`}"
          title="${isPrincipal ? 'Imagem principal' : 'Clique para tornar principal'}"
        >
          <img
            src="${url}"
            alt="Imagem ${index + 1}"
            style="width: 100%; height: 100%; object-fit: cover; object-position: center; display: block;"
            loading="eager"
          />
          <button
            type="button"
            onclick="event.stopPropagation(); event.preventDefault(); window.removeExistingImage(${index})"
            style="position: absolute; top: 6px; right: 6px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; min-width: 20px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: bold; line-height: 1; padding: 0; transition: all 0.2s; z-index: 10;"
            onmouseover="this.style.background='rgba(220, 38, 38, 1)'; this.style.transform='scale(1.15)'"
            onmouseout="this.style.background='rgba(239, 68, 68, 0.9)'; this.style.transform='scale(1)'"
            title="Remover imagem"
          >
            √ó
          </button>
          ${isPrincipal ? '<span style="position: absolute; bottom: 6px; left: 6px; background: rgba(59, 130, 246, 0.95); color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600; z-index: 5;">Principal</span>' : ''}
        </div>
      `;
      })
      .join('');

    const newImagesHtml = newImageFiles
      .map((file, index) => {
        const url = URL.createObjectURL(file); // Blob URL local
        blobUrls.push(url); // Rastrear para limpeza posterior
        const globalIndex = existingImageUrls.length + index;
        const isPrincipal = globalIndex === 0;
        return `
        <div style="position: relative; aspect-ratio: 1 / 1; border-radius: 8px; overflow: hidden; border: 2px solid ${isPrincipal ? '#3b82f6' : '#e5e7eb'}; background: #f9fafb; cursor: ${isPrincipal ? 'default' : 'pointer'}; transition: all 0.2s;"
          onclick="${isPrincipal ? '' : `event.stopPropagation(); window.setMainNewImage(${index})`}"
          onmouseover="${isPrincipal ? '' : `this.style.borderColor='#3b82f6'; this.style.transform='scale(1.02)'`}"
          onmouseout="${isPrincipal ? '' : `this.style.borderColor='#e5e7eb'; this.style.transform='scale(1)'`}"
          title="${isPrincipal ? 'Imagem principal' : 'Clique para tornar principal'}"
        >
          <img
            src="${url}"
            alt="${file.name}"
            style="width: 100%; height: 100%; object-fit: cover; object-position: center; display: block;"
            loading="eager"
          />
          <button
            type="button"
            onclick="event.stopPropagation(); event.preventDefault(); window.removeNewImage(${index})"
            style="position: absolute; top: 6px; right: 6px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; min-width: 20px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: bold; line-height: 1; padding: 0; transition: all 0.2s; z-index: 10;"
            onmouseover="this.style.background='rgba(220, 38, 38, 1)'; this.style.transform='scale(1.15)'"
            onmouseout="this.style.background='rgba(239, 68, 68, 0.9)'; this.style.transform='scale(1)'"
            title="Remover imagem"
          >
            √ó
          </button>
          ${isPrincipal ? '<span style="position: absolute; bottom: 6px; left: 6px; background: rgba(59, 130, 246, 0.95); color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600; z-index: 5;">Principal</span>' : ''}
          <span style="position: absolute; top: 6px; left: 6px; background: rgba(34, 197, 94, 0.95); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600; z-index: 5;">Nova</span>
        </div>
      `;
      })
      .join('');

    const addButtonHtml =
      totalImages < MAX_IMAGES
        ? `
          <div style="aspect-ratio: 1 / 1; border-radius: 8px; border: 2px dashed #d1d5db; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: #0A0A0A; transition: all 0.2s;"
            onmouseover="this.style.borderColor='#f9fafb'; this.style.background='#121212'"
            onmouseout="this.style.borderColor='#d1d5db'; this.style.background='#0A0A0A'"
          >
            <svg style="width: 32px; height: 32px; color: #f9fafb; margin-bottom: 6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <span style="font-size: 12px; color: #f9fafb; font-weight: 500;">Adicionar</span>
          </div>
      `
        : '';

    uploadArea.innerHTML = `
      <div class="images-preview-grid">
        ${existingImagesHtml}
        ${newImagesHtml}
        ${addButtonHtml}
      </div>
    `;
  }

  // Fun√ß√µes globais para remover imagens
  (window as any).removeExistingImage = (index: number) => {
    existingImageUrls.splice(index, 1);
    renderPreviews();
    window.showToast('Imagem removida', 'success');
  };

  (window as any).removeNewImage = (index: number) => {
    newImageFiles.splice(index, 1);
    renderPreviews();
    window.showToast('Imagem removida', 'success');
  };

  // Fun√ß√µes para tornar imagem principal
  (window as any).setMainExistingImage = (index: number) => {
    if (index === 0 && newImageFiles.length === 0) return; // J√° √© a principal
    console.log(`‚≠ê [PREVIEW] Tornando imagem existente ${index + 1} como principal`);
    // Mover a imagem clicada para a primeira posi√ß√£o
    const [selectedImage] = existingImageUrls.splice(index, 1);
    existingImageUrls.unshift(selectedImage);
    renderPreviews();
    window.showToast('Imagem principal alterada', 'success');
  };

  (window as any).setMainNewImage = (index: number) => {
    console.log(`‚≠ê [PREVIEW] Tornando nova imagem ${index + 1} como principal`);
    // Mover a nova imagem para o in√≠cio de existingImageUrls
    const [selectedImage] = newImageFiles.splice(index, 1);
    existingImageUrls.unshift(selectedImage.name); // Adicionar placeholder
    // Re-adicionar na primeira posi√ß√£o de newImageFiles
    newImageFiles.unshift(selectedImage);
    // Remover o placeholder
    existingImageUrls.shift();
    renderPreviews();
    window.showToast('Imagem principal alterada', 'success');
  };

  // Quando selecionar novos arquivos
  fileInput?.addEventListener('change', (e) => {
    const files = (e.target as HTMLInputElement).files;
    if (!files || files.length === 0) return;

    const totalImages = existingImageUrls.length + newImageFiles.length;
    const remainingSlots = MAX_IMAGES - totalImages;

    if (files.length > remainingSlots) {
      window.showToast(
        `Voc√™ pode adicionar apenas ${remainingSlots} imagem${remainingSlots !== 1 ? 'ns' : ''} (m√°ximo ${MAX_IMAGES})`,
        'warning'
      );
    }

    const filesToAdd = Array.from(files).slice(0, remainingSlots);

    // Validar cada arquivo
    for (const file of filesToAdd) {
      if (file.size > 10 * 1024 * 1024) {
        window.showToast(
          `Arquivo ${file.name} muito grande (m√°x 10MB)`,
          'error'
        );
        continue;
      }

      if (!file.type.startsWith('image/')) {
        window.showToast(`Arquivo ${file.name} n√£o √© uma imagem`, 'error');
        continue;
      }

      newImageFiles.push(file);
    }

    renderPreviews();

    if (filesToAdd.length > 0) {
      window.showToast(
        `${filesToAdd.length} imagem${filesToAdd.length !== 1 ? 'ns' : ''} selecionada${filesToAdd.length !== 1 ? 's' : ''}!`,
        'success'
      );
    }

    fileInput.value = '';
  });

  // Fun√ß√£o para fazer upload de um arquivo com dados isolados
  async function uploadImageToStorage(file: File, index: number, total: number): Promise<string | null> {
    const uploadId = `${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

    console.log(`üì§ [UPLOAD ${index + 1}/${total}] Iniciando: ${file.name}`);
    console.log(`   ID: ${uploadId}, Tamanho: ${file.size} bytes`);

    try {
      // CR√çTICO: Ler dados do arquivo em buffer ISOLADO
      const arrayBuffer = await file.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      const isolatedCopy = uint8Array.slice();
      const blob = new Blob([isolatedCopy], { type: file.type });

      console.log(`   Blob criado: ${blob.size} bytes`);

      const formData = new FormData();
      formData.append('file', blob, `${uploadId}_${file.name}`);

      const url = `/api/admin/upload?_t=${uploadId}&i=${index}`;

      const response = await fetch(url, {
        method: 'POST',
        body: formData,
        cache: 'no-store',
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro no upload');
      }

      const result = await response.json();
      console.log(`‚úÖ [UPLOAD ${index + 1}/${total}] Sucesso: ${result.url}`);

      return result.url;
    } catch (error: any) {
      console.error(`‚ùå [UPLOAD ${index + 1}/${total}] Erro:`, error);
      window.showToast(`Erro ao fazer upload de ${file.name}`, 'error');
      return null;
    }
  }

  // Submit do formul√°rio
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Marcar que estamos no processo de submit (desativa aviso de sa√≠da)
    isSubmitting = true;

    submitBtn.disabled = true;
    submitText.innerHTML = '<div class="form-spinner"></div> Salvando...';

    try {
      // Upload das novas imagens SEQUENCIALMENTE
      let newImageUrls: string[] = [];
      if (newImageFiles.length > 0) {
        console.log(`üì∏ [SUBMIT] ${newImageFiles.length} imagens para enviar`);

        for (let i = 0; i < newImageFiles.length; i++) {
          const file = newImageFiles[i];

          submitText.innerHTML = `<div class="form-spinner"></div> Enviando ${i + 1}/${newImageFiles.length}...`;

          const url = await uploadImageToStorage(file, i, newImageFiles.length);
          if (url) {
            newImageUrls.push(url);
          } else {
            throw new Error(`Falha no upload da imagem ${i + 1}: ${file.name}`);
          }

          // Pequeno delay entre uploads
          if (i < newImageFiles.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 300));
          }
        }

        console.log(`‚úÖ [SUBMIT] ${newImageUrls.length} imagens enviadas`);
      }

      // 2. Combinar imagens: existentes + novas
      const allImageUrls = [...existingImageUrls, ...newImageUrls];

      // 3. Preparar dados do produto
      const formData = new FormData(form);

      const produto = {
        nome: formData.get('nome'),
        codigo: formData.get('codigo'),
        preco: parseFloat(formData.get('preco') as string),
        bateria: formData.get('bateria')
          ? parseInt(formData.get('bateria') as string)
          : null,
        condicao: formData.get('condicao'),
        categoria_id: formData.get('categoria_id'),
        descricao: formData.get('descricao') || null,
        imagens: allImageUrls,
      };

      // 4. Salvar produto
      const produtoId = produtoIdInput.value;
      const response = await fetch(`/api/admin/produtos/${produtoId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(produto),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Erro ao atualizar produto');
      }

      window.showToast('Produto atualizado com sucesso!', 'success');

      // Limpar cache do service worker
      if ('caches' in window) {
        caches.keys().then((names) => {
          names.forEach((name) => caches.delete(name));
        });
      }

      // Redirecionar para lista de produtos com cache-busting
      setTimeout(() => {
        const timestamp = new Date().getTime();
        window.location.href = `/admin/produtos?_t=${timestamp}`;
      }, 1000);
    } catch (error: any) {
      console.error('‚ùå Erro ao salvar produto:', error);
      window.showToast(error.message || 'Erro ao salvar produto', 'error');
      // Resetar isSubmitting em caso de erro (permite avisar se usu√°rio tentar sair)
      isSubmitting = false;
      submitBtn.disabled = false;
      submitText.textContent = 'Salvar Altera√ß√µes';
    }
  });

  // ============================================================================
  // PROTE√á√ÉO CONTRA RELOAD ACIDENTAL
  // ============================================================================

  // Marcar formul√°rio como "sujo" quando usu√°rio faz mudan√ßas
  form?.addEventListener('input', () => {
    formDirty = true;
  });

  // Avisar antes de sair se houver mudan√ßas n√£o salvas
  window.addEventListener('beforeunload', (e) => {
    // S√≥ avisar se:
    // 1. Formul√°rio foi modificado OU tem novas imagens OU removeu imagens existentes
    // 2. N√ÉO est√° no processo de submit
    const hasChanges = formDirty || newImageFiles.length > 0;
    if (hasChanges && !isSubmitting) {
      e.preventDefault();
      e.returnValue = 'Voc√™ tem altera√ß√µes n√£o salvas. Deseja realmente sair?';
      return e.returnValue;
    }
  });

  // Prevenir navega√ß√£o acidental via service worker ou outros eventos
  let controllerChangeCount = 0;
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      controllerChangeCount++;
      console.log(`[SW] Controller mudou (${controllerChangeCount}x)`);

      // Se mudou mais de uma vez E o usu√°rio est√° preenchendo o form, avisar
      const hasChanges = formDirty || newImageFiles.length > 0;
      if (controllerChangeCount > 1 && hasChanges && !isSubmitting) {
        console.warn(
          '[SW] Service Worker atualizou mas N√ÉO vamos recarregar (formul√°rio em uso)'
        );
      }
    });
  }

  // Limpar blob URLs quando sair da p√°gina
  window.addEventListener('pagehide', cleanupBlobUrls);

  // Renderizar estado inicial
  renderPreviews();
</script>

<style is:global>
  /* For√ßar display block no container quando h√° grid */
  #upload-area:has(.images-preview-grid),
  .form-image-upload:has(.images-preview-grid) {
    display: block !important;
    min-height: auto !important;
    padding: 0 !important;
  }

  .images-preview-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 12px;
    padding: 16px;
  }

  @media (min-width: 768px) {
    .images-preview-grid {
      grid-template-columns: repeat(5, 1fr) !important;
    }
  }
</style>
