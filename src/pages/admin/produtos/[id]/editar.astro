---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../../lib/supabaseAdmin';
import '../../../../styles/admin-form.css';

export const prerender = false; // Força SSR sem cache para admin

// CRITICAL: Desabilitar TODOS os caches (Vercel, CDN, browser)
Astro.response.headers.set('Cache-Control', 'private, no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0, s-maxage=0');
Astro.response.headers.set('CDN-Cache-Control', 'no-store');
Astro.response.headers.set('Vercel-CDN-Cache-Control', 'no-store');
Astro.response.headers.set('Surrogate-Control', 'no-store');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

const { id } = Astro.params;

const { data: produto, error } = await supabaseAdmin
  .from('produtos')
  .select('*')
  .eq('id', id)
  .single();

if (error || !produto) {
  return Astro.redirect('/admin/produtos');
}

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout title="Editar Produto" description="Editar produto do catálogo">
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar para Produtos
        </a>
        <h1 class="form-title">Editar Produto</h1>
        <p class="form-subtitle">Atualize as informações do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <input
            type="hidden"
            id="produto_id"
            name="produto_id"
            value={produto.id}
          />
          <input
            type="hidden"
            id="existing-images-json"
            value={JSON.stringify(produto.imagens || [])}
          />

          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (até 5)</label>
            <input
              id="foto-upload"
              type="file"
              accept="image/*"
              multiple
              style="display: none;"
            />
            <div class="form-image-upload" id="upload-area">
              <!-- Conteúdo dinâmico: placeholder ou grid de imagens -->
            </div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome do Produto
              <span class="form-label-required">*</span>
            </label>
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              placeholder="Ex: iPhone 13 Pro Max 256GB"
              value={produto.nome}
              required
            />
          </div>

          <!-- Código e Preço -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">Código</label>
              <input
                id="codigo"
                name="codigo"
                type="text"
                class="form-input"
                placeholder="Ex: IP13PM256"
                value={produto.codigo || ''}
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Preço
                <span class="form-label-required">*</span>
              </label>
              <input
                id="preco"
                name="preco"
                type="number"
                step="0.01"
                class="form-input"
                placeholder="0.00"
                value={produto.preco}
                required
              />
            </div>
          </div>

          <!-- Categoria e Condição -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria
                <span class="form-label-required">*</span>
              </label>
              <select
                id="categoria_id"
                name="categoria_id"
                class="form-select"
                required
              >
                <option value="">Selecione uma categoria</option>
                {
                  categorias?.map((categoria) => (
                    <option
                      value={categoria.id}
                      selected={categoria.id === produto.categoria_id}
                    >
                      {categoria.nome}
                    </option>
                  ))
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condição</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo" selected={produto.condicao === 'Novo'}
                  >Novo</option
                >
                <option
                  value="Semi-novo"
                  selected={produto.condicao === 'Semi-novo'}>Semi-novo</option
                >
                <option value="Usado" selected={produto.condicao === 'Usado'}
                  >Usado</option
                >
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (mAh)</label>
            <input
              id="bateria"
              name="bateria"
              type="number"
              class="form-input"
              placeholder="Ex: 4352"
              value={produto.bateria || ''}
            />
          </div>

          <!-- Descrição -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descrição</label>
            <textarea
              id="descricao"
              name="descricao"
              class="form-textarea"
              placeholder="Descreva o produto, suas características e estado..."
              >{produto.descricao || ''}</textarea
            >
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel"
              >Cancelar</a
            >
            <button
              type="submit"
              id="submit-btn"
              class="form-btn form-btn-submit"
            >
              <span id="submit-text">Salvar Alterações</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // ============================================================================
  // EDITAR PRODUTO - COMPATÍVEL COM SAFARI/iOS
  // ============================================================================

  (function() {
    'use strict';

    console.log('[EDITAR PRODUTO] Script iniciado');

    // ============================================================================
    // SAFE TOAST - Evita crash se Toast não estiver pronto (Safari)
    // ============================================================================

    function safeToast(message: string, type: 'success' | 'error' | 'warning' | 'info' = 'info') {
      try {
        if (typeof window !== 'undefined' && typeof (window as any).showToast === 'function') {
          (window as any).showToast(message, type);
        } else {
          console.log('[Toast ' + type + '] ' + message);
        }
      } catch (e) {
        console.log('[Toast ' + type + '] ' + message);
      }
    }

    // ============================================================================
    // ELEMENTOS DOM
    // ============================================================================

    const form = document.getElementById('product-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const submitText = document.getElementById('submit-text') as HTMLSpanElement;
    const produtoIdInput = document.getElementById('produto_id') as HTMLInputElement;
    const fileInput = document.getElementById('foto-upload') as HTMLInputElement;
    const uploadArea = document.getElementById('upload-area');
    const existingImagesInput = document.getElementById('existing-images-json') as HTMLInputElement;

    if (!form || !uploadArea) {
      console.error('[EDITAR PRODUTO] Elementos essenciais não encontrados');
      return;
    }

    const MAX_IMAGES = 5;

    // Estado das imagens:
    let existingImageUrls: string[] = [];
    let newImageFiles: File[] = [];

    // Estado do formulário
    let formDirty = false;
    let isSubmitting = false;

    // ============================================================================
    // GESTÃO DE MEMÓRIA - Blob URLs (Safari-safe)
    // ============================================================================

    const blobUrls: string[] = [];

    function cleanupBlobUrls() {
      try {
        for (let i = 0; i < blobUrls.length; i++) {
          try { URL.revokeObjectURL(blobUrls[i]); } catch(e) {}
        }
        blobUrls.length = 0;
      } catch(e) {
        console.warn('[CLEANUP] Erro ao limpar blob URLs:', e);
      }
    }

    // Carregar imagens existentes do produto
    try {
      existingImageUrls = JSON.parse(existingImagesInput.value || '[]');
      console.log('[EDITAR] Imagens existentes carregadas: ' + existingImageUrls.length);
    } catch (e) {
      console.error('[EDITAR] Erro ao parsear imagens existentes:', e);
    }

    // ============================================================================
    // HANDLERS (Safari-safe - funções nomeadas)
    // ============================================================================

    function removeExistingImage(index: number) {
      if (index < 0 || index >= existingImageUrls.length) return;
      existingImageUrls.splice(index, 1);
      renderPreviews();
      safeToast('Imagem removida', 'success');
    }

    function removeNewImage(index: number) {
      if (index < 0 || index >= newImageFiles.length) return;
      newImageFiles.splice(index, 1);
      renderPreviews();
      safeToast('Imagem removida', 'success');
    }

    function setMainExistingImage(index: number) {
      if (index === 0 && newImageFiles.length === 0) return;
      const selectedImage = existingImageUrls.splice(index, 1)[0];
      existingImageUrls.unshift(selectedImage);
      renderPreviews();
      safeToast('Imagem principal alterada', 'success');
    }

    function setMainNewImage(index: number) {
      const selectedImage = newImageFiles.splice(index, 1)[0];
      newImageFiles.unshift(selectedImage);
      renderPreviews();
      safeToast('Imagem principal alterada', 'success');
    }

    // Expor para uso global (Safari-safe)
    try {
      (window as any).removeExistingImage = removeExistingImage;
      (window as any).removeNewImage = removeNewImage;
      (window as any).setMainExistingImage = setMainExistingImage;
      (window as any).setMainNewImage = setMainNewImage;
    } catch(e) {
      console.warn('[INIT] Não foi possível expor funções globais');
    }

    // Click na área de upload abre o file input
    uploadArea.addEventListener('click', function(e) {
      const target = e.target as HTMLElement;
      if (target.closest('button') || target.closest('.preview-item')) return;

      const totalImages = existingImageUrls.length + newImageFiles.length;
      if (totalImages < MAX_IMAGES) {
        fileInput?.click();
      } else {
        safeToast('Máximo de ' + MAX_IMAGES + ' imagens permitido', 'warning');
      }
    });

    // ============================================================================
    // RENDERIZAÇÃO DE PREVIEW (Safari-safe - sem inline onclick)
    // ============================================================================

    function renderPreviews() {
      if (!uploadArea) return;

      try {
        cleanupBlobUrls();

        const totalImages = existingImageUrls.length + newImageFiles.length;

        if (totalImages === 0) {
          uploadArea.innerHTML = '<div class="upload-placeholder">' +
            '<svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
            'd="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">' +
            '</path></svg>' +
            '<p>Clique para adicionar imagens</p>' +
            '<small>JPG, PNG até 10MB cada (máximo 5 imagens)</small>' +
            '</div>';
          return;
        }

        // Grid de imagens: primeiro as existentes, depois as novas
        let existingImagesHtml = '';
        for (let index = 0; index < existingImageUrls.length; index++) {
          const url = existingImageUrls[index];
          const isPrincipal = index === 0 && newImageFiles.length === 0;
          const borderColor = isPrincipal ? '#3b82f6' : '#e5e7eb';
          const cursor = isPrincipal ? 'default' : 'pointer';

          existingImagesHtml += '<div class="preview-item existing-item" data-type="existing" data-index="' + index + '" ' +
            'style="position: relative; aspect-ratio: 1 / 1; border-radius: 8px; overflow: hidden; ' +
            'border: 2px solid ' + borderColor + '; background: #1a1a1a; cursor: ' + cursor + '; transition: all 0.2s;" ' +
            'title="' + (isPrincipal ? 'Imagem principal' : 'Clique para tornar principal') + '">' +
            '<img src="' + url + '" alt="Imagem ' + (index + 1) + '" ' +
            'style="width: 100%; height: 100%; object-fit: cover; object-position: center; display: block;" loading="eager" />' +
            '<button type="button" class="remove-btn" data-type="existing" data-remove="' + index + '" ' +
            'style="position: absolute; top: 6px; right: 6px; background: rgba(239, 68, 68, 0.9); color: white; ' +
            'border: none; border-radius: 50%; min-width: 24px; width: 24px; height: 24px; display: flex; ' +
            'align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; ' +
            'line-height: 1; padding: 0; z-index: 10;" title="Remover imagem">×</button>' +
            (isPrincipal ? '<span style="position: absolute; bottom: 6px; left: 6px; background: rgba(59, 130, 246, 0.95); ' +
            'color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600; z-index: 5;">Principal</span>' : '') +
            '</div>';
        }

        let newImagesHtml = '';
        for (let index = 0; index < newImageFiles.length; index++) {
          const file = newImageFiles[index];
          const url = URL.createObjectURL(file);
          blobUrls.push(url);
          const globalIndex = existingImageUrls.length + index;
          const isPrincipal = globalIndex === 0;
          const borderColor = isPrincipal ? '#3b82f6' : '#e5e7eb';
          const cursor = isPrincipal ? 'default' : 'pointer';

          newImagesHtml += '<div class="preview-item new-item" data-type="new" data-index="' + index + '" ' +
            'style="position: relative; aspect-ratio: 1 / 1; border-radius: 8px; overflow: hidden; ' +
            'border: 2px solid ' + borderColor + '; background: #1a1a1a; cursor: ' + cursor + '; transition: all 0.2s;" ' +
            'title="' + (isPrincipal ? 'Imagem principal' : 'Clique para tornar principal') + '">' +
            '<img src="' + url + '" alt="' + file.name + '" ' +
            'style="width: 100%; height: 100%; object-fit: cover; object-position: center; display: block;" loading="eager" />' +
            '<button type="button" class="remove-btn" data-type="new" data-remove="' + index + '" ' +
            'style="position: absolute; top: 6px; right: 6px; background: rgba(239, 68, 68, 0.9); color: white; ' +
            'border: none; border-radius: 50%; min-width: 24px; width: 24px; height: 24px; display: flex; ' +
            'align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; ' +
            'line-height: 1; padding: 0; z-index: 10;" title="Remover imagem">×</button>' +
            (isPrincipal ? '<span style="position: absolute; bottom: 6px; left: 6px; background: rgba(59, 130, 246, 0.95); ' +
            'color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600; z-index: 5;">Principal</span>' : '') +
            '<span style="position: absolute; top: 6px; left: 6px; background: rgba(34, 197, 94, 0.95); color: white; ' +
            'font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600; z-index: 5;">Nova</span>' +
            '</div>';
        }

        let addButtonHtml = '';
        if (totalImages < MAX_IMAGES) {
          addButtonHtml = '<div class="add-more-btn" ' +
            'style="aspect-ratio: 1 / 1; border-radius: 8px; border: 2px dashed #d1d5db; display: flex; ' +
            'flex-direction: column; align-items: center; justify-content: center; cursor: pointer; ' +
            'background: #0A0A0A; transition: all 0.2s;">' +
            '<svg style="width: 32px; height: 32px; color: #f9fafb; margin-bottom: 6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>' +
            '<span style="font-size: 12px; color: #f9fafb; font-weight: 500;">Adicionar</span>' +
            '</div>';
        }

        uploadArea.innerHTML = '<div class="images-preview-grid">' + existingImagesHtml + newImagesHtml + addButtonHtml + '</div>';

        // Bind events (Safari-safe)
        bindPreviewEvents();

      } catch (e) {
        console.error('[PREVIEW] Erro ao renderizar:', e);
      }
    }

    // ============================================================================
    // EVENT BINDING para previews (Safari-safe - sem inline onclick)
    // ============================================================================

    function bindPreviewEvents() {
      // Botões de remover
      const removeButtons = uploadArea?.querySelectorAll('.remove-btn');
      if (removeButtons) {
        removeButtons.forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const btnEl = btn as HTMLElement;
            const type = btnEl.getAttribute('data-type');
            const idx = parseInt(btnEl.getAttribute('data-remove') || '-1');
            if (idx >= 0) {
              if (type === 'existing') {
                removeExistingImage(idx);
              } else {
                removeNewImage(idx);
              }
            }
          });
        });
      }

      // Itens de preview (para definir como principal)
      const previewItems = uploadArea?.querySelectorAll('.preview-item');
      if (previewItems) {
        previewItems.forEach(function(item) {
          item.addEventListener('click', function(e) {
            const target = e.target as HTMLElement;
            if (target.classList.contains('remove-btn') || target.closest('.remove-btn')) return;
            const itemEl = item as HTMLElement;
            const type = itemEl.getAttribute('data-type');
            const idx = parseInt(itemEl.getAttribute('data-index') || '-1');
            if (type === 'existing' && idx > 0) {
              setMainExistingImage(idx);
            } else if (type === 'new' && idx >= 0) {
              setMainNewImage(idx);
            }
          });
        });
      }
    }

    // ============================================================================
    // SELEÇÃO DE ARQUIVOS
    // ============================================================================

    fileInput?.addEventListener('change', function(e) {
      const input = e.target as HTMLInputElement;
      const files = input.files;
      if (!files || files.length === 0) return;

      const totalImages = existingImageUrls.length + newImageFiles.length;
      const remainingSlots = MAX_IMAGES - totalImages;

      if (files.length > remainingSlots) {
        safeToast('Você pode adicionar apenas ' + remainingSlots + ' imagem(ns) (máximo ' + MAX_IMAGES + ')', 'warning');
      }

      const filesToAdd: File[] = [];
      for (let i = 0; i < Math.min(files.length, remainingSlots); i++) {
        const file = files[i];

        if (file.size > 10 * 1024 * 1024) {
          safeToast('Arquivo ' + file.name + ' muito grande (máx 10MB)', 'error');
          continue;
        }

        if (!file.type.startsWith('image/')) {
          safeToast('Arquivo ' + file.name + ' não é uma imagem', 'error');
          continue;
        }

        filesToAdd.push(file);
      }

      for (let i = 0; i < filesToAdd.length; i++) {
        newImageFiles.push(filesToAdd[i]);
      }

      renderPreviews();

      if (filesToAdd.length > 0) {
        safeToast(filesToAdd.length + ' imagem(ns) selecionada(s)!', 'success');
      }

      input.value = '';
    });

    // ============================================================================
    // FUNÇÃO DE UPLOAD - TODAS AS IMAGENS EM UMA REQUISIÇÃO
    // ============================================================================

    async function uploadAllImages(files: File[]): Promise<string[]> {
      const batchId = Date.now() + '_' + Math.random().toString(36).substring(2, 9);

      console.log('[BATCH UPLOAD] ID: ' + batchId + ', ' + files.length + ' arquivos');

      const formData = new FormData();

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const arrayBuffer = await file.arrayBuffer();
        const blob = new Blob([new Uint8Array(arrayBuffer)], { type: file.type });
        formData.append('file' + i, blob, batchId + '_' + i + '_' + file.name);
      }

      const url = '/api/admin/upload?batch=' + batchId;

      const response = await fetch(url, {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro no upload');
      }

      const result = await response.json();
      console.log('[BATCH UPLOAD] Sucesso! ' + result.count + ' imagens');

      return result.urls;
    }

    // ============================================================================
    // SUBMIT DO FORMULÁRIO
    // ============================================================================

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      isSubmitting = true;
      if (submitBtn) submitBtn.disabled = true;
      if (submitText) submitText.innerHTML = '<div class="form-spinner"></div> Salvando...';

      try {
        // Upload das novas imagens em UMA requisição
        let newImageUrls: string[] = [];
        if (newImageFiles.length > 0) {
          console.log('[SUBMIT] ' + newImageFiles.length + ' imagens para enviar');
          if (submitText) submitText.innerHTML = '<div class="form-spinner"></div> Enviando imagens...';

          newImageUrls = await uploadAllImages(newImageFiles);
          console.log('[SUBMIT] ' + newImageUrls.length + ' imagens enviadas');
        }

        // Combinar imagens: existentes + novas
        const allImageUrls = existingImageUrls.concat(newImageUrls);

        // Preparar dados do produto
        const formData = new FormData(form);

        const produto = {
          nome: formData.get('nome'),
          codigo: formData.get('codigo'),
          preco: parseFloat(formData.get('preco') as string),
          bateria: formData.get('bateria') ? parseInt(formData.get('bateria') as string) : null,
          condicao: formData.get('condicao'),
          categoria_id: formData.get('categoria_id'),
          descricao: formData.get('descricao') || null,
          imagens: allImageUrls,
        };

        // Salvar produto
        const produtoId = produtoIdInput.value;
        const response = await fetch('/api/admin/produtos/' + produtoId, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(produto),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erro ao atualizar produto');
        }

        safeToast('Produto atualizado com sucesso!', 'success');

        // Limpar cache do service worker
        try {
          if ('caches' in window) {
            caches.keys().then(function(names) {
              names.forEach(function(name) { caches.delete(name); });
            });
          }
        } catch(e) {}

        // Redirecionar
        setTimeout(function() {
          window.location.href = '/admin/produtos?_t=' + Date.now();
        }, 1000);

      } catch (error: any) {
        console.error('[SUBMIT] Erro:', error);
        safeToast(error.message || 'Erro ao salvar produto', 'error');
        isSubmitting = false;
        if (submitBtn) submitBtn.disabled = false;
        if (submitText) submitText.textContent = 'Salvar Alterações';
      }
    });

    // ============================================================================
    // PROTEÇÃO CONTRA RELOAD (Safari-safe)
    // ============================================================================

    form.addEventListener('input', function() { formDirty = true; });

    window.addEventListener('beforeunload', function(e) {
      const hasChanges = formDirty || newImageFiles.length > 0;
      if (hasChanges && !isSubmitting) {
        e.preventDefault();
        var msg = 'Você tem alterações não salvas. Deseja realmente sair?';
        e.returnValue = msg;
        return msg;
      }
    });

    // Limpar blob URLs ao sair (Safari usa pagehide em vez de unload)
    window.addEventListener('pagehide', cleanupBlobUrls);
    window.addEventListener('unload', cleanupBlobUrls);

    // Renderizar estado inicial
    renderPreviews();

    console.log('[EDITAR PRODUTO] Script carregado com sucesso');

  })();
</script>

<style>
  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
  }

  .upload-placeholder svg {
    color: #9ca3af;
    margin-bottom: 16px;
  }

  .upload-placeholder p {
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 4px;
  }

  .upload-placeholder small {
    font-size: 12px;
    color: #9ca3af;
  }
</style>

<style is:global>
  /* Fallback para Safari sem :has() - aplica estilos diretamente na grid */
  .images-preview-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 12px;
    padding: 16px;
  }

  /* Container que tem a grid deve ajustar automaticamente */
  #upload-area,
  .form-image-upload {
    min-height: 0;
  }

  /* Para navegadores modernos com :has() */
  @supports selector(:has(*)) {
    #upload-area:has(.images-preview-grid),
    .form-image-upload:has(.images-preview-grid) {
      display: block !important;
      min-height: auto !important;
      padding: 0 !important;
    }
  }

  @media (min-width: 768px) {
    .images-preview-grid {
      grid-template-columns: repeat(5, 1fr) !important;
    }
  }

  /* Estilos para hover no botão adicionar (Safari-safe) */
  .add-more-btn:hover {
    border-color: #f9fafb !important;
    background: #121212 !important;
  }
</style>
