---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../../lib/supabaseAdmin';
import '../../../../styles/admin-form.css';

export const prerender = false;

// Headers anti-cache para Vercel
Astro.response.headers.set('Cache-Control', 'private, no-store, no-cache, must-revalidate, max-age=0');
Astro.response.headers.set('CDN-Cache-Control', 'no-store');
Astro.response.headers.set('Vercel-CDN-Cache-Control', 'no-store');

const { id } = Astro.params;

const { data: produto, error } = await supabaseAdmin
  .from('produtos')
  .select('*')
  .eq('id', id)
  .single();

if (error || !produto) {
  return Astro.redirect('/admin/produtos');
}

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout title="Editar Produto" description="Editar produto do catálogo">
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar para Produtos
        </a>
        <h1 class="form-title">Editar Produto</h1>
        <p class="form-subtitle">Atualize as informações do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <input type="hidden" id="produto_id" name="produto_id" value={produto.id} />
          <input type="hidden" id="existing-images-json" value={JSON.stringify(produto.imagens || [])} />

          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (até 5)</label>
            <input id="foto-upload" type="file" accept="image/*" multiple style="display: none;" />
            <div class="form-image-upload" id="upload-area"></div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome do Produto
              <span class="form-label-required">*</span>
            </label>
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              placeholder="Ex: iPhone 13 Pro Max 256GB"
              value={produto.nome}
              required
            />
          </div>

          <!-- Código e Preço -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">Código</label>
              <input
                id="codigo"
                name="codigo"
                type="text"
                class="form-input"
                placeholder="Ex: IP13PM256"
                value={produto.codigo || ''}
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Preço
                <span class="form-label-required">*</span>
              </label>
              <input
                id="preco"
                name="preco"
                type="text"
                inputmode="decimal"
                class="form-input"
                placeholder="0.00"
                value={produto.preco}
                required
              />
            </div>
          </div>

          <!-- Categoria e Condição -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria
                <span class="form-label-required">*</span>
              </label>
              <select id="categoria_id" name="categoria_id" class="form-select" required>
                <option value="">Selecione uma categoria</option>
                {categorias?.map((categoria) => (
                  <option value={categoria.id} selected={categoria.id === produto.categoria_id}>
                    {categoria.nome}
                  </option>
                ))}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condição</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo" selected={produto.condicao === 'Novo'}>Novo</option>
                <option value="Seminovo" selected={produto.condicao === 'Seminovo'}>Seminovo</option>
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (%)</label>
            <input
              id="bateria"
              name="bateria"
              type="text"
              inputmode="numeric"
              class="form-input"
              placeholder="Ex: 85"
              value={produto.bateria || ''}
            />
          </div>

          <!-- Descrição -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descrição</label>
            <textarea
              id="descricao"
              name="descricao"
              class="form-textarea"
              placeholder="Descreva o produto, suas características e estado..."
            >{produto.descricao || ''}</textarea>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel">Cancelar</a>
            <button type="submit" id="submit-btn" class="form-btn form-btn-submit">
              <span id="submit-text">Salvar Alterações</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // ============================================================================
  // EDITAR PRODUTO - VERSÃO SAFARI-COMPATIBLE
  // ============================================================================

  (function() {
    'use strict';

    console.log('[EDITAR PRODUTO] Script iniciado');

    var form = document.getElementById('product-form');
    var submitBtn = document.getElementById('submit-btn');
    var submitText = document.getElementById('submit-text');
    var produtoIdInput = document.getElementById('produto_id');
    var fileInput = document.getElementById('foto-upload');
    var uploadArea = document.getElementById('upload-area');
    var existingImagesInput = document.getElementById('existing-images-json');

    if (!form || !uploadArea || !fileInput) {
      console.error('[EDITAR] Elementos não encontrados');
      return;
    }

    var MAX_IMAGES = 5;
    var MAX_FILE_SIZE = 10 * 1024 * 1024;
    var existingImageUrls = [];
    var newImageFiles = [];
    var blobUrls = [];
    var isSubmitting = false;

    // Parse existing images
    try {
      existingImageUrls = JSON.parse(existingImagesInput.value || '[]');
    } catch(e) {
      existingImageUrls = [];
    }

    // Safe toast
    function toast(message, type) {
      try {
        if (window.showToast) {
          window.showToast(message, type || 'info');
        }
      } catch(e) {}
    }

    // Cleanup blob URLs
    function cleanupBlobUrls() {
      for (var i = 0; i < blobUrls.length; i++) {
        try { URL.revokeObjectURL(blobUrls[i]); } catch(e) {}
      }
      blobUrls = [];
    }

    // Remove handlers
    function removeExistingImage(index) {
      if (index >= 0 && index < existingImageUrls.length) {
        existingImageUrls.splice(index, 1);
        renderPreviews();
        toast('Imagem removida', 'success');
      }
    }

    function removeNewImage(index) {
      if (index >= 0 && index < newImageFiles.length) {
        newImageFiles.splice(index, 1);
        renderPreviews();
        toast('Imagem removida', 'success');
      }
    }

    function setMainExisting(index) {
      if (index > 0 && index < existingImageUrls.length) {
        var img = existingImageUrls.splice(index, 1)[0];
        existingImageUrls.unshift(img);
        renderPreviews();
        toast('Imagem principal alterada', 'success');
      }
    }

    function setMainNew(index) {
      if (index >= 0 && index < newImageFiles.length) {
        var file = newImageFiles.splice(index, 1)[0];
        newImageFiles.unshift(file);
        renderPreviews();
        toast('Imagem principal alterada', 'success');
      }
    }

    // Expose to window
    window.removeExistingImage = removeExistingImage;
    window.removeNewImage = removeNewImage;
    window.setMainExisting = setMainExisting;
    window.setMainNew = setMainNew;

    // Render previews
    function renderPreviews() {
      cleanupBlobUrls();

      var total = existingImageUrls.length + newImageFiles.length;

      if (total === 0) {
        uploadArea.innerHTML = '<div class="upload-placeholder">' +
          '<svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
          'd="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">' +
          '</path></svg>' +
          '<p>Clique para adicionar imagens</p>' +
          '<small>JPG, PNG até 10MB cada</small>' +
          '</div>';
        return;
      }

      var html = '<div class="images-preview-grid">';

      // Existing images
      for (var i = 0; i < existingImageUrls.length; i++) {
        var url = existingImageUrls[i];
        var isMain = (i === 0 && newImageFiles.length === 0);
        var border = isMain ? '#3b82f6' : '#e5e7eb';
        var onclick = isMain ? '' : ' onclick="event.stopPropagation();window.setMainExisting(' + i + ')"';

        html += '<div class="preview-item" style="position:relative;aspect-ratio:1/1;border-radius:8px;overflow:hidden;border:2px solid ' + border + ';background:#1a1a1a;cursor:pointer"' + onclick + '>';
        html += '<img src="' + url + '" style="width:100%;height:100%;object-fit:cover;display:block" />';
        html += '<button type="button" onclick="event.stopPropagation();event.preventDefault();window.removeExistingImage(' + i + ')" ';
        html += 'style="position:absolute;top:6px;right:6px;background:rgba(239,68,68,0.9);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:16px;font-weight:bold;display:flex;align-items:center;justify-content:center">x</button>';
        if (isMain) {
          html += '<span style="position:absolute;bottom:6px;left:6px;background:rgba(59,130,246,0.95);color:white;font-size:10px;padding:3px 8px;border-radius:4px;font-weight:600">Principal</span>';
        }
        html += '</div>';
      }

      // New images
      for (var j = 0; j < newImageFiles.length; j++) {
        var file = newImageFiles[j];
        var blobUrl = URL.createObjectURL(file);
        blobUrls.push(blobUrl);

        var globalIdx = existingImageUrls.length + j;
        var isMainNew = (globalIdx === 0);
        var borderNew = isMainNew ? '#3b82f6' : '#e5e7eb';
        var onclickNew = isMainNew ? '' : ' onclick="event.stopPropagation();window.setMainNew(' + j + ')"';

        html += '<div class="preview-item" style="position:relative;aspect-ratio:1/1;border-radius:8px;overflow:hidden;border:2px solid ' + borderNew + ';background:#1a1a1a;cursor:pointer"' + onclickNew + '>';
        html += '<img src="' + blobUrl + '" style="width:100%;height:100%;object-fit:cover;display:block" />';
        html += '<button type="button" onclick="event.stopPropagation();event.preventDefault();window.removeNewImage(' + j + ')" ';
        html += 'style="position:absolute;top:6px;right:6px;background:rgba(239,68,68,0.9);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:16px;font-weight:bold;display:flex;align-items:center;justify-content:center">x</button>';
        if (isMainNew) {
          html += '<span style="position:absolute;bottom:6px;left:6px;background:rgba(59,130,246,0.95);color:white;font-size:10px;padding:3px 8px;border-radius:4px;font-weight:600">Principal</span>';
        }
        html += '<span style="position:absolute;top:6px;left:6px;background:rgba(34,197,94,0.95);color:white;font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600">Nova</span>';
        html += '</div>';
      }

      // Add button
      if (total < MAX_IMAGES) {
        html += '<div class="add-more-btn" style="aspect-ratio:1/1;border-radius:8px;border:2px dashed #d1d5db;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;background:#0A0A0A">';
        html += '<svg style="width:32px;height:32px;color:#f9fafb;margin-bottom:6px" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
        html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>';
        html += '<span style="font-size:12px;color:#f9fafb;font-weight:500">Adicionar</span></div>';
      }

      html += '</div>';
      uploadArea.innerHTML = html;
    }

    // Upload area click
    uploadArea.addEventListener('click', function(e) {
      if (e.target.closest('button') || e.target.closest('.preview-item')) return;
      var total = existingImageUrls.length + newImageFiles.length;
      if (total < MAX_IMAGES) {
        fileInput.click();
      } else {
        toast('Máximo de ' + MAX_IMAGES + ' imagens', 'warning');
      }
    });

    // File selection
    fileInput.addEventListener('change', function(e) {
      var files = e.target.files;
      if (!files || files.length === 0) return;

      var total = existingImageUrls.length + newImageFiles.length;
      var remaining = MAX_IMAGES - total;
      var added = 0;

      for (var i = 0; i < files.length && i < remaining; i++) {
        var file = files[i];
        if (file.size > MAX_FILE_SIZE) {
          toast('Arquivo muito grande', 'error');
          continue;
        }
        if (file.type.indexOf('image') !== 0) {
          toast('Não é uma imagem', 'error');
          continue;
        }
        newImageFiles.push(file);
        added++;
      }

      fileInput.value = '';
      renderPreviews();
      if (added > 0) toast(added + ' imagem(ns) adicionada(s)', 'success');
    });

    // Upload function using XHR
    function uploadAllImages(files) {
      return new Promise(function(resolve, reject) {
        if (!files || files.length === 0) {
          resolve([]);
          return;
        }

        var formData = new FormData();
        for (var i = 0; i < files.length; i++) {
          formData.append('file' + i, files[i]);
        }

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/admin/upload?t=' + Date.now());

        xhr.onload = function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              var result = JSON.parse(xhr.responseText);
              resolve(result.urls || []);
            } catch(e) {
              reject(new Error('Erro ao processar resposta'));
            }
          } else {
            reject(new Error('Erro no upload'));
          }
        };

        xhr.onerror = function() {
          reject(new Error('Erro de conexão'));
        };

        xhr.send(formData);
      });
    }

    // Form submit
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      var total = existingImageUrls.length + newImageFiles.length;
      if (total === 0) {
        toast('Adicione pelo menos uma imagem', 'warning');
        return;
      }

      if (isSubmitting) return;
      isSubmitting = true;

      submitBtn.disabled = true;
      submitText.innerHTML = '<div class="form-spinner"></div> Enviando...';

      var produtoId = produtoIdInput.value;
      var nome = form.nome.value.trim();
      var codigo = form.codigo.value.trim() || null;
      var precoStr = form.preco.value.replace(',', '.').trim();
      var preco = parseFloat(precoStr);
      var bateriaStr = form.bateria.value.trim();
      var bateria = bateriaStr ? parseInt(bateriaStr, 10) : null;
      var condicao = form.condicao.value;
      var categoria_id = form.categoria_id.value;
      var descricao = form.descricao.value.trim() || null;

      if (isNaN(preco) || preco <= 0) {
        toast('Preço inválido', 'error');
        isSubmitting = false;
        submitBtn.disabled = false;
        submitText.textContent = 'Salvar Alterações';
        return;
      }

      // Upload new images first
      uploadAllImages(newImageFiles)
        .then(function(newUrls) {
          submitText.innerHTML = '<div class="form-spinner"></div> Salvando...';

          var allUrls = existingImageUrls.concat(newUrls);

          var produto = {
            nome: nome,
            codigo: codigo,
            preco: preco,
            bateria: bateria,
            condicao: condicao,
            categoria_id: categoria_id,
            descricao: descricao,
            imagens: allUrls
          };

          return fetch('/api/admin/produtos/' + produtoId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(produto)
          });
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(function(err) {
              throw new Error(err.error || 'Erro ao salvar');
            });
          }
          return response.json();
        })
        .then(function() {
          toast('Produto atualizado!', 'success');
          setTimeout(function() {
            window.location.href = '/admin/produtos?t=' + Date.now();
          }, 1000);
        })
        .catch(function(error) {
          console.error('Erro:', error);
          toast(error.message || 'Erro ao salvar', 'error');
          isSubmitting = false;
          submitBtn.disabled = false;
          submitText.textContent = 'Salvar Alterações';
        });
    });

    // Initial render
    renderPreviews();

  })();
</script>

<style>
  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
  }

  .upload-placeholder svg {
    color: #9ca3af;
    margin-bottom: 16px;
  }

  .upload-placeholder p {
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 4px;
  }

  .upload-placeholder small {
    font-size: 12px;
    color: #9ca3af;
  }
</style>

<style is:global>
  .images-preview-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 12px;
    padding: 16px;
  }

  @media (min-width: 768px) {
    .images-preview-grid {
      grid-template-columns: repeat(5, 1fr) !important;
    }
  }

  .add-more-btn:hover {
    border-color: #f9fafb !important;
    background: #121212 !important;
  }
</style>
