---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabaseAdmin';
import '../../../styles/admin-form.css';

export const prerender = false;

// CRITICAL: Desabilitar TODOS os caches (Vercel, CDN, browser)
Astro.response.headers.set('Cache-Control', 'private, no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0, s-maxage=0');
Astro.response.headers.set('CDN-Cache-Control', 'no-store');
Astro.response.headers.set('Vercel-CDN-Cache-Control', 'no-store');
Astro.response.headers.set('Surrogate-Control', 'no-store');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout
  title="Novo Produto"
  description="Adicionar novo produto ao catálogo"
>
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar para Produtos
        </a>
        <h1 class="form-title">Novo Produto</h1>
        <p class="form-subtitle">Preencha as informações do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (até 5)</label>
            <input
              id="foto-upload"
              type="file"
              accept="image/*"
              multiple
              style="display: none;"
            />
            <div class="form-image-upload" id="upload-area">
              <div class="upload-placeholder">
                <svg
                  width="48"
                  height="48"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                <p>Clique para adicionar imagens</p>
                <small>JPG, PNG até 10MB cada (máximo 5 imagens)</small>
              </div>
            </div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome do Produto
              <span class="form-label-required">*</span>
            </label>
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              placeholder="Ex: iPhone 13 Pro Max 256GB"
              required
            />
          </div>

          <!-- Código e Preço -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">Código</label>
              <input
                id="codigo"
                name="codigo"
                type="text"
                class="form-input"
                placeholder="Ex: IP13PM256"
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Preço
                <span class="form-label-required">*</span>
              </label>
              <input
                id="preco"
                name="preco"
                type="number"
                step="0.01"
                class="form-input"
                placeholder="0.00"
                required
              />
            </div>
          </div>

          <!-- Categoria e Condição -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria
                <span class="form-label-required">*</span>
              </label>
              <select
                id="categoria_id"
                name="categoria_id"
                class="form-select"
                required
              >
                <option value="">Selecione uma categoria</option>
                {
                  categorias?.map((categoria) => (
                    <option value={categoria.id}>{categoria.nome}</option>
                  ))
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condição</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo">Novo</option>
                <option value="Seminovo">Seminovo</option>
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (mAh)</label>
            <input
              id="bateria"
              name="bateria"
              type="number"
              class="form-input"
              placeholder="Ex: 4352"
            />
          </div>

          <!-- Descrição -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descrição</label>
            <textarea
              id="descricao"
              name="descricao"
              class="form-textarea"
              placeholder="Descreva o produto, suas características e estado..."
            ></textarea>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel"
              >Cancelar</a
            >
            <button
              type="submit"
              id="submit-btn"
              class="form-btn form-btn-submit"
            >
              <span id="submit-text">Adicionar Produto</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // ============================================================================
  // VERSÃO SIMPLIFICADA - Upload no Submit (não imediato)
  // COMPATÍVEL COM SAFARI/iOS
  // ============================================================================

  (function() {
    'use strict';

    console.log('[NOVO PRODUTO] Script iniciado');

    // ============================================================================
    // SAFE TOAST - Evita crash se Toast não estiver pronto (Safari)
    // ============================================================================

    function safeToast(message: string, type: 'success' | 'error' | 'warning' | 'info' = 'info') {
      try {
        if (typeof window !== 'undefined' && typeof (window as any).showToast === 'function') {
          (window as any).showToast(message, type);
        } else {
          console.log('[Toast ' + type + '] ' + message);
        }
      } catch (e) {
        console.log('[Toast ' + type + '] ' + message);
      }
    }

    // ============================================================================
    // ELEMENTOS DOM
    // ============================================================================

    const form = document.getElementById('product-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const submitText = document.getElementById('submit-text') as HTMLSpanElement;
    const fileInput = document.getElementById('foto-upload') as HTMLInputElement;
    const uploadArea = document.getElementById('upload-area');

    if (!form || !uploadArea) {
      console.error('[NOVO PRODUTO] Elementos essenciais não encontrados');
      return;
    }

    const MAX_IMAGES = 5;
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

    // Array de arquivos selecionados
    let selectedFiles: File[] = [];

    // Estado do formulário
    let formDirty = false;
    let isSubmitting = false;

    // ============================================================================
    // GESTÃO DE BLOB URLs (com try-catch para Safari)
    // ============================================================================

    const blobUrls: string[] = [];

    function cleanupBlobUrls() {
      try {
        for (let i = 0; i < blobUrls.length; i++) {
          try { URL.revokeObjectURL(blobUrls[i]); } catch(e) {}
        }
        blobUrls.length = 0;
      } catch(e) {
        console.warn('[CLEANUP] Erro ao limpar blob URLs:', e);
      }
    }

    // ============================================================================
    // HANDLERS GLOBAIS - Usando data attributes (Safari-safe)
    // ============================================================================

    function removeImageAt(index: number) {
      if (index < 0 || index >= selectedFiles.length) return;
      console.log('[REMOVE] Removendo imagem ' + (index + 1));
      selectedFiles.splice(index, 1);
      renderPreviews();
      safeToast('Imagem removida', 'success');
    }

    function setMainImage(index: number) {
      if (index === 0 || index >= selectedFiles.length) return;
      console.log('[MAIN] Tornando imagem ' + (index + 1) + ' como principal');
      const selected = selectedFiles.splice(index, 1)[0];
      selectedFiles.unshift(selected);
      renderPreviews();
      safeToast('Imagem principal alterada', 'success');
    }

    // Expor para uso global (Safari-safe)
    try {
      (window as any).removeImageAt = removeImageAt;
      (window as any).setMainImage = setMainImage;
    } catch(e) {
      console.warn('[INIT] Não foi possível expor funções globais');
    }

    // ============================================================================
    // RENDERIZAÇÃO DE PREVIEW (Blob URLs locais - SEM upload)
    // ============================================================================

    function renderPreviews() {
      if (!uploadArea) return;

      try {
        // Limpar URLs antigas
        cleanupBlobUrls();

        console.log('[PREVIEW] Renderizando ' + selectedFiles.length + ' imagens');

        if (selectedFiles.length === 0) {
          uploadArea.innerHTML = '<div class="upload-placeholder">' +
            '<svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ' +
            'd="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">' +
            '</path></svg>' +
            '<p>Clique para adicionar imagens</p>' +
            '<small>JPG, PNG até 10MB cada (máximo 5 imagens)</small>' +
            '</div>';
          return;
        }

        // Criar HTML para cada imagem
        let imagesHTML = '';
        for (let index = 0; index < selectedFiles.length; index++) {
          const file = selectedFiles[index];
          const blobUrl = URL.createObjectURL(file);
          blobUrls.push(blobUrl);

          const isMain = index === 0;
          const borderColor = isMain ? '#3b82f6' : '#e5e7eb';
          const cursor = isMain ? 'default' : 'pointer';

          imagesHTML += '<div class="preview-item" data-index="' + index + '" ' +
            'style="position: relative; aspect-ratio: 1 / 1; border-radius: 8px; overflow: hidden; ' +
            'border: 2px solid ' + borderColor + '; background: #1a1a1a; cursor: ' + cursor + '; transition: all 0.2s;" ' +
            'title="' + (isMain ? 'Imagem principal' : 'Clique para tornar principal') + '">' +
            '<img src="' + blobUrl + '" alt="' + file.name + '" ' +
            'style="width: 100%; height: 100%; object-fit: cover; object-position: center; display: block;" loading="eager" />' +
            '<button type="button" class="remove-btn" data-remove="' + index + '" ' +
            'style="position: absolute; top: 6px; right: 6px; background: rgba(239, 68, 68, 0.9); color: white; ' +
            'border: none; border-radius: 50%; min-width: 24px; width: 24px; height: 24px; display: flex; ' +
            'align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; ' +
            'line-height: 1; padding: 0; z-index: 10;" title="Remover imagem">×</button>' +
            (isMain ? '<span style="position: absolute; bottom: 6px; left: 6px; background: rgba(59, 130, 246, 0.95); ' +
            'color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600; z-index: 5;">Principal</span>' : '') +
            '</div>';
        }

        // Botão de adicionar mais
        let addButtonHTML = '';
        if (selectedFiles.length < MAX_IMAGES) {
          addButtonHTML = '<div class="add-more-btn" ' +
            'style="aspect-ratio: 1 / 1; border-radius: 8px; border: 2px dashed #d1d5db; display: flex; ' +
            'flex-direction: column; align-items: center; justify-content: center; cursor: pointer; ' +
            'background: #0A0A0A; transition: all 0.2s;">' +
            '<svg style="width: 32px; height: 32px; color: #f9fafb; margin-bottom: 6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>' +
            '<span style="font-size: 12px; color: #f9fafb; font-weight: 500;">Adicionar</span>' +
            '</div>';
        }

        uploadArea.innerHTML = '<div class="images-preview-grid">' + imagesHTML + addButtonHTML + '</div>';

        // Adicionar event listeners (Safari-safe - evita inline onclick)
        bindPreviewEvents();

      } catch (e) {
        console.error('[PREVIEW] Erro ao renderizar:', e);
      }
    }

    // ============================================================================
    // EVENT DELEGATION para previews (Safari-safe)
    // ============================================================================

    function bindPreviewEvents() {
      // Botões de remover
      const removeButtons = uploadArea?.querySelectorAll('.remove-btn');
      if (removeButtons) {
        removeButtons.forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const idx = parseInt((btn as HTMLElement).getAttribute('data-remove') || '-1');
            if (idx >= 0) removeImageAt(idx);
          });
        });
      }

      // Itens de preview (para definir como principal)
      const previewItems = uploadArea?.querySelectorAll('.preview-item');
      if (previewItems) {
        previewItems.forEach(function(item) {
          item.addEventListener('click', function(e) {
            const target = e.target as HTMLElement;
            if (target.classList.contains('remove-btn') || target.closest('.remove-btn')) return;
            const idx = parseInt((item as HTMLElement).getAttribute('data-index') || '-1');
            if (idx > 0) setMainImage(idx);
          });
        });
      }
    }

    // ============================================================================
    // EVENTOS
    // ============================================================================

    // Click na área de upload
    uploadArea.addEventListener('click', function(e) {
      const target = e.target as HTMLElement;
      // Ignorar se clicou em botão ou preview-item
      if (target.closest('.remove-btn') || target.closest('.preview-item')) return;

      if (selectedFiles.length < MAX_IMAGES) {
        fileInput?.click();
      } else {
        safeToast('Máximo de ' + MAX_IMAGES + ' imagens', 'warning');
      }
    });

    // Seleção de arquivos
    fileInput?.addEventListener('change', function(e) {
      const input = e.target as HTMLInputElement;
      const files = input.files;
      if (!files || files.length === 0) return;

      console.log('[SELEÇÃO] ' + files.length + ' arquivo(s) selecionado(s)');

      const remainingSlots = MAX_IMAGES - selectedFiles.length;
      const filesToAdd: File[] = [];

      for (let i = 0; i < Math.min(files.length, remainingSlots); i++) {
        const file = files[i];
        console.log('  Arquivo: ' + file.name + ', ' + (file.size / 1024).toFixed(1) + 'KB');

        // Validar tamanho
        if (file.size > MAX_FILE_SIZE) {
          safeToast(file.name + ' é muito grande (máx 10MB)', 'error');
          continue;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
          safeToast(file.name + ' não é uma imagem', 'error');
          continue;
        }

        filesToAdd.push(file);
      }

      // Adicionar ao array
      for (let i = 0; i < filesToAdd.length; i++) {
        selectedFiles.push(filesToAdd[i]);
      }

      // Limpar input
      input.value = '';

      renderPreviews();

      if (filesToAdd.length > 0) {
        safeToast(filesToAdd.length + ' imagem(ns) adicionada(s)', 'success');
      }
    });

    // ============================================================================
    // FUNÇÃO DE UPLOAD - TODAS AS IMAGENS EM UMA REQUISIÇÃO
    // ============================================================================

    async function uploadAllImages(files: File[]): Promise<string[]> {
      const batchId = Date.now() + '_' + Math.random().toString(36).substring(2, 9);

      console.log('[BATCH UPLOAD] ID: ' + batchId + ', ' + files.length + ' arquivos');

      // Criar FormData com TODOS os arquivos
      const formData = new FormData();

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        // Ler dados do arquivo em buffer isolado
        const arrayBuffer = await file.arrayBuffer();
        const blob = new Blob([new Uint8Array(arrayBuffer)], { type: file.type });

        // Adicionar com nome único: file0, file1, file2...
        formData.append('file' + i, blob, batchId + '_' + i + '_' + file.name);
      }

      // UMA ÚNICA requisição para todas as imagens
      const url = '/api/admin/upload?batch=' + batchId;

      const response = await fetch(url, {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro no upload');
      }

      const result = await response.json();
      console.log('[BATCH UPLOAD] Sucesso! ' + result.count + ' imagens');

      return result.urls;
    }

    // ============================================================================
    // SUBMIT DO FORMULÁRIO
    // ============================================================================

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      if (selectedFiles.length === 0) {
        safeToast('Adicione pelo menos uma imagem', 'warning');
        return;
      }

      isSubmitting = true;
      if (submitBtn) submitBtn.disabled = true;
      if (submitText) submitText.innerHTML = '<div class="form-spinner"></div> Enviando imagens...';

      try {
        console.log('[SUBMIT] Iniciando salvamento, ' + selectedFiles.length + ' imagens');

        // Upload de TODAS as imagens em UMA requisição
        const uploadedUrls = await uploadAllImages(selectedFiles);

        if (uploadedUrls.length === 0) {
          throw new Error('Nenhuma imagem foi enviada com sucesso');
        }

        console.log('[SUBMIT] ' + uploadedUrls.length + ' imagens enviadas');

        // Preparar dados do produto
        if (submitText) submitText.innerHTML = '<div class="form-spinner"></div> Salvando produto...';

        const formData = new FormData(form);
        const produto = {
          nome: formData.get('nome'),
          codigo: formData.get('codigo') || null,
          preco: parseFloat(formData.get('preco') as string),
          bateria: formData.get('bateria') ? parseInt(formData.get('bateria') as string) : null,
          condicao: formData.get('condicao'),
          categoria_id: formData.get('categoria_id'),
          descricao: formData.get('descricao') || null,
          imagens: uploadedUrls,
        };

        // Salvar produto
        const response = await fetch('/api/admin/produtos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(produto),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erro ao salvar produto');
        }

        console.log('[SUBMIT] Produto salvo com sucesso!');
        safeToast('Produto adicionado com sucesso!', 'success');

        // Redirecionar
        setTimeout(function() {
          window.location.href = '/admin/produtos?_t=' + Date.now();
        }, 1000);

      } catch (error: any) {
        console.error('[SUBMIT] Erro:', error);
        safeToast(error.message || 'Erro ao salvar produto', 'error');
        isSubmitting = false;
        if (submitBtn) submitBtn.disabled = false;
        if (submitText) submitText.textContent = 'Adicionar Produto';
      }
    });

    // ============================================================================
    // PROTEÇÃO CONTRA RELOAD (Safari-safe)
    // ============================================================================

    form.addEventListener('input', function() { formDirty = true; });

    window.addEventListener('beforeunload', function(e) {
      if ((formDirty || selectedFiles.length > 0) && !isSubmitting) {
        e.preventDefault();
        // Safari requer que returnValue seja definido
        var msg = 'Você tem alterações não salvas. Deseja realmente sair?';
        e.returnValue = msg;
        return msg;
      }
    });

    // Limpar blob URLs ao sair (Safari usa pagehide em vez de unload)
    window.addEventListener('pagehide', cleanupBlobUrls);
    window.addEventListener('unload', cleanupBlobUrls);

    // Renderizar estado inicial
    renderPreviews();

    console.log('[NOVO PRODUTO] Script carregado com sucesso');

  })();
</script>

<style>
  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
  }

  .upload-placeholder svg {
    color: #9ca3af;
    margin-bottom: 16px;
  }

  .upload-placeholder p {
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 4px;
  }

  .upload-placeholder small {
    font-size: 12px;
    color: #9ca3af;
  }
</style>

<style is:global>
  /* Fallback para Safari sem :has() - aplica estilos diretamente na grid */
  .images-preview-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 12px;
    padding: 16px;
  }

  /* Container que tem a grid deve ajustar automaticamente */
  #upload-area,
  .form-image-upload {
    min-height: 0;
  }

  /* Para navegadores modernos com :has() */
  @supports selector(:has(*)) {
    #upload-area:has(.images-preview-grid),
    .form-image-upload:has(.images-preview-grid) {
      display: block !important;
      min-height: auto !important;
      padding: 0 !important;
    }
  }

  @media (min-width: 768px) {
    .images-preview-grid {
      grid-template-columns: repeat(5, 1fr) !important;
    }
  }

  /* Estilos para hover no botão adicionar (Safari-safe) */
  .add-more-btn:hover {
    border-color: #f9fafb !important;
    background: #121212 !important;
  }
</style>
