---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabaseAdmin';
import '../../../styles/admin-form.css';

export const prerender = false;

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout
  title="Novo Produto"
  description="Adicionar novo produto ao cat√°logo"
>
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar
        </a>
        <h1 class="form-title">Novo Produto</h1>
        <p class="form-subtitle">Preencha as informa√ß√µes do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <!-- Imagens -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (at√© 5)</label>
            <input
              id="file-input"
              type="file"
              accept="image/*"
              multiple
              style="display: none;"
            />
            <div id="upload-area" class="upload-area">
              <!-- Conte√∫do din√¢mico -->
            </div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome <span class="form-label-required">*</span>
            </label>
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              required
            />
          </div>

          <!-- C√≥digo e Pre√ßo -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">C√≥digo</label>
              <input id="codigo" name="codigo" type="text" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Pre√ßo <span class="form-label-required">*</span>
              </label>
              <input
                id="preco"
                name="preco"
                type="text"
                inputmode="decimal"
                class="form-input"
                required
              />
            </div>
          </div>

          <!-- Categoria e Condi√ß√£o -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria <span class="form-label-required">*</span>
              </label>
              <select
                id="categoria_id"
                name="categoria_id"
                class="form-select"
                required
              >
                <option value="">Selecione</option>
                {categorias?.map((c) => <option value={c.id}>{c.nome}</option>)}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condi√ß√£o</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo">Novo</option>
                <option value="Seminovo">Seminovo</option>
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (%)</label>
            <input
              id="bateria"
              name="bateria"
              type="text"
              inputmode="numeric"
              class="form-input"
            />
          </div>

          <!-- Descri√ß√£o -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descri√ß√£o</label>
            <textarea id="descricao" name="descricao" class="form-textarea"
            ></textarea>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel"
              >Cancelar</a
            >
            <button
              type="submit"
              id="submit-btn"
              class="form-btn form-btn-submit"
            >
              <span id="submit-text">Adicionar Produto</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .upload-area {
    min-height: 200px;
    border: 2px dashed #444;
    border-radius: 8px;
    background: #0a0a0a;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .upload-area:hover {
    border-color: #666;
    background: #111;
  }

  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
  }

  .upload-placeholder svg {
    color: #666;
    margin-bottom: 12px;
  }

  .upload-placeholder p {
    color: #888;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 4px;
  }

  .upload-placeholder small {
    color: #555;
    font-size: 12px;
  }

  .images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
  }

  .image-card {
    position: relative;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #333;
    background: #000;
    cursor: pointer;
    transition: all 0.2s;
  }

  .image-card:hover {
    border-color: #555;
    transform: translateY(-2px);
  }

  .image-card.is-main {
    border-color: #3b82f6;
  }

  .image-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .image-card .remove-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(239, 68, 68, 0.95);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    cursor: pointer;
    z-index: 10;
    opacity: 0;
    transition: all 0.2s;
  }

  .image-card:hover .remove-btn {
    opacity: 1;
  }

  .image-card .remove-btn:hover {
    background: #dc2626;
    transform: scale(1.1);
  }

  .image-card .main-badge {
    position: absolute;
    bottom: 6px;
    left: 6px;
    background: rgba(59, 130, 246, 0.95);
    color: white;
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .add-image-btn {
    aspect-ratio: 1;
    border-radius: 8px;
    border: 2px dashed #444;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: #151515;
    color: #888;
    transition: all 0.2s;
  }

  .add-image-btn:hover {
    border-color: #666;
    background: #222;
    color: #fff;
  }

  .add-image-btn svg {
    margin-bottom: 4px;
  }

  .add-image-btn span {
    font-size: 11px;
    font-weight: 500;
  }

  .loading-card {
    aspect-ratio: 1;
    border-radius: 8px;
    border: 2px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #1a1a1a;
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid #444;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  // ============================================================================
  // SISTEMA DE UPLOAD SIMPLIFICADO E ROBUSTO
  // ============================================================================

  interface UploadState {
    images: string[];
    uploading: boolean;
  }

  const state: UploadState = {
    images: [],
    uploading: false,
  };

  const MAX_IMAGES = 5;
  const MAX_FILE_SIZE = 10 * 1024 * 1024;

  let fileInput: HTMLInputElement;
  let uploadArea: HTMLElement;
  let form: HTMLFormElement;
  let submitBtn: HTMLButtonElement;
  let submitText: HTMLSpanElement;

  // ============================================================================
  // INICIALIZA√á√ÉO
  // ============================================================================

  function init() {
    console.log('[UPLOAD] Inicializando...');

    fileInput = document.getElementById('file-input') as HTMLInputElement;
    uploadArea = document.getElementById('upload-area') as HTMLElement;
    form = document.getElementById('product-form') as HTMLFormElement;
    submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    submitText = document.getElementById('submit-text') as HTMLSpanElement;

    if (!fileInput || !uploadArea || !form) {
      console.error('[UPLOAD] Elementos n√£o encontrados!');
      return;
    }

    // Event listeners
    fileInput.addEventListener('change', handleFileSelect);
    uploadArea.addEventListener('click', handleUploadAreaClick);
    form.addEventListener('submit', handleSubmit);

    // Fun√ß√µes globais
    (window as any).removeImage = removeImage;
    (window as any).setAsMain = setAsMain;
    (window as any).openFileDialog = () => fileInput.click();

    renderUploadArea();
    console.log('[UPLOAD] ‚úÖ Inicializado');
  }

  // ============================================================================
  // UPLOAD DE ARQUIVOS
  // ============================================================================

  async function handleFileSelect(e: Event) {
    const input = e.target as HTMLInputElement;
    const files = input.files;

    if (!files || files.length === 0) {
      return;
    }

    console.log(
      `\n[UPLOAD] ======== ${files.length} arquivo(s) selecionado(s) ========`
    );

    // Limpar input
    input.value = '';

    // Verificar limite
    const remaining = MAX_IMAGES - state.images.length;
    if (remaining === 0) {
      window.showToast('M√°ximo de 5 imagens atingido', 'warning');
      return;
    }

    // Pegar apenas os que cabem
    const filesToUpload = Array.from(files).slice(0, remaining);

    if (filesToUpload.length < files.length) {
      window.showToast(
        `Enviando apenas ${filesToUpload.length} de ${files.length} imagens`,
        'warning'
      );
    }

    // Validar todos os arquivos primeiro
    for (const file of filesToUpload) {
      if (!file.type.startsWith('image/')) {
        window.showToast(`${file.name} n√£o √© uma imagem`, 'error');
        return;
      }
      if (file.size > MAX_FILE_SIZE) {
        window.showToast(`${file.name} √© muito grande (m√°x 10MB)`, 'error');
        return;
      }
    }

    state.uploading = true;
    updateSubmitButton();

    let successCount = 0;

    // Upload sequencial com delay
    for (let i = 0; i < filesToUpload.length; i++) {
      const file = filesToUpload[i];

      console.log(`\n[UPLOAD ${i + 1}/${filesToUpload.length}] ${file.name}`);

      try {
        // Delay entre uploads (exceto o primeiro)
        if (i > 0) {
          console.log(`[UPLOAD ${i + 1}] ‚è±Ô∏è  Aguardando 500ms...`);
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        const url = await uploadSingleFile(file, i);

        if (url) {
          // Verificar duplicata
          if (state.images.includes(url)) {
            console.warn(`[UPLOAD ${i + 1}] ‚ö†Ô∏è  URL duplicada, ignorando`);
            continue;
          }

          state.images.push(url);
          successCount++;
          renderUploadArea();
          console.log(`[UPLOAD ${i + 1}] ‚úÖ Sucesso`);
        }
      } catch (error) {
        console.error(`[UPLOAD ${i + 1}] ‚ùå Erro:`, error);
        window.showToast(`Erro ao enviar ${file.name}`, 'error');
      }
    }

    state.uploading = false;
    updateSubmitButton();

    if (successCount > 0) {
      window.showToast(`${successCount} imagem(ns) enviada(s)!`, 'success');
    }

    console.log('[UPLOAD] ======== FIM ========\n');
  }

  async function uploadSingleFile(
    file: File,
    index: number
  ): Promise<string | null> {
    // Mostrar loading
    const loadingId = `loading-${Date.now()}-${index}`;
    addLoadingCard(loadingId);

    try {
      // Comprimir se necess√°rio
      let fileToUpload = file;

      if (file.size > 2 * 1024 * 1024) {
        console.log(`[UPLOAD] Comprimindo ${file.name}...`);
        const imageCompression = (await import('browser-image-compression'))
          .default;
        fileToUpload = await imageCompression(file, {
          maxSizeMB: 1.5,
          maxWidthOrHeight: 1920,
          useWebWorker: true,
          initialQuality: 0.8,
        });
        console.log(
          `[UPLOAD] Comprimido: ${(file.size / 1024).toFixed(0)}KB ‚Üí ${(fileToUpload.size / 1024).toFixed(0)}KB`
        );
      }

      // Upload
      const formData = new FormData();
      formData.append('file', fileToUpload);

      console.log(`[UPLOAD] üì§ Enviando...`);

      const response = await fetch('/api/admin/upload', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro no upload');
      }

      const data = await response.json();

      if (!data.url) {
        throw new Error('URL n√£o retornada');
      }

      console.log(`[UPLOAD] ‚úÖ URL: ${data.url.substring(0, 60)}...`);

      removeLoadingCard(loadingId);
      return data.url;
    } catch (error: any) {
      console.error('[UPLOAD] Erro:', error);
      removeLoadingCard(loadingId);
      throw error;
    }
  }

  // ============================================================================
  // GERENCIAMENTO DE IMAGENS
  // ============================================================================

  function removeImage(index: number) {
    console.log(`[UPLOAD] Removendo imagem ${index}`);
    state.images.splice(index, 1);
    renderUploadArea();
    window.showToast('Imagem removida', 'success');
  }

  function setAsMain(index: number) {
    if (index === 0) return;
    console.log(`[UPLOAD] Definindo imagem ${index} como principal`);
    const [image] = state.images.splice(index, 1);
    state.images.unshift(image);
    renderUploadArea();
    window.showToast('Imagem principal atualizada', 'success');
  }

  // ============================================================================
  // RENDERIZA√á√ÉO
  // ============================================================================

  function handleUploadAreaClick(e: Event) {
    const target = e.target as HTMLElement;

    // N√£o abrir se clicar em bot√£o ou imagem
    if (target.closest('button') || target.closest('.image-card')) {
      return;
    }

    if (state.images.length < MAX_IMAGES) {
      fileInput.click();
    }
  }

  function renderUploadArea() {
    if (!uploadArea) return;

    const hasImages = state.images.length > 0;
    const canAddMore = state.images.length < MAX_IMAGES;

    if (!hasImages) {
      uploadArea.innerHTML = `
      <div class="upload-placeholder">
        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <p>Clique para adicionar fotos</p>
        <small>Selecione at√© 5 fotos de uma vez ‚Ä¢ M√°ximo 10MB cada</small>
      </div>
    `;
      return;
    }

    const imagesHtml = state.images
      .map(
        (url, i) => `
    <div class="image-card ${i === 0 ? 'is-main' : ''}" onclick="window.setAsMain(${i})">
      <img src="${url}" alt="Foto ${i + 1}" loading="lazy" />
      <button type="button" class="remove-btn" onclick="event.stopPropagation(); window.removeImage(${i})">√ó</button>
      ${i === 0 ? '<span class="main-badge">Principal</span>' : ''}
    </div>
  `
      )
      .join('');

    const addButtonHtml = canAddMore
      ? `
    <div class="add-image-btn" onclick="window.openFileDialog()">
      <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      <span>Adicionar</span>
    </div>
  `
      : '';

    uploadArea.innerHTML = `
    <div class="images-grid">
      ${imagesHtml}
      ${addButtonHtml}
    </div>
  `;
  }

  function addLoadingCard(id: string) {
    const grid = uploadArea.querySelector('.images-grid');
    if (!grid) {
      uploadArea.innerHTML = '<div class="images-grid"></div>';
      return addLoadingCard(id);
    }

    const loading = document.createElement('div');
    loading.id = id;
    loading.className = 'loading-card';
    loading.innerHTML = '<div class="spinner"></div>';

    grid.appendChild(loading);
  }

  function removeLoadingCard(id: string) {
    document.getElementById(id)?.remove();
  }

  function updateSubmitButton() {
    if (!submitBtn || !submitText) return;
    submitBtn.disabled = state.uploading;
    submitText.textContent = state.uploading
      ? 'Aguarde...'
      : 'Adicionar Produto';
  }

  // ============================================================================
  // SUBMIT DO FORMUL√ÅRIO
  // ============================================================================

  async function handleSubmit(e: Event) {
    e.preventDefault();

    if (state.images.length === 0) {
      window.showToast('Adicione pelo menos uma foto', 'warning');
      return;
    }

    if (state.uploading) {
      window.showToast('Aguarde o upload finalizar', 'warning');
      return;
    }

    submitBtn.disabled = true;
    submitText.innerHTML = '<div class="form-spinner"></div> Salvando...';

    try {
      const formData = new FormData(form);

      const payload = {
        nome: formData.get('nome'),
        codigo: formData.get('codigo') || null,
        preco:
          parseFloat((formData.get('preco') as string).replace(',', '.')) || 0,
        bateria: formData.get('bateria')
          ? parseInt(formData.get('bateria') as string)
          : null,
        condicao: formData.get('condicao'),
        categoria_id: formData.get('categoria_id'),
        descricao: formData.get('descricao') || null,
        imagens: state.images,
      };

      console.log('[SUBMIT] Payload:', payload);

      const response = await fetch('/api/admin/produtos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro ao salvar');
      }

      window.showToast('Produto criado com sucesso!', 'success');
      setTimeout(() => (window.location.href = '/admin/produtos'), 500);
    } catch (error: any) {
      console.error('[SUBMIT] Erro:', error);
      window.showToast(error.message, 'error');
      submitBtn.disabled = false;
      submitText.textContent = 'Adicionar Produto';
    }
  }

  // ============================================================================
  // INIT
  // ============================================================================

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
