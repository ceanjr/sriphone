--- 
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabaseAdmin';
import '../../../styles/admin-form.css';

export const prerender = false;

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout
  title="Novo Produto"
  description="Adicionar novo produto ao catálogo"
>
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar para Produtos
        </a>
        <h1 class="form-title">Novo Produto</h1>
        <p class="form-subtitle">Preencha as informações do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <!-- State Storage -->
          <input type="hidden" id="final-images-json" name="imagens_json" value="[]" />

          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (até 5)</label>
            <input
              id="foto-upload"
              type="file"
              accept="image/*"
              multiple
              style="display: none;"
            />
            <div class="form-image-upload" id="upload-area">
              <div class="upload-placeholder">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <p>Clique para adicionar fotos</p>
                <small>PNG, JPG, WEBP • Até 10MB por foto</small>
              </div>
            </div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome do Produto <span class="form-label-required">*</span>
            </label>
            <input id="nome" name="nome" type="text" class="form-input" placeholder="Ex: iPhone 13 Pro Max 256GB" required />
          </div>

          <!-- Código e Preço -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">Código</label>
              <input id="codigo" name="codigo" type="text" class="form-input" placeholder="Ex: IP13PM256" />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Preço <span class="form-label-required">*</span>
              </label>
              <input id="preco" name="preco" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" class="form-input" placeholder="0.00" required />
            </div>
          </div>

          <!-- Categoria e Condição -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria <span class="form-label-required">*</span>
              </label>
              <select id="categoria_id" name="categoria_id" class="form-select" required>
                <option value="">Selecione uma categoria</option>
                {categorias?.map((c) => <option value={c.id}>{c.nome}</option>)}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condição</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo">Novo</option>
                <option value="Seminovo">Seminovo</option>
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (%)</label>
            <input id="bateria" name="bateria" type="text" inputmode="numeric" pattern="[0-9]*" class="form-input" placeholder="Ex: 80" />
          </div>

          <!-- Descrição -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descrição</label>
            <textarea id="descricao" name="descricao" class="form-textarea" placeholder="Descreva o produto..."></textarea>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel">Cancelar</a>
            <button type="submit" id="submit-btn" class="form-btn form-btn-submit">
              <span id="submit-text">Adicionar Produto</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // ============================================================================ 
  // REFACTOR: ATOMIC UPLOAD SYSTEM (Inspirado no UPLOAD.md) 
  // ============================================================================ 

  // Local State (Encapsulado para evitar poluição global entre páginas) 
  let state = {
    uploadedUrls: [] as string[],
    isUploading: false
  };

  // Elements
  const elements = {
    form: document.getElementById('product-form') as HTMLFormElement,
    fileInput: document.getElementById('foto-upload') as HTMLInputElement,
    uploadArea: document.getElementById('upload-area') as HTMLElement,
    submitBtn: document.getElementById('submit-btn') as HTMLButtonElement,
    submitText: document.getElementById('submit-text') as HTMLSpanElement,
    finalImagesInput: document.getElementById('final-images-json') as HTMLInputElement,
  };

  function init() {
    if (!elements.form) return;

    // 1. Limpeza rigorosa no init (Fix Ghosting)
    state.uploadedUrls = [];
    state.isUploading = false;
    elements.form.reset();
    syncState();

    // 2. Listeners
    elements.fileInput.addEventListener('change', handleFileSelect);
    elements.uploadArea.addEventListener('click', handleAreaClick);
    elements.form.addEventListener('submit', handleSubmit);

    // 3. Global callbacks
    (window as any).removeImage = (index: number) => {
      state.uploadedUrls.splice(index, 1);
      syncState();
    };
    (window as any).setMainImage = (index: number) => {
      if (index === 0) return;
      const [img] = state.uploadedUrls.splice(index, 1);
      state.uploadedUrls.unshift(img);
      syncState();
      window.showToast('Foto principal atualizada', 'success');
    };

    console.log('✅ Upload System Initialized & State Cleared');
  }

  function handleAreaClick(e: MouseEvent) {
    const target = e.target as HTMLElement;
    if (target.closest('button') || target.closest('.preview-card')) return;
    if (state.uploadedUrls.length < 5) elements.fileInput.click();
    else window.showToast('Máximo de 5 fotos', 'warning');
  }

  async function handleFileSelect(e: Event) {
    const files = Array.from(elements.fileInput.files || []);
    if (files.length === 0) return;

    const remaining = 5 - state.uploadedUrls.length;
    const toUpload = files.slice(0, remaining);

    if (toUpload.length === 0) {
      window.showToast('Limite atingido', 'warning');
      elements.fileInput.value = '';
      return;
    }

    state.isUploading = true;
    updateSubmitUI();

    for (const file of toUpload) {
      try {
        // Validation
        if (file.size > 10 * 1024 * 1024) throw new Error(`${file.name} é muito grande`);
        
        // Individual placeholder
        const tempId = `up-${Math.random().toString(36).slice(2)}`;
        renderPlaceholder(tempId);

        // Upload
        const url = await uploadFile(file);
        
        // Success: Replace placeholder with real URL
        state.uploadedUrls.push(url);
        syncState();
      } catch (err: any) {
        window.showToast(err.message, 'error');
      }
    }

    elements.fileInput.value = '';
    state.isUploading = false;
    updateSubmitUI();
  }

  async function uploadFile(file: File): Promise<string> {
    const formData = new FormData();
    formData.append('file', file); // API agora aceita 'file' genérico

    const response = await fetch(`/api/admin/upload?t=${Date.now()}`, {
      method: 'POST',
      body: formData,
      headers: { 'Cache-Control': 'no-cache' }
    });

    if (!response.ok) throw new Error('Falha no upload');
    const data = await response.json();
    return data.urls[0];
  }

  function syncState() {
    elements.finalImagesInput.value = JSON.stringify(state.uploadedUrls);
    renderPreviews();
  }

  function updateSubmitUI() {
    elements.submitBtn.disabled = state.isUploading;
    elements.submitText.innerHTML = state.isUploading ? '<div class="form-spinner"></div> Enviando...' : 'Adicionar Produto';
  }

  function renderPlaceholder(id: string) {
    const grid = elements.uploadArea.querySelector('.images-preview-grid');
    if (!grid) {
      elements.uploadArea.innerHTML = '<div class="images-preview-grid"></div>';
      renderPlaceholder(id);
      return;
    }
    const div = document.createElement('div');
    div.id = id;
    div.className = 'preview-card loading';
    div.innerHTML = '<div class="form-spinner"></div>';
    grid.appendChild(div);
  }

  function renderPreviews() {
    if (state.uploadedUrls.length === 0) {
      elements.uploadArea.innerHTML = `
        <div class="upload-placeholder">
          <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          <p>Clique para adicionar fotos</p>
          <small>PNG, JPG, WEBP • Máximo 5 fotos</small>
        </div>`;
      return;
    }

    const html = state.uploadedUrls.map((url, i) => `
      <div class="preview-card ${i === 0 ? 'is-main' : ''}" onclick="window.setMainImage(${i})">
        <img src="${url}" alt="Preview" />
        <button type="button" class="remove-btn" onclick="event.stopPropagation(); window.removeImage(${i})">×</button>
        ${i === 0 ? '<span class="main-badge">Principal</span>' : ''}
      </div>
    `).join('');

    elements.uploadArea.innerHTML = `
      <div class="images-preview-grid">
        ${html}
        ${state.uploadedUrls.length < 5 ? '<div class="add-more-btn" onclick="document.getElementById(\'foto-upload\').click()">+</div>' : ''}
      </div>`;
  }

  async function handleSubmit(e: Event) {
    e.preventDefault();
    if (state.uploadedUrls.length === 0) return window.showToast('Adicione uma foto', 'warning');
    
    elements.submitBtn.disabled = true;
    elements.submitText.innerHTML = '<div class="form-spinner"></div> Salvando...';

    try {
      const fd = new FormData(elements.form);
      const payload = {
        nome: fd.get('nome'),
        codigo: fd.get('codigo') || null,
        preco: parseFloat((fd.get('preco') as string).replace(',', '.')) || 0,
        bateria: fd.get('bateria') ? parseInt(fd.get('bateria') as string) : null,
        condicao: fd.get('condicao'),
        categoria_id: fd.get('categoria_id'),
        descricao: fd.get('descricao') || null,
        imagens: state.uploadedUrls,
      };

      const res = await fetch('/api/admin/produtos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error('Erro ao salvar produto');
      
      window.showToast('Produto criado!', 'success');
      setTimeout(() => window.location.href = '/admin/produtos', 500);
    } catch (err: any) {
      window.showToast(err.message, 'error');
      elements.submitBtn.disabled = false;
      elements.submitText.textContent = 'Adicionar Produto';
    }
  }

  // Auto-init
  init();
</script>

<style>
  .upload-placeholder {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 40px; text-align: center; cursor: pointer; background: #0A0A0A;
    border-radius: 8px; border: 2px dashed #333; transition: 0.2s;
  }
  .upload-placeholder:hover { border-color: #555; background: #111; } 
  .upload-placeholder svg { color: #666; margin-bottom: 12px; }
  .upload-placeholder p { font-size: 14px; color: #888; }
</style>

<style is:global>
  .images-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; padding: 10px; background: #111; border-radius: 8px; border: 1px solid #333; }
  .preview-card { position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; background: #000; border: 2px solid #333; cursor: pointer; }
  .preview-card.is-main { border-color: #3b82f6; }
  .preview-card.loading { display: flex; align-items: center; justify-content: center; }
  .preview-card img { width: 100%; height: 100%; object-fit: cover; }
  .remove-btn { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; border-radius: 50%; background: #ef4444; color: #fff; border: none; font-size: 12px; cursor: pointer; z-index: 10; }
  .main-badge { position: absolute; bottom: 2px; left: 2px; background: #3b82f6; color: #fff; font-size: 9px; padding: 1px 4px; border-radius: 3px; }
  .add-more-btn { aspect-ratio: 1; border-radius: 6px; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #151515; color: #888; font-size: 24px; }
</style>