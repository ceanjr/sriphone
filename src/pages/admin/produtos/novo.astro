---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabaseAdmin';
import '../../../styles/admin-form.css';

export const prerender = false;

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout
  title="Novo Produto"
  description="Adicionar novo produto ao cat√°logo"
>
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar para Produtos
        </a>
        <h1 class="form-title">Novo Produto</h1>
        <p class="form-subtitle">Preencha as informa√ß√µes do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (at√© 5)</label>
            <input
              id="foto-upload"
              type="file"
              accept="image/*"
              multiple
              style="display: none;"
            />
            <div class="form-image-upload" id="upload-area">
              <div class="upload-placeholder">
                <svg
                  width="48"
                  height="48"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                <p>Clique para adicionar imagens</p>
                <small>JPG, PNG at√© 10MB cada (m√°ximo 5 imagens)</small>
              </div>
            </div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome do Produto
              <span class="form-label-required">*</span>
            </label>
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              placeholder="Ex: iPhone 13 Pro Max 256GB"
              required
            />
          </div>

          <!-- C√≥digo e Pre√ßo -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">C√≥digo</label>
              <input
                id="codigo"
                name="codigo"
                type="text"
                class="form-input"
                placeholder="Ex: IP13PM256"
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Pre√ßo
                <span class="form-label-required">*</span>
              </label>
              <input
                id="preco"
                name="preco"
                type="text"
                inputmode="decimal"
                pattern="[0-9]*[.,]?[0-9]*"
                class="form-input"
                placeholder="0.00"
                required
              />
            </div>
          </div>

          <!-- Categoria e Condi√ß√£o -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria
                <span class="form-label-required">*</span>
              </label>
              <select
                id="categoria_id"
                name="categoria_id"
                class="form-select"
                required
              >
                <option value="">Selecione uma categoria</option>
                {
                  categorias?.map((categoria) => (
                    <option value={categoria.id}>{categoria.nome}</option>
                  ))
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condi√ß√£o</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo">Novo</option>
                <option value="Seminovo">Seminovo</option>
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (%)</label>
            <input
              id="bateria"
              name="bateria"
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              class="form-input"
              placeholder="Ex: 80"
            />
          </div>

          <!-- Descri√ß√£o -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descri√ß√£o</label>
            <textarea
              id="descricao"
              name="descricao"
              class="form-textarea"
              placeholder="Descreva o produto, suas caracter√≠sticas e estado..."
            ></textarea>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel"
              >Cancelar</a
            >
            <button
              type="submit"
              id="submit-btn"
              class="form-btn form-btn-submit"
            >
              <span id="submit-text">Adicionar Produto</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // ============================================================================
  // GERENCIADOR DE PRODUTO (FIX GHOSTING & RELIABILITY)
  // ============================================================================

  class ProductManager {
    private form: HTMLFormElement;
    private submitBtn: HTMLButtonElement;
    private submitText: HTMLSpanElement;
    private fileInput: HTMLInputElement;
    private uploadArea: HTMLElement;
    
    private selectedFiles: File[] = [];
    private blobUrls: string[] = [];
    private isSubmitting = false;
    private formDirty = false;

    private readonly MAX_IMAGES = 5;
    private readonly MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    private readonly UPLOAD_CONCURRENCY = 3; // Upload 3 images in parallel

    constructor() {
      this.form = document.getElementById('product-form') as HTMLFormElement;
      this.submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
      this.submitText = document.getElementById('submit-text') as HTMLSpanElement;
      this.fileInput = document.getElementById('foto-upload') as HTMLInputElement;
      this.uploadArea = document.getElementById('upload-area') as HTMLElement;

      this.init();
    }

    private init() {
      if (!this.form) return;

      // Event Listeners
      this.fileInput?.addEventListener('change', (e) => this.handleFileSelect(e));
      this.uploadArea?.addEventListener('click', (e) => this.handleAreaClick(e));
      this.form.addEventListener('submit', (e) => this.handleSubmit(e));
      this.form.addEventListener('input', () => { this.formDirty = true; });

      // Global Handlers for Preview Actions
      (window as any).removeImageAt = (index: number) => this.removeImage(index);
      (window as any).setMainImage = (index: number) => this.setMainImage(index);

      // Lifecycle Handlers
      window.addEventListener('beforeunload', (e) => this.handleBeforeUnload(e));
      window.addEventListener('pagehide', () => this.cleanup());
      
      // CRITICAL: Reset on page show (Back button fix)
      window.addEventListener('pageshow', () => {
        console.log('üîÑ [PAGESHOW] Resetting state to prevent ghosting');
        this.reset();
      });

      // Initial Render
      this.renderPreviews();
    }

    // ========================================================================
    // STATE MANAGEMENT
    // ========================================================================

    private reset() {
      this.cleanupBlobUrls();
      this.selectedFiles = [];
      this.blobUrls = [];
      this.isSubmitting = false;
      this.formDirty = false;
      
      if (this.fileInput) this.fileInput.value = '';
      if (this.form) this.form.reset();
      
      this.enableSubmit();
      this.renderPreviews();
    }

    private cleanup() {
      this.cleanupBlobUrls();
      // Don't fully reset state here on pagehide, just blobs to save memory.
      // Full reset happens on pageshow or success.
    }

    private cleanupBlobUrls() {
      this.blobUrls.forEach(url => URL.revokeObjectURL(url));
      this.blobUrls = [];
    }

    private enableSubmit() {
      if (this.submitBtn) {
        this.submitBtn.disabled = false;
        if (this.submitText) this.submitText.innerHTML = 'Adicionar Produto';
      }
    }

    private disableSubmit(message: string) {
      if (this.submitBtn) {
        this.submitBtn.disabled = true;
        if (this.submitText) this.submitText.innerHTML = `<div class="form-spinner"></div> ${message}`;
      }
    }

    // ========================================================================
    // FILE HANDLING
    // ========================================================================

    private handleAreaClick(e: MouseEvent) {
      const target = e.target as HTMLElement;
      if (target.closest('button')) return;

      if (this.selectedFiles.length < this.MAX_IMAGES) {
        this.fileInput?.click();
      } else {
        window.showToast(`M√°ximo de ${this.MAX_IMAGES} imagens`, 'warning');
      }
    }

    private handleFileSelect(e: Event) {
      const input = e.target as HTMLInputElement;
      const files = input.files;
      if (!files || files.length === 0) return;

      const remainingSlots = this.MAX_IMAGES - this.selectedFiles.length;
      const filesToAdd = Array.from(files).slice(0, remainingSlots);

      let addedCount = 0;

      for (const file of filesToAdd) {
        if (file.size > this.MAX_FILE_SIZE) {
          window.showToast(`${file.name} √© muito grande (m√°x 10MB)`, 'error');
          continue;
        }
        if (!file.type.startsWith('image/')) {
          window.showToast(`${file.name} n√£o √© uma imagem`, 'error');
          continue;
        }
        this.selectedFiles.push(file);
        addedCount++;
      }

      input.value = ''; // Always clear input to allow re-selecting same file
      this.renderPreviews();
      
      if (addedCount > 0) {
        window.showToast(`${addedCount} imagem(ns) adicionada(s)`, 'success');
      }
    }

    private removeImage(index: number) {
      this.selectedFiles.splice(index, 1);
      this.renderPreviews();
    }

    private setMainImage(index: number) {
      if (index === 0) return;
      const [selected] = this.selectedFiles.splice(index, 1);
      this.selectedFiles.unshift(selected);
      this.renderPreviews();
      window.showToast('Imagem principal definida', 'success');
    }

    // ========================================================================
    // RENDERING
    // ========================================================================

    private renderPreviews() {
      if (!this.uploadArea) return;
      
      this.cleanupBlobUrls(); // Clear old blobs before creating new ones

      if (this.selectedFiles.length === 0) {
        this.uploadArea.innerHTML = `
          <div class="upload-placeholder">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p>Clique para adicionar imagens</p>
            <small>JPG, PNG at√© 10MB cada (m√°ximo 5 imagens)</small>
          </div>
        `;
        return;
      }

      const imagesHTML = this.selectedFiles.map((file, index) => {
        const blobUrl = URL.createObjectURL(file);
        this.blobUrls.push(blobUrl);
        const isMain = index === 0;

        return `
          <div class="preview-card ${isMain ? 'is-main' : ''}" 
               ${!isMain ? `onclick="window.setMainImage(${index})"` : ''}
               title="${isMain ? 'Imagem principal' : 'Clique para tornar principal'}">
            <img src="${blobUrl}" alt="${file.name}" loading="lazy" />
            <button type="button" class="remove-btn" onclick="event.stopPropagation(); window.removeImageAt(${index})" title="Remover">√ó</button>
            ${isMain ? '<span class="main-badge">Principal</span>' : ''}
          </div>
        `;
      }).join('');

      const addButtonHTML = this.selectedFiles.length < this.MAX_IMAGES
        ? `
          <div class="add-more-btn" onclick="document.getElementById('foto-upload').click()">
            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <span>Adicionar</span>
          </div>
        `
        : '';

      this.uploadArea.innerHTML = `
        <div class="images-preview-grid">
          ${imagesHTML}
          ${addButtonHTML}
        </div>
      `;
    }

    // ========================================================================
    // UPLOAD LOGIC (Optimized & Reliable)
    // ========================================================================

    private async compressImage(file: File): Promise<File> {
      const imageCompression = (await import('browser-image-compression')).default;
      const options = {
        maxSizeMB: 2, // Strict 2MB limit to stay safe within Vercel's 4.5MB
        maxWidthOrHeight: 1920,
        useWebWorker: true,
        fileType: 'image/jpeg',
        initialQuality: 0.85,
        exifOrientation: undefined, // Auto
      };

      try {
        const compressed = await imageCompression(file, options);
        // If still too big, force down
        if (compressed.size > 3.5 * 1024 * 1024) {
             const aggressive = await imageCompression(compressed, { ...options, maxSizeMB: 1, initialQuality: 0.7 });
             return aggressive;
        }
        return compressed;
      } catch (err) {
        console.warn('Compression failed, using original', err);
        return file;
      }
    }

    private async uploadSingleImage(file: File, index: number): Promise<string> {
      const formData = new FormData();
      const compressed = await this.compressImage(file);
      
      // We send as 'file0' because the backend expects 'file' prefix, but we are just sending one.
      const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
      formData.append('file0', compressed, safeName);

      const response = await fetch('/api/admin/upload', {
        method: 'POST',
        body: formData,
        credentials: 'include'
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(`Erro upload (${response.status}): ${text.substring(0, 50)}`);
      }

      const result = await response.json();
      if (result.urls && result.urls.length > 0) {
        return result.urls[0];
      }
      throw new Error('Nenhuma URL retornada');
    }

    private async uploadImagesParallel(): Promise<string[]> {
      const urls: string[] = new Array(this.selectedFiles.length);
      const errors: string[] = [];
      
      // Simple queue management for concurrency
      let currentIndex = 0;
      
      const processNext = async () => {
        while (currentIndex < this.selectedFiles.length) {
          const i = currentIndex++;
          try {
            console.log(`üì§ Uploading ${i+1}/${this.selectedFiles.length}...`);
            urls[i] = await this.uploadSingleImage(this.selectedFiles[i], i);
          } catch (err: any) {
            console.error(`‚ùå Error uploading image ${i}:`, err);
            errors.push(`Imagem ${i+1}: ${err.message}`);
          }
        }
      };

      const workers = Array(Math.min(this.selectedFiles.length, this.UPLOAD_CONCURRENCY))
        .fill(null)
        .map(() => processNext());

      await Promise.all(workers);

      if (errors.length > 0) {
        throw new Error(errors.join('\n'));
      }

      return urls;
    }

    // ========================================================================
    // SUBMISSION
    // ========================================================================

    private async handleSubmit(e: Event) {
      e.preventDefault();
      if (this.selectedFiles.length === 0) {
        window.showToast('Adicione pelo menos uma imagem', 'warning');
        return;
      }

      this.isSubmitting = true;
      this.disableSubmit('Enviando imagens...');

      try {
        // 1. Upload Images
        const uploadedUrls = await this.uploadImagesParallel();
        
        // 2. Submit Product
        this.disableSubmit('Salvando produto...');
        const formData = new FormData(this.form);
        
        const produto = {
          nome: formData.get('nome'),
          codigo: formData.get('codigo') || null,
          preco: parseFloat((formData.get('preco') as string).replace(',', '.')) || 0,
          bateria: formData.get('bateria') ? parseInt(formData.get('bateria') as string) : null,
          condicao: formData.get('condicao'),
          categoria_id: formData.get('categoria_id'),
          descricao: formData.get('descricao') || null,
          imagens: uploadedUrls,
        };

        const response = await fetch('/api/admin/produtos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(produto),
          credentials: 'include',
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erro ao salvar produto');
        }

        window.showToast('Produto adicionado com sucesso!', 'success');
        
        // Success Cleanup
        this.reset();
        
        // Redirect with timestamp to force refresh
        setTimeout(() => {
          window.location.href = `/admin/produtos?_t=${Date.now()}`;
        }, 500);

      } catch (error: any) {
        console.error('‚ùå Submit Error:', error);
        window.showToast(error.message || 'Erro ao salvar', 'error');
        this.enableSubmit();
        this.isSubmitting = false;
      }
    }

    private handleBeforeUnload(e: BeforeUnloadEvent) {
      if ((this.formDirty || this.selectedFiles.length > 0) && !this.isSubmitting) {
        e.preventDefault();
        e.returnValue = '';
      }
    }
  }

  // Initialize
  new ProductManager();
</script>

<style>
  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    background: #0A0A0A;
    border-radius: 8px;
    border: 2px dashed #333;
    transition: all 0.2s;
  }
  .upload-placeholder:hover {
    border-color: #555;
    background: #111;
  }
  .upload-placeholder svg { color: #666; margin-bottom: 16px; }
  .upload-placeholder p { font-size: 14px; font-weight: 500; color: #888; margin-bottom: 4px; }
  .upload-placeholder small { font-size: 12px; color: #555; }
</style>

<style is:global>
  .images-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
    padding: 12px;
    background: #111;
    border-radius: 8px;
    border: 1px solid #333;
  }

  .preview-card {
    position: relative;
    aspect-ratio: 1/1;
    border-radius: 6px;
    overflow: hidden;
    background: #000;
    border: 2px solid #333;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .preview-card.is-main { border-color: #3b82f6; }
  .preview-card:hover { border-color: #555; }
  .preview-card.is-main:hover { border-color: #2563eb; }

  .preview-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(220, 38, 38, 0.9);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    line-height: 1;
    cursor: pointer;
    z-index: 10;
  }
  
  .main-badge {
    position: absolute;
    bottom: 4px;
    left: 4px;
    background: rgba(59, 130, 246, 0.9);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
  }

  .add-more-btn {
    aspect-ratio: 1/1;
    border-radius: 6px;
    border: 2px dashed #444;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: #151515;
    color: #888;
    transition: all 0.2s;
  }
  .add-more-btn:hover {
    border-color: #666;
    background: #222;
    color: #fff;
  }
  .add-more-btn span { font-size: 12px; margin-top: 4px; }
</style>
