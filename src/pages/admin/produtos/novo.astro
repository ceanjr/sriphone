---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabaseAdmin';
import '../../../styles/admin-form.css';

export const prerender = false;

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout
  title="Novo Produto"
  description="Adicionar novo produto ao cat√°logo"
>
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path></svg
          >
          Voltar
        </a>
        <h1 class="form-title">Novo Produto</h1>
        <p class="form-subtitle">Preencha as informa√ß√µes do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <input
            type="hidden"
            id="final-images-json"
            name="imagens_json"
            value="[]"
          />

          <div class="form-group">
            <label class="form-label">Imagens do Produto (at√© 5)</label>
            <input
              id="foto-upload"
              type="file"
              accept="image/*,image/heic,image/heif"
              multiple
              style="display: none;"
            />
            <div class="form-image-upload" id="upload-area">
              <!-- Conte√∫do din√¢mico -->
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="nome"
              >Nome <span class="form-label-required">*</span></label
            >
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">C√≥digo</label>
              <input id="codigo" name="codigo" type="text" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco"
                >Pre√ßo <span class="form-label-required">*</span></label
              >
              <input
                id="preco"
                name="preco"
                type="text"
                inputmode="decimal"
                class="form-input"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id"
                >Categoria <span class="form-label-required">*</span></label
              >
              <select
                id="categoria_id"
                name="categoria_id"
                class="form-select"
                required
              >
                <option value="">Selecione</option>
                {categorias?.map((c) => <option value={c.id}>{c.nome}</option>)}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condi√ß√£o</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo">Novo</option>
                <option value="Seminovo">Seminovo</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (%)</label>
            <input
              id="bateria"
              name="bateria"
              type="text"
              inputmode="numeric"
              class="form-input"
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="descricao">Descri√ß√£o</label>
            <textarea id="descricao" name="descricao" class="form-textarea"
            ></textarea>
          </div>

          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel"
              >Cancelar</a
            >
            <button
              type="submit"
              id="submit-btn"
              class="form-btn form-btn-submit"
            >
              <span id="submit-text">Adicionar Produto</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // ============================================================================
  // SISTEMA DE UPLOAD - VERS√ÉO FINAL (baseado no sistema Next.js)
  // ============================================================================

  // Estado global
  const state = {
    images: [] as string[],
    uploading: false,
    uploadProgress: 0,
  };

  // Elementos (inicializados ap√≥s DOM ready)
  let elements: {
    form: HTMLFormElement;
    fileInput: HTMLInputElement;
    uploadArea: HTMLElement;
    submitBtn: HTMLButtonElement;
    submitText: HTMLSpanElement;
    finalImagesInput: HTMLInputElement;
  };

  // Configura√ß√µes
  const CONFIG = {
    maxImages: 5,
    maxFileSize: 10 * 1024 * 1024, // 10MB
    allowedTypes: [
      'image/jpeg',
      'image/jpg',
      'image/png',
      'image/webp',
      'image/gif',
      'image/heic',
      'image/heif',
    ],
    compressionOptions: {
      maxSizeMB: 1.5,
      maxWidthOrHeight: 1920,
      useWebWorker: true,
      initialQuality: 0.8,
    },
  };

  // ============================================================================
  // FUN√á√ïES DE INICIALIZA√á√ÉO
  // ============================================================================

  function initElements() {
    elements = {
      form: document.getElementById('product-form') as HTMLFormElement,
      fileInput: document.getElementById('foto-upload') as HTMLInputElement,
      uploadArea: document.getElementById('upload-area') as HTMLElement,
      submitBtn: document.getElementById('submit-btn') as HTMLButtonElement,
      submitText: document.getElementById('submit-text') as HTMLSpanElement,
      finalImagesInput: document.getElementById(
        'final-images-json'
      ) as HTMLInputElement,
    };
  }

  function init() {
    console.log('[UPLOAD] Inicializando sistema...');
    console.log('[UPLOAD] User Agent:', navigator.userAgent);
    console.log('[UPLOAD] Touch:', 'ontouchstart' in window);

    initElements();

    // Verificar elementos
    if (!elements.form || !elements.fileInput || !elements.uploadArea) {
      console.error('[UPLOAD] Elementos n√£o encontrados!');
      return;
    }

    // Estado inicial
    state.images = [];
    state.uploading = false;
    state.uploadProgress = 0;

    // Renderizar UI inicial
    renderUploadArea();

    // Event Listeners
    elements.fileInput.addEventListener('change', handleFileSelect);
    elements.form.addEventListener('submit', handleSubmit);

    // Fun√ß√µes globais para bot√µes
    (window as any).removeImage = removeImage;
    (window as any).setMainImage = setMainImage;
    (window as any).triggerFileInput = () => elements.fileInput?.click();

    console.log('[UPLOAD] ‚úÖ Sistema inicializado');
  }

  // ============================================================================
  // MANIPULA√á√ÉO DE ARQUIVOS
  // ============================================================================

  async function handleFileSelect(e: Event) {
    console.log('[UPLOAD] ========================================');
    console.log('[UPLOAD] Sele√ß√£o de arquivos iniciada');

    const input = e.target as HTMLInputElement;
    const files = input.files;

    if (!files || files.length === 0) {
      console.warn('[UPLOAD] Nenhum arquivo selecionado');
      return;
    }

    console.log(`[UPLOAD] ${files.length} arquivo(s) selecionado(s)`);

    // Validar quantidade
    const remainingSlots = CONFIG.maxImages - state.images.length;
    if (remainingSlots === 0) {
      window.showToast?.('M√°ximo de 5 imagens atingido', 'warning');
      input.value = '';
      return;
    }

    // Converter FileList para Array
    const filesArray = Array.from(files);
    const filesToProcess = filesArray.slice(0, remainingSlots);

    if (filesToProcess.length < filesArray.length) {
      window.showToast?.(
        `Processando apenas ${filesToProcess.length} de ${filesArray.length} imagens`,
        'info'
      );
    }

    // Validar arquivos
    const validFiles: File[] = [];
    for (const file of filesToProcess) {
      console.log(
        `[UPLOAD] Validando: ${file.name} (${(file.size / 1024).toFixed(2)}KB, ${file.type})`
      );

      if (!file.type.startsWith('image/')) {
        window.showToast?.(`${file.name} n√£o √© uma imagem v√°lida`, 'error');
        continue;
      }

      if (file.size > CONFIG.maxFileSize) {
        window.showToast?.(`${file.name} √© muito grande (m√°x 10MB)`, 'error');
        continue;
      }

      validFiles.push(file);
    }

    if (validFiles.length === 0) {
      console.warn('[UPLOAD] Nenhum arquivo v√°lido');
      input.value = '';
      return;
    }

    console.log(`[UPLOAD] ${validFiles.length} arquivo(s) v√°lido(s)`);

    // Iniciar upload
    state.uploading = true;
    state.uploadProgress = 0;
    updateUploadUI();

    // Limpar input ap√≥s capturar arquivos
    input.value = '';

    // Processar uploads
    await processUploads(validFiles);

    // Finalizar
    state.uploading = false;
    state.uploadProgress = 0;
    updateUploadUI();

    console.log('[UPLOAD] ========================================');
  }

  async function processUploads(files: File[]) {
    const totalFiles = files.length;
    const uploadedUrls: string[] = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      console.log(
        `[UPLOAD ${i + 1}/${totalFiles}] Processando ${file.name}...`
      );

      try {
        // Comprimir imagem
        const compressedFile = await compressImage(file);
        console.log(
          `[UPLOAD ${i + 1}/${totalFiles}] Compress√£o: ${(file.size / 1024).toFixed(2)}KB ‚Üí ${(compressedFile.size / 1024).toFixed(2)}KB`
        );

        // Upload para servidor
        const url = await uploadToServer(compressedFile, file.name);
        console.log(`[UPLOAD ${i + 1}/${totalFiles}] ‚úÖ Success: ${url}`);

        uploadedUrls.push(url);
        state.uploadProgress = Math.round(((i + 1) / totalFiles) * 100);
        updateUploadUI();
      } catch (error: any) {
        console.error(`[UPLOAD ${i + 1}/${totalFiles}] ‚ùå Erro:`, error);
        window.showToast?.(
          `Erro ao enviar ${file.name}: ${error.message}`,
          'error'
        );
      }
    }

    if (uploadedUrls.length > 0) {
      state.images.push(...uploadedUrls);
      syncState();
      renderUploadArea();
      window.showToast?.(
        `${uploadedUrls.length} imagem(ns) enviada(s) com sucesso!`,
        'success'
      );
    }
  }

  async function compressImage(file: File): Promise<File> {
    // Se o arquivo j√° √© pequeno, n√£o comprimir
    if (file.size <= 2 * 1024 * 1024) {
      return file;
    }

    try {
      const imageCompression = (await import('browser-image-compression'))
        .default;
      return await imageCompression(file, CONFIG.compressionOptions);
    } catch (error) {
      console.warn('[UPLOAD] Erro na compress√£o, usando original:', error);
      return file;
    }
  }

  async function uploadToServer(
    file: File,
    originalName: string
  ): Promise<string> {
    const formData = new FormData();
    const safeName = originalName.replace(/[^a-zA-Z0-9._-]/g, '_');
    const uniqueName = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${safeName}`;

    formData.append('file', file, uniqueName);

    const response = await fetch(`/api/admin/upload?t=${Date.now()}`, {
      method: 'POST',
      body: formData,
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        Pragma: 'no-cache',
      },
    });

    if (!response.ok) {
      const errorData = await response
        .json()
        .catch(() => ({ error: 'Erro desconhecido' }));
      throw new Error(errorData.error || `HTTP ${response.status}`);
    }

    const data = await response.json();

    if (!data.urls || !data.urls[0]) {
      throw new Error('URL n√£o retornada pelo servidor');
    }

    // Adicionar cache-busting
    return `${data.urls[0]}?v=${Date.now()}`;
  }

  // ============================================================================
  // MANIPULA√á√ÉO DE IMAGENS
  // ============================================================================

  function removeImage(index: number) {
    console.log(`[UPLOAD] Removendo imagem ${index}`);
    state.images.splice(index, 1);
    syncState();
    renderUploadArea();
    window.showToast?.('Imagem removida', 'success');
  }

  function setMainImage(index: number) {
    if (index === 0) return;

    console.log(`[UPLOAD] Definindo imagem ${index} como principal`);
    const [image] = state.images.splice(index, 1);
    state.images.unshift(image);
    syncState();
    renderUploadArea();
    window.showToast?.('Foto principal atualizada', 'success');
  }

  // ============================================================================
  // RENDERIZA√á√ÉO
  // ============================================================================

  function renderUploadArea() {
    if (!elements.uploadArea) return;

    const hasImages = state.images.length > 0;
    const canAddMore = state.images.length < CONFIG.maxImages;

    if (!hasImages && !state.uploading) {
      elements.uploadArea.innerHTML = `
        <div class="upload-placeholder" onclick="window.triggerFileInput()">
          <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p>Clique para adicionar fotos</p>
          <small>PNG, JPG, WEBP ‚Ä¢ M√°ximo ${CONFIG.maxImages} fotos ‚Ä¢ At√© 10MB por foto</small>
        </div>
      `;
      return;
    }

    const imagesHtml = state.images
      .map(
        (url, index) => `
      <div class="preview-card ${index === 0 ? 'is-main' : ''}" onclick="window.setMainImage(${index})">
        <img src="${url}" alt="Foto ${index + 1}" loading="eager" />
        <button type="button" class="remove-btn" onclick="event.stopPropagation(); window.removeImage(${index})">√ó</button>
        ${index === 0 ? '<span class="main-badge">Principal</span>' : ''}
      </div>
    `
      )
      .join('');

    const addButtonHtml = canAddMore
      ? `
      <div class="add-more-btn" onclick="window.triggerFileInput()">
        <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span>Adicionar</span>
      </div>
    `
      : '';

    const progressHtml = state.uploading
      ? `
      <div class="upload-progress">
        <div class="upload-progress-bar" style="width: ${state.uploadProgress}%"></div>
        <span class="upload-progress-text">${state.uploadProgress}%</span>
      </div>
    `
      : '';

    elements.uploadArea.innerHTML = `
      ${progressHtml}
      <div class="images-preview-grid">
        ${imagesHtml}
        ${addButtonHtml}
      </div>
      ${hasImages ? '<p class="upload-hint">üí° A primeira foto √© a principal. Clique em uma foto para torn√°-la principal.</p>' : ''}
    `;
  }

  function updateUploadUI() {
    if (!elements.submitBtn || !elements.submitText) return;

    elements.submitBtn.disabled = state.uploading;
    elements.submitText.textContent = state.uploading
      ? `Enviando... ${state.uploadProgress}%`
      : 'Adicionar Produto';
  }

  function syncState() {
    if (!elements.finalImagesInput) return;

    // Remover cache-busting antes de salvar
    const cleanUrls = state.images.map((url) => url.split('?')[0]);
    elements.finalImagesInput.value = JSON.stringify(cleanUrls);

    console.log('[UPLOAD] Estado sincronizado:', cleanUrls.length, 'imagens');
  }

  // ============================================================================
  // SUBMIT DO FORMUL√ÅRIO
  // ============================================================================

  async function handleSubmit(e: Event) {
    e.preventDefault();
    console.log('[SUBMIT] Enviando formul√°rio...');

    if (state.images.length === 0) {
      window.showToast?.('Adicione pelo menos uma foto', 'warning');
      return;
    }

    if (state.uploading) {
      window.showToast?.('Aguarde o upload das imagens', 'warning');
      return;
    }

    elements.submitBtn.disabled = true;
    elements.submitText.innerHTML =
      '<div class="form-spinner"></div> Salvando...';

    try {
      const formData = new FormData(elements.form);

      // Limpar URLs (remover cache-busting)
      const cleanUrls = state.images.map((url) => url.split('?')[0]);

      const payload = {
        nome: formData.get('nome'),
        codigo: formData.get('codigo') || null,
        preco:
          parseFloat((formData.get('preco') as string).replace(',', '.')) || 0,
        bateria: formData.get('bateria')
          ? parseInt(formData.get('bateria') as string)
          : null,
        condicao: formData.get('condicao'),
        categoria_id: formData.get('categoria_id'),
        descricao: formData.get('descricao') || null,
        imagens: cleanUrls,
      };

      console.log('[SUBMIT] Payload:', payload);

      const response = await fetch('/api/admin/produtos', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache',
        },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Erro ao salvar produto');
      }

      console.log('[SUBMIT] ‚úÖ Produto criado com sucesso');
      window.showToast?.('Produto criado com sucesso!', 'success');

      setTimeout(() => {
        window.location.href = '/admin/produtos';
      }, 500);
    } catch (error: any) {
      console.error('[SUBMIT] ‚ùå Erro:', error);
      window.showToast?.(error.message, 'error');
      elements.submitBtn.disabled = false;
      elements.submitText.textContent = 'Adicionar Produto';
    }
  }

  // ============================================================================
  // INICIALIZA√á√ÉO
  // ============================================================================

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  /* Upload Placeholder */
  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    background: #0a0a0a;
    border-radius: 8px;
    border: 2px dashed #333;
    transition: all 0.2s;
  }
  .upload-placeholder:hover {
    border-color: #555;
    background: #111;
  }
  .upload-placeholder svg {
    color: #666;
    margin-bottom: 16px;
  }
  .upload-placeholder p {
    font-size: 14px;
    font-weight: 500;
    color: #888;
    margin-bottom: 4px;
  }
  .upload-placeholder small {
    font-size: 12px;
    color: #555;
  }

  /* Preview Grid */
  .images-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    padding: 12px;
    background: #111;
    border-radius: 8px;
    border: 1px solid #333;
  }

  /* Preview Card */
  .preview-card {
    position: relative;
    aspect-ratio: 1;
    border-radius: 6px;
    overflow: hidden;
    border: 2px solid #333;
    cursor: pointer;
    transition: all 0.2s;
    background: #000;
  }
  .preview-card.is-main {
    border-color: #3b82f6;
  }
  .preview-card:hover {
    border-color: #555;
    transform: translateY(-2px);
  }
  .preview-card.is-main:hover {
    border-color: #2563eb;
  }
  .preview-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Bot√µes */
  .remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(239, 68, 68, 0.95);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s;
  }
  .remove-btn:hover {
    background: #dc2626;
    transform: scale(1.1);
  }

  .main-badge {
    position: absolute;
    bottom: 4px;
    left: 4px;
    background: rgba(59, 130, 246, 0.95);
    color: white;
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .add-more-btn {
    aspect-ratio: 1;
    border-radius: 6px;
    border: 2px dashed #444;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: #151515;
    color: #888;
    transition: all 0.2s;
  }
  .add-more-btn:hover {
    border-color: #666;
    background: #222;
    color: #fff;
    transform: translateY(-2px);
  }
  .add-more-btn svg {
    margin-bottom: 4px;
  }
  .add-more-btn span {
    font-size: 11px;
    font-weight: 500;
  }

  /* Progress */
  .upload-progress {
    position: relative;
    height: 4px;
    background: #222;
    border-radius: 2px;
    margin-bottom: 12px;
    overflow: hidden;
  }
  .upload-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #2563eb);
    transition: width 0.3s ease;
  }
  .upload-progress-text {
    position: absolute;
    right: 8px;
    top: -20px;
    font-size: 11px;
    color: #888;
  }

  /* Hint */
  .upload-hint {
    font-size: 11px;
    color: #666;
    margin-top: 8px;
    text-align: center;
  }
</style>
