---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseAdmin } from '../../../lib/supabaseAdmin';
import '../../../styles/admin-form.css';

export const prerender = false;

const { data: categorias } = await supabaseAdmin
  .from('categorias')
  .select('*')
  .order('nome');
---

<AdminLayout
  title="Novo Produto"
  description="Adicionar novo produto ao cat√°logo"
>
  <div class="form-page">
    <div class="form-container">
      <div class="form-header">
        <a href="/admin/produtos" class="form-back-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          Voltar para Produtos
        </a>
        <h1 class="form-title">Novo Produto</h1>
        <p class="form-subtitle">Preencha as informa√ß√µes do produto</p>
      </div>

      <div class="form-card">
        <form id="product-form">
          <!-- Image Upload -->
          <div class="form-group">
            <label class="form-label">Imagens do Produto (at√© 5)</label>
            <input
              id="foto-upload"
              type="file"
              accept="image/*"
              multiple
              style="display: none;"
            />
            <div class="form-image-upload" id="upload-area">
              <div class="upload-placeholder">
                <svg
                  width="48"
                  height="48"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                <p>Clique para adicionar imagens</p>
                <small>JPG, PNG at√© 10MB cada (m√°ximo 5 imagens)</small>
              </div>
            </div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label class="form-label" for="nome">
              Nome do Produto
              <span class="form-label-required">*</span>
            </label>
            <input
              id="nome"
              name="nome"
              type="text"
              class="form-input"
              placeholder="Ex: iPhone 13 Pro Max 256GB"
              required
            />
          </div>

          <!-- C√≥digo e Pre√ßo -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="codigo">C√≥digo</label>
              <input
                id="codigo"
                name="codigo"
                type="text"
                class="form-input"
                placeholder="Ex: IP13PM256"
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="preco">
                Pre√ßo
                <span class="form-label-required">*</span>
              </label>
              <input
                id="preco"
                name="preco"
                type="text"
                inputmode="decimal"
                pattern="[0-9]*[.,]?[0-9]*"
                class="form-input"
                placeholder="0.00"
                required
              />
            </div>
          </div>

          <!-- Categoria e Condi√ß√£o -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="categoria_id">
                Categoria
                <span class="form-label-required">*</span>
              </label>
              <select
                id="categoria_id"
                name="categoria_id"
                class="form-select"
                required
              >
                <option value="">Selecione uma categoria</option>
                {
                  categorias?.map((categoria) => (
                    <option value={categoria.id}>{categoria.nome}</option>
                  ))
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="condicao">Condi√ß√£o</label>
              <select id="condicao" name="condicao" class="form-select">
                <option value="Novo">Novo</option>
                <option value="Seminovo">Seminovo</option>
              </select>
            </div>
          </div>

          <!-- Bateria -->
          <div class="form-group">
            <label class="form-label" for="bateria">Bateria (%)</label>
            <input
              id="bateria"
              name="bateria"
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              class="form-input"
              placeholder="Ex: 80"
            />
          </div>

          <!-- Descri√ß√£o -->
          <div class="form-group">
            <label class="form-label" for="descricao">Descri√ß√£o</label>
            <textarea
              id="descricao"
              name="descricao"
              class="form-textarea"
              placeholder="Descreva o produto, suas caracter√≠sticas e estado..."
            ></textarea>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <a href="/admin/produtos" class="form-btn form-btn-cancel"
              >Cancelar</a
            >
            <button
              type="submit"
              id="submit-btn"
              class="form-btn form-btn-submit"
            >
              <span id="submit-text">Adicionar Produto</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // ============================================================================
  // VERS√ÉO SIMPLIFICADA - Upload no Submit (n√£o imediato)
  // ============================================================================

  console.log('‚úÖ [NOVO PRODUTO] Script iniciado - vers√£o simplificada');

  const form = document.getElementById('product-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text') as HTMLSpanElement;
  const fileInput = document.getElementById('foto-upload') as HTMLInputElement;
  const uploadArea = document.getElementById('upload-area');

  const MAX_IMAGES = 5;
  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

  // Array SIMPLES de arquivos selecionados
  let selectedFiles: File[] = [];

  function resetCompleteState() {
    console.log('üßπ [RESET] Iniciando reset completo do estado');

    // 1. Limpar arrays
    selectedFiles = [];
    cleanupBlobUrls();
    blobUrls = [];

    // 2. Limpar DOM
    if (uploadArea) {
      uploadArea.innerHTML = `
      <div class="upload-placeholder">
        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
          </path>
        </svg>
        <p>Clique para adicionar imagens</p>
        <small>JPG, PNG at√© 10MB cada (m√°ximo 5 imagens)</small>
      </div>
    `;
    }

    // 3. Resetar input file
    if (fileInput) {
      fileInput.value = '';
    }

    // 4. Limpar fun√ß√µes globais
    if ((window as any).removeImageAt) {
      delete (window as any).removeImageAt;
    }
    if ((window as any).setMainImage) {
      delete (window as any).setMainImage;
    }

    console.log('‚úÖ [RESET] Estado completamente resetado');
  }

  // Estado do formul√°rio
  let formDirty = false;
  let isSubmitting = false;

  // ============================================================================
  // GEST√ÉO DE BLOB URLs
  // ============================================================================

  let blobUrls: string[] = []; // Precisa ser 'let' para poder limpar (blobUrls = [])

  function cleanupBlobUrls() {
    console.log(`üßπ [CLEANUP] Limpando ${blobUrls.length} Blob URLs`);
    blobUrls.forEach((url, index) => {
      console.log(`   ${index + 1}. Revogando: ${url.substring(0, 50)}...`);
      URL.revokeObjectURL(url);
    });
    blobUrls.length = 0;
    console.log('‚úÖ [CLEANUP] Todas as Blob URLs foram revogadas');
  }

  // ============================================================================
  // RENDERIZA√á√ÉO DE PREVIEW (Blob URLs locais - SEM upload)
  // ============================================================================

  function renderPreviews() {
    if (!uploadArea) return;

    // Limpar URLs antigas
    cleanupBlobUrls();

    console.log(`üñºÔ∏è [PREVIEW] Renderizando ${selectedFiles.length} imagens`);

    if (selectedFiles.length === 0) {
      uploadArea.innerHTML = `
        <div class="upload-placeholder">
          <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
            </path>
          </svg>
          <p>Clique para adicionar imagens</p>
          <small>JPG, PNG at√© 10MB cada (m√°ximo 5 imagens)</small>
        </div>
      `;
      return;
    }

    // Criar HTML para cada imagem
    const imagesHTML = selectedFiles
      .map((file, index) => {
        // CRIAR BLOB URL NOVO para cada arquivo
        const blobUrl = URL.createObjectURL(file);
        blobUrls.push(blobUrl);

        console.log(
          `  üì∏ [${index + 1}] ${file.name} - ${(file.size / 1024).toFixed(1)}KB - URL: ${blobUrl}`
        );

        const isMain = index === 0;

        return `
        <div style="position: relative; aspect-ratio: 1 / 1; border-radius: 8px; overflow: hidden; border: 2px solid ${isMain ? '#3b82f6' : '#e5e7eb'}; background: #1a1a1a; cursor: ${isMain ? 'default' : 'pointer'}; transition: all 0.2s;"
          ${!isMain ? `onclick="event.stopPropagation(); window.setMainImage(${index})"` : ''}
          title="${isMain ? 'Imagem principal' : 'Clique para tornar principal'}"
        >
          <img
            src="${blobUrl}"
            alt="${file.name}"
            style="width: 100%; height: 100%; object-fit: cover; object-position: center; display: block;"
            loading="eager"
          />
          <button
            type="button"
            onclick="event.stopPropagation(); event.preventDefault(); window.removeImageAt(${index})"
            style="position: absolute; top: 6px; right: 6px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; min-width: 20px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: bold; line-height: 1; padding: 0; z-index: 10;"
            title="Remover imagem"
          >√ó</button>
          ${isMain ? '<span style="position: absolute; bottom: 6px; left: 6px; background: rgba(59, 130, 246, 0.95); color: white; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600; z-index: 5;">Principal</span>' : ''}
        </div>
      `;
      })
      .join('');

    // Bot√£o de adicionar mais
    const addButtonHTML =
      selectedFiles.length < MAX_IMAGES
        ? `
      <div style="aspect-ratio: 1 / 1; border-radius: 8px; border: 2px dashed #d1d5db; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: #0A0A0A; transition: all 0.2s;"
        onmouseover="this.style.borderColor='#f9fafb'; this.style.background='#121212'"
        onmouseout="this.style.borderColor='#d1d5db'; this.style.background='#0A0A0A'"
      >
        <svg style="width: 32px; height: 32px; color: #f9fafb; margin-bottom: 6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span style="font-size: 12px; color: #f9fafb; font-weight: 500;">Adicionar</span>
      </div>
    `
        : '';

    uploadArea.innerHTML = `
      <div class="images-preview-grid">
        ${imagesHTML}
        ${addButtonHTML}
      </div>
    `;
  }

  // ============================================================================
  // HANDLERS
  // ============================================================================

  (window as any).removeImageAt = (index: number) => {
    console.log(
      `üóëÔ∏è [REMOVE] Removendo imagem ${index + 1}: ${selectedFiles[index]?.name}`
    );
    selectedFiles.splice(index, 1);
    renderPreviews();
    window.showToast('Imagem removida', 'success');
  };

  (window as any).setMainImage = (index: number) => {
    if (index === 0) return;
    console.log(`‚≠ê [MAIN] Tornando imagem ${index + 1} como principal`);
    const [selected] = selectedFiles.splice(index, 1);
    selectedFiles.unshift(selected);
    renderPreviews();
    window.showToast('Imagem principal alterada', 'success');
  };

  // Click na √°rea de upload
  uploadArea?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.closest('button')) return;

    if (selectedFiles.length < MAX_IMAGES) {
      fileInput?.click();
    } else {
      window.showToast(`M√°ximo de ${MAX_IMAGES} imagens`, 'warning');
    }
  });

  // Sele√ß√£o de arquivos
  fileInput?.addEventListener('change', (e) => {
    const input = e.target as HTMLInputElement;
    const files = input.files;
    if (!files || files.length === 0) return;

    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log(`üìÅ [SELE√á√ÉO] ${files.length} arquivo(s) selecionado(s)`);

    const remainingSlots = MAX_IMAGES - selectedFiles.length;
    const filesToAdd = Array.from(files).slice(0, remainingSlots);

    for (const file of filesToAdd) {
      console.log(
        `  üìÑ ${file.name}: ${(file.size / 1024).toFixed(1)}KB, tipo: ${file.type}`
      );

      // Validar tamanho
      if (file.size > MAX_FILE_SIZE) {
        window.showToast(`${file.name} √© muito grande (m√°x 10MB)`, 'error');
        continue;
      }

      // Validar tipo
      if (!file.type.startsWith('image/')) {
        window.showToast(`${file.name} n√£o √© uma imagem`, 'error');
        continue;
      }

      selectedFiles.push(file);
    }

    console.log(
      `üìÅ [SELE√á√ÉO] Total ap√≥s adicionar: ${selectedFiles.length} imagens`
    );
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    // Limpar input para permitir selecionar mesmo arquivo novamente
    input.value = '';

    renderPreviews();

    if (filesToAdd.length > 0) {
      window.showToast(
        `${filesToAdd.length} imagem(ns) adicionada(s)`,
        'success'
      );
    }
  });

  // ============================================================================
  // FUN√á√ÉO DE UPLOAD - TODAS AS IMAGENS EM UMA REQUISI√á√ÉO
  // Safari iOS compatible version
  // ============================================================================

  // Detectar Safari iOS
  const isSafariIOS =
    /iPad|iPhone|iPod/.test(navigator.userAgent) &&
    !('MSStream' in window) &&
    /Safari/.test(navigator.userAgent);

  console.log(
    `üîç [BROWSER] Safari iOS: ${isSafariIOS}, UA: ${navigator.userAgent.substring(0, 100)}`
  );

  // ============================================================================
  // FIX BUG 2.1 + FIX 413: Compress√£o que RESPEITA EXIF
  // Biblioteca browser-image-compression respeita orienta√ß√£o EXIF e comprime eficientemente
  // ============================================================================

  // Importar biblioteca que respeita EXIF
  const imageCompression = (await import('browser-image-compression')).default;

  /**
   * Comprime imagem respeitando orienta√ß√£o EXIF (fotos mobile)
   * Resolve erro 413 (Vercel 4.5MB limit) sem perder orienta√ß√£o correta
   */
  async function compressImage(file: File): Promise<File> {
    console.log(`   üì∏ Original: ${(file.size / 1024 / 1024).toFixed(2)}MB`);

    const options = {
      maxSizeMB: 3, // M√°ximo 3MB ap√≥s compress√£o (seguro para Vercel)
      maxWidthOrHeight: 1920, // Redimensionar se maior que 1920px
      useWebWorker: true, // Usar Web Worker para n√£o bloquear UI
      fileType: 'image/jpeg', // Converter para JPEG
      initialQuality: 0.85, // Qualidade 85% (√≥timo balan√ßo)
      alwaysKeepResolution: false,
      exifOrientation: undefined, // AUTO - respeita EXIF automaticamente!
    };

    try {
      const compressedFile = await imageCompression(file, options);
      console.log(
        `   ‚úÖ Comprimido: ${(compressedFile.size / 1024 / 1024).toFixed(2)}MB (${Math.round((compressedFile.size / file.size) * 100)}%)`
      );

      // Validar que n√£o ficou muito grande (Vercel limit)
      if (compressedFile.size > 4 * 1024 * 1024) {
        console.warn(
          `   ‚ö†Ô∏è Arquivo ainda muito grande ap√≥s compress√£o, tentando compress√£o mais agressiva...`
        );
        // Tentar compress√£o mais agressiva
        const aggressiveOptions = {
          ...options,
          maxSizeMB: 2,
          initialQuality: 0.75,
        };
        const recompressed = await imageCompression(
          compressedFile,
          aggressiveOptions
        );
        console.log(
          `   ‚úÖ Re-comprimido: ${(recompressed.size / 1024 / 1024).toFixed(2)}MB`
        );
        return recompressed;
      }

      return compressedFile;
    } catch (error: any) {
      console.error(`   ‚ùå Erro ao comprimir:`, error);
      throw new Error(`Falha ao comprimir imagem: ${error.message}`);
    }
  }

  // Helper para parsear JSON de forma segura (Safari retorna erro gen√©rico)
  async function safeJsonParse(response: Response): Promise<any> {
    let text = '';
    try {
      text = await response.text();
    } catch (readError: any) {
      console.error('‚ùå Erro ao ler resposta:', readError.message);
      throw new Error(`Erro ao ler resposta: ${readError.message}`);
    }

    console.log(
      `üì• [RESPONSE] Status: ${response.status}, Tamanho: ${text.length} chars`
    );

    // Se a resposta estiver vazia, retornar erro claro
    if (!text || text.trim() === '') {
      console.error('‚ùå Resposta vazia do servidor. Status:', response.status);
      throw new Error(`Erro ${response.status}: resposta vazia`);
    }

    // Verificar se parece HTML (erro de servidor)
    if (text.trim().startsWith('<!') || text.trim().startsWith('<html')) {
      console.error(
        '‚ùå Servidor retornou HTML em vez de JSON:',
        text.substring(0, 300)
      );
      // Tentar extrair mensagem de erro do HTML
      const titleMatch = text.match(/<title>([^<]+)<\/title>/i);
      const errorMsg = titleMatch ? titleMatch[1] : 'Erro no servidor';
      throw new Error(`${response.status}: ${errorMsg}`);
    }

    try {
      return JSON.parse(text);
    } catch (e) {
      console.error('‚ùå Erro ao parsear JSON:', text.substring(0, 500));
      // Mostrar parte da resposta no erro para debug
      const preview = text.substring(0, 100).replace(/\s+/g, ' ');
      throw new Error(`Erro ${response.status}: ${preview}...`);
    }
  }

  async function uploadAllImages(files: File[]): Promise<string[]> {
    const batchId = `${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log(`üì§ [BATCH UPLOAD] ID: ${batchId}`);
    console.log(`üì§ [BATCH UPLOAD] ${files.length} arquivos para enviar`);
    console.log(`üì§ [BATCH UPLOAD] Safari iOS: ${isSafariIOS}`);

    // Criar FormData com TODOS os arquivos
    const formData = new FormData();

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const fileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');

      console.log(`   üìÅ Processando ${i + 1}/${files.length}: ${file.name}`);

      try {
        // FIX 413: Comprimir COM respeito a EXIF (biblioteca browser-image-compression)
        const compressedFile = await compressImage(file);
        const uniqueFileName = `${Date.now()}_${Math.random().toString(36).substring(2, 10)}_${fileName.replace(/\.[^.]+$/, '.jpg')}`;
        console.log(`   üìù Nome √∫nico gerado: ${uniqueFileName}`);
        formData.append(`file${i}`, compressedFile, uniqueFileName);
      } catch (compressError: any) {
        console.error(`   ‚ùå Erro ao comprimir ${file.name}:`, compressError);
        // Se compress√£o falhar, validar tamanho antes de enviar original
        if (file.size > 4 * 1024 * 1024) {
          throw new Error(
            `Imagem ${file.name} muito grande (${(file.size / 1024 / 1024).toFixed(1)}MB). M√°ximo 4MB.`
          );
        }
        formData.append(`file${i}`, file, fileName);
      }
    }

    // UMA √öNICA requisi√ß√£o para todas as imagens
    const url = `/api/admin/upload?batch=${batchId}`;
    console.log(`üì§ [BATCH UPLOAD] Enviando para: ${url}`);

    let response: Response;
    try {
      response = await fetch(url, {
        method: 'POST',
        body: formData,
        credentials: 'include', // Importante para Safari iOS enviar cookies
      });
      console.log(
        `üì• [BATCH UPLOAD] Resposta recebida: ${response.status} ${response.statusText}`
      );
    } catch (fetchError: any) {
      console.error('‚ùå [BATCH UPLOAD] Erro de rede:', fetchError.message);
      throw new Error(`Erro de conex√£o: ${fetchError.message}`);
    }

    if (!response.ok) {
      console.error(`‚ùå [BATCH UPLOAD] Resposta n√£o OK: ${response.status}`);
      const error = await safeJsonParse(response);
      throw new Error(error.error || `Erro no upload (${response.status})`);
    }

    const result = await safeJsonParse(response);

    console.log(`‚úÖ [BATCH UPLOAD] Sucesso!`);
    console.log(`   ${result.count} imagens processadas`);
    result.urls.forEach((url: string, i: number) => {
      console.log(`   URL ${i + 1}: ${url}`);
    });
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    if (result.errors && result.errors.length > 0) {
      console.warn('‚ö†Ô∏è Alguns erros:', result.errors);
    }

    return result.urls;
  }

  // ============================================================================
  // SUBMIT DO FORMUL√ÅRIO
  // ============================================================================

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (selectedFiles.length === 0) {
      window.showToast('Adicione pelo menos uma imagem', 'warning');
      return;
    }

    isSubmitting = true;
    submitBtn.disabled = true;
    submitText.innerHTML =
      '<div class="form-spinner"></div> Enviando imagens...';

    try {
      console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      console.log('üíæ [SUBMIT] Iniciando salvamento');
      console.log(`üì∏ [SUBMIT] ${selectedFiles.length} imagens para enviar`);

      // Upload de TODAS as imagens em UMA requisi√ß√£o
      const uploadedUrls = await uploadAllImages(selectedFiles);

      if (uploadedUrls.length === 0) {
        throw new Error('Nenhuma imagem foi enviada com sucesso');
      }

      console.log(
        `‚úÖ [SUBMIT] ${uploadedUrls.length} imagens enviadas com sucesso`
      );

      // Preparar dados do produto
      submitText.innerHTML =
        '<div class="form-spinner"></div> Salvando produto...';

      const formData = new FormData(form);

      // Converter v√≠rgula para ponto no pre√ßo (compatibilidade com locale BR)
      const precoStr = ((formData.get('preco') as string) || '').replace(
        ',',
        '.'
      );
      const bateriaStr = formData.get('bateria') as string;

      const produto = {
        nome: formData.get('nome'),
        codigo: formData.get('codigo') || null,
        preco: parseFloat(precoStr) || 0,
        bateria: bateriaStr ? parseInt(bateriaStr, 10) : null,
        condicao: formData.get('condicao'),
        categoria_id: formData.get('categoria_id'),
        descricao: formData.get('descricao') || null,
        imagens: uploadedUrls,
      };

      console.log('üì¶ [SUBMIT] Salvando produto:', produto);

      // Salvar produto
      const response = await fetch('/api/admin/produtos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(produto),
        credentials: 'include', // Importante para Safari iOS enviar cookies
      });

      if (!response.ok) {
        const error = await safeJsonParse(response);
        throw new Error(error.error || 'Erro ao salvar produto');
      }

      console.log('‚úÖ [SUBMIT] Produto salvo com sucesso!');

      // ============================================================================
      // FIX BUG CR√çTICO: Limpar TODO o estado ANTES de redirecionar
      // ============================================================================
      console.log('üßπ [SUBMIT] Executando limpeza completa...');

      // Chamar fun√ß√£o de reset completo
      resetCompleteState();

      window.showToast('Produto adicionado com sucesso!', 'success');

      // Delay para garantir limpeza completa antes de redirecionar
      setTimeout(() => {
        window.location.href = `/admin/produtos?_t=${Date.now()}`;
      }, 500); // Aumentado de 100ms para 500ms

      console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

      window.showToast('Produto adicionado com sucesso!', 'success');

      // FIX BUG 3.1: Limpar estado ANTES de redirecionar
      console.log('üßπ [SUBMIT] Limpando estado de imagens...');
      selectedFiles = [];
      cleanupBlobUrls();
      blobUrls = [];

      // Limpar preview do DOM
      const previewContainer = document.getElementById('imagens-preview');
      if (previewContainer) {
        previewContainer.innerHTML = '';
      }

      // Pequeno delay para garantir que limpeza foi feita
      setTimeout(() => {
        window.location.href = `/admin/produtos?_t=${Date.now()}`;
      }, 100);
    } catch (error: any) {
      console.error('‚ùå [SUBMIT] Erro:', error);
      const errorMsg = error.message || 'Erro ao salvar produto';

      // ============================================================================
      // FIX BUG: Limpar Blob URLs mas MANTER dados do form
      // ============================================================================
      console.log(
        'üßπ [SUBMIT] Limpando Blob URLs ap√≥s erro (mantendo form)...'
      );

      // Apenas limpar Blob URLs antigas
      cleanupBlobUrls();
      blobUrls = [];

      // Re-renderizar preview com novas Blob URLs
      // (selectedFiles √© mantido para o usu√°rio poder tentar novamente)
      renderPreviews();

      window.showToast(errorMsg, 'error');
      isSubmitting = false;
      submitBtn.disabled = false;
      submitText.textContent = 'Adicionar Produto';
    }
  });

  // ============================================================================
  // PROTE√á√ÉO CONTRA RELOAD
  // ============================================================================

  form?.addEventListener('input', () => {
    formDirty = true;
  });

  // FIX BUG 3.3: Limpar estado ao sair da p√°gina
  window.addEventListener('beforeunload', (e) => {
    // Limpar estado sempre ao sair
    console.log('üßπ [CLEANUP] beforeunload - Limpando estado');
    resetCompleteState();

    // Avisar sobre altera√ß√µes n√£o salvas
    if ((formDirty || selectedFiles.length > 0) && !isSubmitting) {
      e.preventDefault();
      e.returnValue = 'Voc√™ tem altera√ß√µes n√£o salvas. Deseja realmente sair?';
      return e.returnValue;
    }
  });

  // Limpar ao sair (pagehide √© mais confi√°vel que unload)
  window.addEventListener('pagehide', () => {
    console.log('üßπ [CLEANUP] pagehide - Limpando estado');
    resetCompleteState();
  });

  // Limpar blob URLs ao sair (pagehide √© mais confi√°vel que unload)
  window.addEventListener('pagehide', () => {
    cleanupBlobUrls();
    selectedFiles = [];
    blobUrls = [];
  });

  // Renderizar estado inicial
  renderPreviews();
</script>

<style>
  .upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
  }

  .upload-placeholder svg {
    color: #9ca3af;
    margin-bottom: 16px;
  }

  .upload-placeholder p {
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 4px;
  }

  .upload-placeholder small {
    font-size: 12px;
    color: #9ca3af;
  }
</style>

<style is:global>
  #upload-area:has(.images-preview-grid),
  .form-image-upload:has(.images-preview-grid) {
    display: block !important;
    min-height: auto !important;
    padding: 0 !important;
  }

  .images-preview-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 12px;
    padding: 16px;
  }

  @media (min-width: 768px) {
    .images-preview-grid {
      grid-template-columns: repeat(5, 1fr) !important;
    }
  }
</style>
