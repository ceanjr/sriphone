---
import Layout from '../../layouts/Layout.astro';
import '../../styles/pages/admin/login.css';
import { verifyAuth } from '../../lib/auth';

// Se j√° est√° autenticado, redirecionar para dashboard
const isAuthenticated = await verifyAuth(
  Astro.cookies,
  Astro.request.headers.get('Authorization'),
);

if (isAuthenticated) {
  return Astro.redirect('/admin/dashboard');
}
---

<Layout
  title="Admin Login - Sr. IPHONE VCA"
  description="√Årea administrativa do cat√°logo Sr. IPHONE VCA"
>
  <div class="login-page">
    <div class="login-container">
      <!-- Bot√£o Voltar -->
      <a
        href="/"
        class="login-back-btn"
        aria-label="Voltar para p√°gina inicial"
      >
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M19 12H5M5 12L12 19M5 12L12 5"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
        Voltar
      </a>

      <!-- Logo -->
      <div class="login-logo-section">
        <img
          src="/images/logo-fundo.webp"
          alt="Sr. IPHONE VCA"
          class="login-logo"
        />
        <h1 class="login-title">Admin - Sr. IPHONE VCA</h1>
        <p class="login-subtitle">√Årea administrativa do cat√°logo</p>
      </div>

      <!-- Login Form -->
      <div class="login-form-wrapper">
        <h2 class="login-form-title">Entrar no Painel</h2>

        <form id="login-form" class="login-form">
          <div class="login-form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="seu@email.com"
              autocomplete="email"
            />
          </div>

          <div class="login-form-group">
            <label for="password">Senha</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              autocomplete="current-password"
            />
          </div>

          <div id="error-message" class="login-error-message"></div>

          <button type="submit" id="submit-btn" class="login-submit-btn">
            Entrar
          </button>
        </form>
      </div>

      <p class="login-footer">
        ¬© 2024 Sr. IPHONE VCA. Todos os direitos reservados.
      </p>
    </div>
  </div>
</Layout>

<script>
  import { authService } from '../../lib/supabase';

  // Log para confirmar que o script foi carregado
  console.log('‚úÖ [LOGIN PAGE] Script carregado e executando');
  console.log('üìç [LOGIN PAGE] URL atual:', window.location.href);
  console.log('üïê [LOGIN PAGE] Timestamp:', new Date().toISOString());

  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorMessage = document.getElementById(
    'error-message',
  ) as HTMLDivElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  console.log('üîç [LOGIN PAGE] Elementos encontrados:', {
    form: form ? 'OK' : 'ERRO',
    errorMessage: errorMessage ? 'OK' : 'ERRO',
    submitBtn: submitBtn ? 'OK' : 'ERRO'
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    // Valida√ß√£o b√°sica
    if (!email || !password) {
      showError('Por favor, preencha todos os campos.');
      return;
    }

    // Hide error message
    hideError();

    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Entrando...';

    let loginSuccessful = false;

    try {
      console.log('üîê [LOGIN] Iniciando processo de login...');
      console.log('üìß [LOGIN] Email:', email);

      // 1. Fazer login usando o authService (salva no localStorage)
      console.log('üìù [LOGIN] Passo 1/3: Autenticando com Supabase...');
      const authResult = await authService.signIn(email, password);
      console.log('‚úÖ [LOGIN] Passo 1/3: Autentica√ß√£o Supabase conclu√≠da');
      console.log('üîë [LOGIN] Session recebida:', authResult.session ? 'SIM' : 'N√ÉO');

      // 2. Chamar API para salvar cookies no servidor
      console.log('üç™ [LOGIN] Passo 2/3: Salvando sess√£o no servidor...');
      const response = await fetch('/api/admin/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include', // Importante para enviar/receber cookies
        body: JSON.stringify({ email, password }),
      });

      console.log('üì• [LOGIN] Resposta da API:', response.status, response.statusText);

      if (!response.ok) {
        const error = await response.json();
        console.error('‚ùå [LOGIN] Erro na API:', error);
        throw new Error(error.error || 'Erro ao fazer login');
      }

      const result = await response.json();
      console.log('‚úÖ [LOGIN] Passo 2/3: Sess√£o salva no servidor');
      console.log('üì¶ [LOGIN] Resultado:', result);

      // 3. Sucesso! Marcar como bem-sucedido
      loginSuccessful = true;
      console.log('üéâ [LOGIN] Passo 3/3: Login conclu√≠do com sucesso!');

      // 4. For√ßar redirecionamento com m√∫ltiplos fallbacks
      console.log('üöÄ [LOGIN] Iniciando redirecionamento para /admin/dashboard...');
      submitBtn.textContent = 'Redirecionando...';

      // M√©todo 1: window.location.replace (preferido)
      window.location.replace('/admin/dashboard');

      // Fallback 1: Se n√£o redirecionar em 1 segundo, tentar window.location.href
      setTimeout(() => {
        console.log('‚ö†Ô∏è [LOGIN] Fallback 1: Usando window.location.href...');
        window.location.href = '/admin/dashboard';
      }, 1000);

      // Fallback 2: Se ainda n√£o redirecionar em 2 segundos, for√ßar reload
      setTimeout(() => {
        console.log('‚ö†Ô∏è [LOGIN] Fallback 2: For√ßando redirect com assign...');
        window.location.assign('/admin/dashboard');
      }, 2000);

    } catch (error: any) {
      console.error('‚ùå [LOGIN] Erro capturado:', error);
      console.error('‚ùå [LOGIN] Stack trace:', error.stack);

      // Se o login foi bem-sucedido mas o redirecionamento falhou
      if (loginSuccessful) {
        console.log('‚ö†Ô∏è [LOGIN] Login OK, mas redirecionamento falhou. Tentando novamente...');
        window.location.href = '/admin/dashboard';
        return;
      }

      // Mensagens de erro mais amig√°veis
      let errorMsg = 'Erro ao fazer login. Verifique suas credenciais.';

      if (error.message?.includes('Invalid login credentials')) {
        errorMsg = 'Email ou senha incorretos.';
      } else if (error.message?.includes('Email not confirmed')) {
        errorMsg = 'Email n√£o confirmado. Verifique sua caixa de entrada.';
      } else if (error.message?.includes('Network')) {
        errorMsg = 'Erro de conex√£o. Verifique sua internet.';
      } else {
        // Incluir mensagem de erro t√©cnica para debug
        errorMsg += ` (${error.message})`;
      }

      showError(errorMsg);

      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.textContent = 'Entrar';
    }
  });

  function showError(message: string) {
    errorMessage.textContent = message;
    errorMessage.classList.add('show');
  }

  function hideError() {
    errorMessage.textContent = '';
    errorMessage.classList.remove('show');
  }

  // Limpar erro ao digitar
  const inputs = form?.querySelectorAll('input');
  inputs?.forEach((input) => {
    input.addEventListener('input', hideError);
  });
</script>
