---
import Layout from '../../layouts/Layout.astro';
import '../../styles/pages/admin/login.css';
---

<Layout
  title="Admin Login - Sr. IPHONE VCA"
  description="Área administrativa do catálogo Sr. IPHONE VCA"
>
  <div class="login-page">
    <div class="login-container">
      <!-- Logo -->
      <div class="login-logo-section">
        <img
          src="/images/logo-fundo.webp"
          alt="Sr. IPHONE VCA"
          class="login-logo"
        />
        <h1 class="login-title">Admin - Sr. IPHONE VCA</h1>
        <p class="login-subtitle">Área administrativa do catálogo</p>
      </div>

      <!-- Login Form -->
      <div class="login-form-wrapper">
        <h2 class="login-form-title">Entrar no Painel</h2>

        <form id="login-form" class="login-form">
          <div class="login-form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="seu@email.com"
              autocomplete="email"
            />
          </div>

          <div class="login-form-group">
            <label for="password">Senha</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              placeholder="••••••••"
              autocomplete="current-password"
            />
          </div>

          <div id="error-message" class="login-error-message"></div>

          <button type="submit" id="submit-btn" class="login-submit-btn">
            Entrar
          </button>
        </form>
      </div>

      <p class="login-footer">
        © 2024 Sr. IPHONE VCA. Todos os direitos reservados.
      </p>
    </div>
  </div>
</Layout>

<script>
  import { authService } from '../../lib/supabase';

  // Verificar se já está autenticado ao carregar a página
  async function checkIfAlreadyAuthenticated() {
    try {
      const isAuth = await authService.isAuthenticated();
      // Só redireciona se realmente estiver autenticado (sessão válida)
      if (isAuth) {
        window.location.href = '/admin/dashboard';
      }
    } catch (error) {
      // Não faz nada se não estiver autenticado
      // Apenas loga o erro para debug
      console.error('Erro ao verificar autenticação:', error);
    }
  }

  // Executar verificação imediatamente, mas apenas se não houver tentativa de login em andamento
  if (!localStorage.getItem('sb-auth-token')) {
    checkIfAlreadyAuthenticated();
  }

  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorMessage = document.getElementById(
    'error-message',
  ) as HTMLDivElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    // Validação básica
    if (!email || !password) {
      showError('Por favor, preencha todos os campos.');
      return;
    }

    // Hide error message
    hideError();

    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Entrando...';

    try {
      // Fazer login usando o authService
      await authService.signIn(email, password);

      // Aguardar um pouco para garantir que a sessão foi salva
      await new Promise((resolve) => setTimeout(resolve, 300));

      // Verificar se realmente está autenticado
      const isAuth = await authService.isAuthenticated();

      if (isAuth) {
        // Sucesso! Redirecionar para dashboard
        window.location.href = '/admin/dashboard';
      } else {
        throw new Error('Falha ao estabelecer sessão');
      }
    } catch (error: any) {
      console.error('Erro no login:', error);

      // Mensagens de erro mais amigáveis
      let errorMsg = 'Erro ao fazer login. Verifique suas credenciais.';

      if (error.message?.includes('Invalid login credentials')) {
        errorMsg = 'Email ou senha incorretos.';
      } else if (error.message?.includes('Email not confirmed')) {
        errorMsg = 'Email não confirmado. Verifique sua caixa de entrada.';
      } else if (error.message?.includes('Network')) {
        errorMsg = 'Erro de conexão. Verifique sua internet.';
      }

      showError(errorMsg);

      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.textContent = 'Entrar';
    }
  });

  function showError(message: string) {
    errorMessage.textContent = message;
    errorMessage.classList.add('show');
  }

  function hideError() {
    errorMessage.textContent = '';
    errorMessage.classList.remove('show');
  }

  // Limpar erro ao digitar
  const inputs = form?.querySelectorAll('input');
  inputs?.forEach((input) => {
    input.addEventListener('input', hideError);
  });
</script>
