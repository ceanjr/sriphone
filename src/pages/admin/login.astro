---
import Layout from '../../layouts/Layout.astro';
import '../../styles/pages/admin/login.css';

export const prerender = false;

// Nota: O middleware jÃ¡ gerencia redirecionamentos de usuÃ¡rios autenticados
// Aqui apenas renderizamos a pÃ¡gina de login sem lÃ³gica de redirecionamento
// para evitar loops de redirecionamento no Safari

console.log('[Login Page SSR] Renderizando pÃ¡gina de login');

// Limpar cookies incompletos/invÃ¡lidos no cliente via script
// Isso evita problemas de sincronizaÃ§Ã£o entre SSR e cliente
---

<Layout
  title="Admin Login - Sr. IPHONE VCA"
  description="Ãrea administrativa do catÃ¡logo Sr. IPHONE VCA"
>
  <div class="login-page">
    <div class="login-container">
      <!-- BotÃ£o Voltar -->
      <a
        href="/"
        class="login-back-btn"
        aria-label="Voltar para pÃ¡gina inicial"
      >
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M19 12H5M5 12L12 19M5 12L12 5"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
        Voltar
      </a>

      <!-- Logo -->
      <div class="login-logo-section">
        <img
          src="/images/logo-fundo.webp"
          alt="Sr. IPHONE VCA"
          class="login-logo"
        />
        <h1 class="login-title">Admin - Sr. IPHONE VCA</h1>
        <p class="login-subtitle">Ãrea administrativa do catÃ¡logo</p>
      </div>

      <!-- Login Form -->
      <div class="login-form-wrapper">
        <h2 class="login-form-title">Entrar no Painel</h2>

        <form id="login-form" class="login-form">
          <div class="login-form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="seu@email.com"
              autocomplete="email"
            />
          </div>

          <div class="login-form-group">
            <label for="password">Senha</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              autocomplete="current-password"
            />
          </div>

          <div id="error-message" class="login-error-message"></div>

          <button type="submit" id="submit-btn" class="login-submit-btn">
            Entrar
          </button>
        </form>
      </div>

      <p class="login-footer">
        Â© 2024 Sr. IPHONE VCA. Todos os direitos reservados.
      </p>
    </div>
  </div>

  <!-- Script de limpeza e diagnÃ³stico - DEVE executar SEMPRE -->
  <script is:inline>
    (function() {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ” [LOGIN INIT] Script iniciado');
      console.log('ğŸ” [LOGIN INIT] Timestamp:', new Date().toISOString());
      console.log('ğŸ” [LOGIN INIT] URL:', window.location.href);

      // IMPORTANTE: Limpar TODOS os tokens antigos do localStorage
      // Esses tokens podem causar conflitos com a autenticaÃ§Ã£o baseada em cookies
      console.log('ğŸ§¹ [LOGIN INIT] Limpando tokens antigos do localStorage...');

      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('sb-')) {
          keysToRemove.push(key);
        }
      }

      if (keysToRemove.length > 0) {
        console.log('ğŸ§¹ [LOGIN INIT] Removendo', keysToRemove.length, 'token(s) antigo(s):', keysToRemove);
        keysToRemove.forEach(function(key) {
          localStorage.removeItem(key);
        });
        console.log('âœ… [LOGIN INIT] Tokens antigos removidos');
      } else {
        console.log('âœ… [LOGIN INIT] Nenhum token antigo encontrado');
      }

      // Limpar cookies incompletos/invÃ¡lidos para evitar loops
      console.log('ğŸ§¹ [LOGIN INIT] Verificando cookies...');
      var cookies = document.cookie.split(';');
      var hasAccessToken = false;
      var hasRefreshToken = false;

      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.startsWith('sb-access-token=')) hasAccessToken = true;
        if (cookie.startsWith('sb-refresh-token=')) hasRefreshToken = true;
      }

      // Se tem apenas um dos cookies (incompleto), limpar tudo
      if ((hasAccessToken && !hasRefreshToken) || (!hasAccessToken && hasRefreshToken)) {
        console.log('ğŸ§¹ [LOGIN INIT] Cookies incompletos detectados, limpando...');
        document.cookie = 'sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';
        document.cookie = 'sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';
        document.cookie = 'sb-expires-at=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';
        console.log('âœ… [LOGIN INIT] Cookies limpos');
      }

      // Log de cookies atuais
      console.log('ğŸª [LOGIN INIT] Cookies atuais:', document.cookie || 'NENHUM');

      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    })();
  </script>

  <script>
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('âœ… [LOGIN SCRIPT] Script do formulÃ¡rio carregado!');
    console.log('ğŸ“ [LOGIN SCRIPT] URL:', window.location.href);
    console.log('ğŸ• [LOGIN SCRIPT] Timestamp:', new Date().toISOString());
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    const form = document.getElementById('login-form') as HTMLFormElement;
    const errorMessage = document.getElementById('error-message') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    console.log('ğŸ” [LOGIN SCRIPT] Elementos do formulÃ¡rio:', {
      form: form ? 'âœ… Encontrado' : 'âŒ NÃƒO encontrado',
      errorMessage: errorMessage ? 'âœ… Encontrado' : 'âŒ NÃƒO encontrado',
      submitBtn: submitBtn ? 'âœ… Encontrado' : 'âŒ NÃƒO encontrado'
    });

    if (!form || !errorMessage || !submitBtn) {
      console.error('âŒ [LOGIN SCRIPT] ERRO CRÃTICO: Elementos do formulÃ¡rio nÃ£o encontrados!');
      console.error('âŒ [LOGIN SCRIPT] Verifique se os IDs estÃ£o corretos no HTML');
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸš€ [LOGIN] FormulÃ¡rio submetido!');

      const formData = new FormData(form);
      const email = formData.get('email') as string;
      const password = formData.get('password') as string;

      console.log('ğŸ“§ [LOGIN] Email:', email);
      console.log('ğŸ” [LOGIN] Senha:', password ? '***' : 'VAZIO');

      // ValidaÃ§Ã£o bÃ¡sica
      if (!email || !password) {
        console.warn('âš ï¸ [LOGIN] ValidaÃ§Ã£o falhou: campos vazios');
        showError('Por favor, preencha todos os campos.');
        return;
      }

      // Hide error message
      hideError();

      // Disable button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Entrando...';
      console.log('â³ [LOGIN] BotÃ£o desabilitado, iniciando login...');

      try {
        console.log('ğŸª [LOGIN] Chamando API /api/admin/auth/login...');

        const response = await fetch('/api/admin/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include', // CRÃTICO: Enviar e receber cookies
          body: JSON.stringify({ email, password }),
        });

        console.log('ğŸ“¥ [LOGIN] Resposta recebida:', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok
        });

        if (!response.ok) {
          const error = await response.json();
          console.error('âŒ [LOGIN] Erro na resposta:', error);
          throw new Error(error.error || 'Erro ao fazer login');
        }

        const result = await response.json();
        console.log('âœ… [LOGIN] Login bem-sucedido!');
        console.log('ğŸ“¦ [LOGIN] Dados retornados:', {
          success: result.success,
          hasUser: !!result.user,
          hasSession: !!result.session
        });

        // Sucesso! Preparar redirecionamento
        submitBtn.textContent = 'Sucesso! Redirecionando...';
        console.log('ğŸ‰ [LOGIN] Aguardando 500ms para garantir cookies salvos...');

        // Aguardar cookies serem salvos
        await new Promise(resolve => setTimeout(resolve, 500));

        console.log('ğŸš€ [LOGIN] Redirecionando para /admin/dashboard...');

        // ForÃ§ar redirect completo
        window.location.href = '/admin/dashboard';

      } catch (error: any) {
        console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.error('âŒ [LOGIN] ERRO capturado:', error);
        console.error('âŒ [LOGIN] Mensagem:', error.message);
        console.error('âŒ [LOGIN] Stack:', error.stack);
        console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        // Mensagens de erro amigÃ¡veis
        let errorMsg = 'Erro ao fazer login. Verifique suas credenciais.';

        if (error.message?.includes('Email ou senha incorretos')) {
          errorMsg = 'Email ou senha incorretos.';
        } else if (error.message?.includes('Email nÃ£o confirmado')) {
          errorMsg = 'Email nÃ£o confirmado. Verifique sua caixa de entrada.';
        } else if (error.message?.includes('Network') || error.message?.includes('Failed to fetch')) {
          errorMsg = 'Erro de conexÃ£o. Verifique sua internet.';
        } else if (error.message) {
          errorMsg = error.message;
        }

        showError(errorMsg);

        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Entrar';
        console.log('ğŸ”„ [LOGIN] BotÃ£o reabilitado');
      }
    });

    function showError(message: string) {
      console.log('âš ï¸ [LOGIN] Mostrando erro:', message);
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
    }

    function hideError() {
      errorMessage.textContent = '';
      errorMessage.classList.remove('show');
    }

    // Limpar erro ao digitar
    const inputs = form?.querySelectorAll('input');
    inputs?.forEach((input) => {
      input.addEventListener('input', hideError);
    });

    console.log('âœ… [LOGIN SCRIPT] ConfiguraÃ§Ã£o completa! Aguardando submit...');
  </script>
</Layout>
