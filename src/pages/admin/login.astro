---
import Layout from '../../layouts/Layout.astro';
import '../../styles/pages/admin/login.css';
---

<Layout
  title="Admin Login - Sr. IPHONE VCA"
  description="Área administrativa do catálogo Sr. IPHONE VCA"
>
  <div class="login-page">
    <div class="login-container">
      <!-- Logo -->
      <div class="login-logo-section">
        <img
          src="/images/logo-fundo.webp"
          alt="Sr. IPHONE VCA"
          class="login-logo"
        />
        <h1 class="login-title">Admin - Sr. IPHONE VCA</h1>
        <p class="login-subtitle">Área administrativa do catálogo</p>
      </div>

      <!-- Login Form -->
      <div class="login-form-wrapper">
        <h2 class="login-form-title">Entrar no Painel</h2>

        <form id="login-form" class="login-form">
          <div class="login-form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="seu@email.com"
            />
          </div>

          <div class="login-form-group">
            <label for="password">Senha</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              placeholder="••••••••"
            />
          </div>

          <div id="error-message" class="login-error-message"></div>

          <button type="submit" id="submit-btn" class="login-submit-btn">
            Entrar
          </button>
        </form>
      </div>

      <p class="login-footer">
        © 2024 Sr. IPHONE VCA. Todos os direitos reservados.
      </p>
    </div>
  </div>
</Layout>

<script>
  import { authService } from '../../lib/supabase';

  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorMessage = document.getElementById(
    'error-message',
  ) as HTMLDivElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    // Hide error message
    errorMessage.classList.remove('show');
    errorMessage.textContent = '';

    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Entrando...';

    try {
      const response = await fetch('/api/admin/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Erro ao fazer login');
      }

      // Store access token in localStorage for client-side requests
      if (data.session?.access_token) {
        localStorage.setItem('sb-access-token', data.session.access_token);
      }

      // Redirect to dashboard
      window.location.href = '/admin/dashboard';
    } catch (error: any) {
      // Show error message
      errorMessage.textContent =
        error.message || 'Erro ao fazer login. Verifique suas credenciais.';
      errorMessage.classList.add('show');

      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.textContent = 'Entrar';
    }
  });
</script>
