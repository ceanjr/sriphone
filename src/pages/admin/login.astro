---
import Layout from '../../layouts/Layout.astro';
import '../../styles/pages/admin/login.css';
---

<Layout
  title="Admin Login - Sr. IPHONE VCA"
  description="√Årea administrativa do cat√°logo Sr. IPHONE VCA"
>
  <div class="login-page">
    <div class="login-container">
      <!-- Logo -->
      <div class="login-logo-section">
        <img
          src="/images/logo-fundo.webp"
          alt="Sr. IPHONE VCA"
          class="login-logo"
        />
        <h1 class="login-title">Admin - Sr. IPHONE VCA</h1>
        <p class="login-subtitle">√Årea administrativa do cat√°logo</p>
      </div>

      <!-- Login Form -->
      <div class="login-form-wrapper">
        <h2 class="login-form-title">Entrar no Painel</h2>

        <form id="login-form" class="login-form">
          <div class="login-form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="seu@email.com"
              autocomplete="email"
            />
          </div>

          <div class="login-form-group">
            <label for="password">Senha</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              autocomplete="current-password"
            />
          </div>

          <div id="error-message" class="login-error-message"></div>

          <button type="submit" id="submit-btn" class="login-submit-btn">
            Entrar
          </button>
        </form>
      </div>

      <p class="login-footer">
        ¬© 2024 Sr. IPHONE VCA. Todos os direitos reservados.
      </p>
    </div>
  </div>
</Layout>

<script>
  import { supabase, authService } from '../../lib/supabase';

  // üî• 1. Listener de autentica√ß√£o (executa automaticamente ap√≥s login)
  const { data: listener } = supabase.auth.onAuthStateChange(
    (event, session) => {
      if (event === 'SIGNED_IN' && session) {
        console.log('‚úÖ Sess√£o criada, redirecionando...');
        window.location.replace('/admin/dashboard'); // recarrega a p√°gina e passa pelo middleware
      }
    },
  );

  checkIfAlreadyAuthenticated();

  // Verificar se j√° est√° autenticado ao carregar a p√°gina
  async function checkIfAlreadyAuthenticated() {
    try {
      const isAuth = await authService.isAuthenticated();
      // S√≥ redireciona se realmente estiver autenticado (sess√£o v√°lida)
      if (isAuth) {
        window.location.href = '/admin/dashboard';
      }
    } catch (error) {
      // N√£o faz nada se n√£o estiver autenticado
      // Apenas loga o erro para debug
      console.error('Erro ao verificar autentica√ß√£o:', error);
    }
  }

  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorMessage = document.getElementById(
    'error-message',
  ) as HTMLDivElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    // Valida√ß√£o b√°sica
    if (!email || !password) {
      showError('Por favor, preencha todos os campos.');
      return;
    }

    // Hide error message
    hideError();

    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Entrando...';

    try {
      // Fazer login usando o authService
      await authService.signIn(email, password);

      // Verificar se realmente est√° autenticado
      const isAuth = await authService.isAuthenticated();

      if (isAuth) {
        // Sucesso! Redirecionar para dashboard
        window.location.href = '/admin/dashboard';
      } else {
        throw new Error('Falha ao estabelecer sess√£o');
      }
    } catch (error: any) {
      console.error('Erro no login:', error);

      // Mensagens de erro mais amig√°veis
      let errorMsg = 'Erro ao fazer login. Verifique suas credenciais.';

      if (error.message?.includes('Invalid login credentials')) {
        errorMsg = 'Email ou senha incorretos.';
      } else if (error.message?.includes('Email not confirmed')) {
        errorMsg = 'Email n√£o confirmado. Verifique sua caixa de entrada.';
      } else if (error.message?.includes('Network')) {
        errorMsg = 'Erro de conex√£o. Verifique sua internet.';
      }

      showError(errorMsg);

      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.textContent = 'Entrar';
    }
  });

  function showError(message: string) {
    errorMessage.textContent = message;
    errorMessage.classList.add('show');
  }

  function hideError() {
    errorMessage.textContent = '';
    errorMessage.classList.remove('show');
  }

  // Limpar erro ao digitar
  const inputs = form?.querySelectorAll('input');
  inputs?.forEach((input) => {
    input.addEventListener('input', hideError);
  });
</script>
