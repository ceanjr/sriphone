---
import AdminLayout from '../../layouts/AdminLayout.astro';
import ConfirmModal from '../../components/admin/ConfirmModal.astro';
import '../../styles/admin-list.css';
import '../../styles/admin-form.css';
---

<AdminLayout title="Categorias">
  <div class="admin-list-container">
    <div class="admin-list-header">
      <div class="admin-list-title-group">
        <h1 class="admin-list-title">Categorias</h1>
        <p class="admin-list-subtitle">Organize seus produtos por categorias</p>
      </div>
    </div>

    <!-- Form Card -->
    <div class="form-card" style="margin-bottom: 24px;">
      <form
        id="category-form"
        style="display: flex; gap: 12px; align-items: flex-end;"
      >
        <input type="hidden" id="edit-category-id" />
        <div class="form-group" style="flex: 1; margin: 0;">
          <label class="form-label" for="category-name">
            Nome da Categoria
            <span class="form-label-required">*</span>
          </label>
          <input
            id="category-name"
            type="text"
            class="form-input"
            placeholder="Ex: iPhones, Acess√≥rios..."
            required
          />
        </div>
        <button
          type="submit"
          id="submit-category-btn"
          class="form-btn form-btn-submit"
          style="flex-shrink: 0;"
        >
          <span id="submit-category-text">Adicionar</span>
        </button>
        <button
          type="button"
          id="cancel-edit-btn"
          class="form-btn form-btn-cancel hidden"
          style="flex-shrink: 0;"
        >
          Cancelar
        </button>
      </form>
    </div>

    <div id="category-list-root"></div>
  </div>

  <ConfirmModal />
</AdminLayout>

<script>
  const form = document.getElementById('category-form') as HTMLFormElement;
  const nameInput = document.getElementById(
    'category-name',
  ) as HTMLInputElement;
  const editIdInput = document.getElementById(
    'edit-category-id',
  ) as HTMLInputElement;
  const submitBtn = document.getElementById(
    'submit-category-btn',
  ) as HTMLButtonElement;
  const submitText = document.getElementById(
    'submit-category-text',
  ) as HTMLSpanElement;
  const cancelBtn = document.getElementById(
    'cancel-edit-btn',
  ) as HTMLButtonElement;
  const listRoot = document.getElementById('category-list-root') as HTMLElement;

  // ==================== API Functions ====================
  async function getCategorias() {
    try {
      const response = await fetch('/api/admin/categorias');
      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Erro ao buscar categorias');
      }

      return {
        success: true,
        data: result.data || [],
      };
    } catch (error: any) {
      console.error('Erro ao buscar categorias:', error);
      return {
        success: false,
        error: error.message,
        data: [],
      };
    }
  }

  async function criarCategoria(nome: string) {
    try {
      if (!nome || nome.trim() === '') {
        return { success: false, error: 'Nome √© obrigat√≥rio' };
      }

      const response = await fetch('/api/admin/categorias', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome: nome.trim() }),
      });

      const text = await response.text();
      let result = null;

      if (text) {
        try {
          result = JSON.parse(text);
        } catch (e) {
          throw new Error('Resposta inv√°lida da API');
        }
      }

      if (!response.ok) {
        throw new Error(result?.error || 'Erro ao criar categoria');
      }

      return result;
    } catch (error: any) {
      console.error('Erro ao criar categoria:', error);
      return { success: false, error: error.message };
    }
  }

  async function editarCategoria(id: string, nome: string) {
    try {
      if (!id || !nome?.trim()) {
        return { success: false, error: 'ID e nome s√£o obrigat√≥rios' };
      }

      const response = await fetch(`/api/admin/categorias/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome: nome.trim() }),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Erro ao editar categoria');
      }

      return result;
    } catch (error: any) {
      console.error('Erro ao editar categoria:', error);
      return { success: false, error: error.message };
    }
  }

  async function deletarCategoria(id: string) {
    try {
      if (!id) {
        return { success: false, error: 'ID √© obrigat√≥rio' };
      }

      const response = await fetch(`/api/admin/categorias/${id}`, {
        method: 'DELETE',
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Erro ao deletar categoria');
      }

      return result;
    } catch (error: any) {
      console.error('Erro ao deletar categoria:', error);
      return { success: false, error: error.message };
    }
  }

  // ==================== Render ====================
  async function renderCategoryList() {
    if (!listRoot) return;

    listRoot.innerHTML = '<div class="admin-list-loading">Carregando...</div>';

    try {
      const res = await getCategorias();

      if (!res.success) {
        throw new Error(res.error || 'Erro ao carregar');
      }

      const categorias = res.data || [];

      if (categorias.length === 0) {
        listRoot.innerHTML = `<div class="admin-empty-state">
          <div class="admin-empty-state-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
          </div>
          <h3 class="admin-empty-state-title">Nenhuma categoria criada</h3>
          <p class="admin-empty-state-text">Use o formul√°rio acima para criar sua primeira categoria</p>
        </div>`;
        return;
      }

      listRoot.innerHTML = `<div class="admin-list-items">
        ${categorias
          .map(
            (cat: any) => `
          <div class="admin-list-item">
            <div class="admin-list-item-image placeholder">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
            </div>
            <div class="admin-list-item-content">
              <h3 class="admin-list-item-title">${cat.nome}</h3>
              <div class="admin-list-item-meta">
                <span class="admin-list-item-badge">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                  ${cat.produtos_count || 0} produto${cat.produtos_count !== 1 ? 's' : ''}
                </span>
              </div>
            </div>
            <div class="admin-list-item-actions">
              <button class="admin-list-item-btn" data-action="edit" data-id="${cat.id}" data-nome="${cat.nome}" title="Editar categoria">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
              </button>
              <button class="admin-list-item-btn danger" data-action="delete" data-id="${cat.id}" data-nome="${cat.nome}" title="Deletar categoria">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
          </div>
        `,
          )
          .join('')}
      </div>`;

      bindListEvents();
    } catch (err: any) {
      console.error('Erro ao renderizar:', err);
      listRoot.innerHTML = `<div class="admin-list-error">
        Erro ao carregar categorias: ${err.message || 'Desconhecido'}
      </div>`;
    }
  }

  function bindListEvents() {
    document.querySelectorAll('[data-action="edit"]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const el = btn as HTMLElement;
        const id = el.dataset.id || '';
        const nome = el.dataset.nome || '';

        nameInput.value = nome;
        editIdInput.value = id;
        submitText.textContent = 'Salvar';
        cancelBtn.classList.remove('hidden');
        nameInput.focus();
      });
    });

    document.querySelectorAll('[data-action="delete"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const el = btn as HTMLElement;
        const id = el.dataset.id;
        const nome = el.dataset.nome;

        if (!id) return;

        const confirmed = await (window as any).confirmModal.show(
          'Deletar Categoria',
          `Tem certeza que deseja deletar "${nome}"? Esta a√ß√£o n√£o pode ser desfeita.`,
        );

        if (confirmed) {
          const result = await deletarCategoria(id);
          if (result.success) {
            (window as any).showToast('Categoria deletada!', 'success');
            // ‚úÖ CR√çTICO: Atualizar lista imediatamente
            await renderCategoryList();
          } else {
            (window as any).showToast(
              result.error || 'Erro ao deletar',
              'error',
            );
          }
        }
      });
    });
  }

  // Submit form
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const nome = nameInput.value.trim();
    const editId = editIdInput.value;
    const isEdit = !!editId;

    if (!nome) return;

    submitBtn.disabled = true;
    submitText.textContent = isEdit ? 'Salvando...' : 'Adicionando...';

    try {
      console.log('üîÑ Submetendo:', { nome, isEdit, editId });

      const result = isEdit
        ? await editarCategoria(editId, nome)
        : await criarCategoria(nome);

      console.log('üì• Resultado:', result);

      if (!result.success) {
        throw new Error(result.error || 'Erro ao salvar');
      }

      // ‚úÖ Toast de sucesso
      if (typeof window.showToast === 'function') {
        window.showToast(
          isEdit ? 'Categoria atualizada!' : 'Categoria criada!',
          'success',
        );
      }

      // ‚úÖ Resetar formul√°rio
      form.reset();
      editIdInput.value = '';
      cancelBtn.classList.add('hidden');
      submitText.textContent = 'Adicionar';

      // ‚úÖ CR√çTICO: Atualizar lista ap√≥s pequeno delay
      console.log('üîÑ Atualizando lista...');
      setTimeout(async () => {
        await renderCategoryList();
        console.log('‚úÖ Lista atualizada!');
      }, 100);
    } catch (error: any) {
      console.error('‚ùå Erro:', error);
      if (typeof window.showToast === 'function') {
        window.showToast(error.message || 'Erro ao salvar', 'error');
      }
    } finally {
      submitBtn.disabled = false;
      submitText.textContent = isEdit ? 'Salvar' : 'Adicionar';
    }
  });

  // Cancel edit
  cancelBtn?.addEventListener('click', () => {
    form.reset();
    editIdInput.value = '';
    cancelBtn.classList.add('hidden');
    submitText.textContent = 'Adicionar';
  });

  // Initial render
  renderCategoryList();
</script>

<style>
  /* Garantir que o modal de confirma√ß√£o n√£o fique gigante */
  .confirm-modal {
    z-index: 9999 !important;
  }

  .confirm-dialog {
    max-width: 400px !important;
  }

  .confirm-icon {
    width: 48px !important;
    height: 48px !important;
  }

  .confirm-icon svg {
    width: 24px !important;
    height: 24px !important;
  }

  /* Loading/Error states */
  .admin-list-loading,
  .admin-list-error {
    text-align: center;
    padding: 3rem 1rem;
    color: #a0a0a0;
  }

  .admin-list-error {
    color: #ef4444;
  }
</style>
