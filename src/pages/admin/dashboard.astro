---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { createClient } from '@supabase/supabase-js';
import '../../styles/pages/admin/dashboard.css';

export const prerender = false;

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

// Buscar estatísticas
const { data: produtos } = await supabase
  .from('produtos')
  .select('id, ativo, visualizacoes_total');

const totalProdutos = produtos?.length || 0;
const produtosAtivos = produtos?.filter((p) => p.ativo).length || 0;
const produtosInativos = totalProdutos - produtosAtivos;
const totalVisualizacoes =
  produtos?.reduce((acc, p) => acc + (p.visualizacoes_total || 0), 0) || 0;

// Top 5 produtos mais visualizados
const { data: topProdutos } = await supabase
  .from('produtos')
  .select('id, nome, visualizacoes_total, foto_principal')
  .order('visualizacoes_total', { ascending: false })
  .limit(5);
---

<AdminLayout
  title="Dashboard"
  description="Visão geral do catálogo de produtos"
>
  <div class="dashboard-page">
    <!-- Header -->
    <div class="dashboard-header">
      <div class="dashboard-header-content">
        <h1 class="dashboard-title">Dashboard</h1>
        <p class="dashboard-subtitle">Visão geral do catálogo de produtos</p>
      </div>
    </div>

    <!-- Content -->
    <div class="dashboard-content">
      <!-- Cards de Estatísticas -->
      <div class="dashboard-stats-grid">
        <!-- Total de Produtos -->
        <div class="dashboard-stat-card">
          <div class="dashboard-stat-card-header">
            <h3 class="dashboard-stat-card-title">Total de Produtos</h3>
            <svg
              class="dashboard-stat-card-icon"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
              ></path>
            </svg>
          </div>
          <div class="dashboard-stat-card-body">
            <div class="dashboard-stat-card-value">{totalProdutos}</div>
            <p class="dashboard-stat-card-description">
              {produtosAtivos} ativos, {produtosInativos} inativos
            </p>
          </div>
        </div>

        <!-- Produtos Ativos -->
        <div class="dashboard-stat-card">
          <div class="dashboard-stat-card-header">
            <h3 class="dashboard-stat-card-title">Produtos Ativos</h3>
            <svg
              class="dashboard-stat-card-icon green"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
              ></path>
            </svg>
          </div>
          <div class="dashboard-stat-card-body">
            <div class="dashboard-stat-card-value">{produtosAtivos}</div>
            <p class="dashboard-stat-card-description">Visíveis no catálogo</p>
          </div>
        </div>

        <!-- Produtos Inativos -->
        <div class="dashboard-stat-card">
          <div class="dashboard-stat-card-header">
            <h3 class="dashboard-stat-card-title">Produtos Inativos</h3>
            <svg
              class="dashboard-stat-card-icon red"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
              ></path>
            </svg>
          </div>
          <div class="dashboard-stat-card-body">
            <div class="dashboard-stat-card-value">{produtosInativos}</div>
            <p class="dashboard-stat-card-description">Não visíveis</p>
          </div>
        </div>

        <!-- Total de Visualizações -->
        <div class="dashboard-stat-card">
          <div class="dashboard-stat-card-header">
            <h3 class="dashboard-stat-card-title">Total de Visualizações</h3>
            <svg
              class="dashboard-stat-card-icon blue"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              ></path>
            </svg>
          </div>
          <div class="dashboard-stat-card-body">
            <div class="dashboard-stat-card-value">
              {totalVisualizacoes.toLocaleString('pt-BR')}
            </div>
            <p class="dashboard-stat-card-description">De todos os produtos</p>
          </div>
        </div>
      </div>

      <!-- Top Produtos -->
      {
        topProdutos && topProdutos.length > 0 && (
          <div class="dashboard-top-products">
            <h2 class="dashboard-top-products-title">
              Produtos Mais Visualizados
            </h2>
            <div class="dashboard-top-products-list">
              {topProdutos.map((produto, index) => (
                <div class="dashboard-top-product-item">
                  <span class="dashboard-top-product-rank">{index + 1}</span>
                  {produto.foto_principal && (
                    <img
                      src={produto.foto_principal}
                      alt={produto.nome}
                      class="dashboard-top-product-image"
                    />
                  )}
                  <div class="dashboard-top-product-info">
                    <p class="dashboard-top-product-name">{produto.nome}</p>
                    <p class="dashboard-top-product-views">
                      {produto.visualizacoes_total.toLocaleString('pt-BR')}{' '}
                      visualizações
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )
      }

      <!-- Ações Rápidas -->
      <div class="dashboard-actions-grid">
        <a href="/admin/produtos" class="dashboard-action-card">
          <div class="dashboard-action-icon-wrapper">
            <svg
              class="dashboard-action-icon"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
              ></path>
            </svg>
          </div>
          <div class="dashboard-action-content">
            <h3>Gerenciar Produtos</h3>
            <p>Adicionar, editar ou remover</p>
          </div>
        </a>

        <a href="/admin/categorias" class="dashboard-action-card">
          <div class="dashboard-action-icon-wrapper">
            <svg
              class="dashboard-action-icon"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
              ></path>
            </svg>
          </div>
          <div class="dashboard-action-content">
            <h3>Gerenciar Categorias</h3>
            <p>Organizar produtos</p>
          </div>
        </a>
      </div>
    </div>
  </div>
</AdminLayout>
