---
import AdminLayout from '../../layouts/AdminLayout.astro';
import DashboardHeader from '../../components/admin/DashboardHeader.astro';
import { supabaseAdmin } from '../../lib/supabaseAdmin';
import '../../styles/pages/admin/dashboard.css';

export const prerender = false; // Força SSR sem cache para admin

// Buscar estatísticas
const { data: produtos } = await supabaseAdmin
  .from('produtos')
  .select('id, ativo, visualizacoes_total');

const totalProdutos = produtos?.length || 0;
const produtosAtivos = produtos?.filter((p) => p.ativo).length || 0;
const produtosInativos = totalProdutos - produtosAtivos;
const totalVisualizacoes =
  produtos?.reduce((acc, p) => acc + (p.visualizacoes_total || 0), 0) || 0;

// Top 5 produtos mais visualizados
const { data: topProdutos } = await supabaseAdmin
  .from('produtos')
  .select('id, nome, visualizacoes_total, foto_principal')
  .order('visualizacoes_total', { ascending: false })
  .limit(5);
---

<AdminLayout
  title="Dashboard"
  description="Visão geral do catálogo de produtos"
>
  <div class="dashboard-page">
    <DashboardHeader />

    <!-- Content -->
    <div class="dashboard-content">
      <!-- Cards de Estatísticas -->
      <div class="dashboard-stats-grid">
        <!-- Total de Produtos -->
        <div class="dashboard-stat-card">
          <div class="dashboard-stat-card-header">
            <h3 class="dashboard-stat-card-title">Total de Produtos</h3>
            <svg
              class="dashboard-stat-card-icon"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
              ></path>
            </svg>
          </div>
          <div class="dashboard-stat-card-body">
            <div class="dashboard-stat-card-value">{totalProdutos}</div>
            <p class="dashboard-stat-card-description">
              {produtosAtivos} ativos, {produtosInativos} inativos
            </p>
          </div>
        </div>

        <!-- Total de Visualizações -->
        <div class="dashboard-stat-card">
          <div class="dashboard-stat-card-header">
            <h3 class="dashboard-stat-card-title">Total de Visualizações</h3>
            <svg
              class="dashboard-stat-card-icon blue"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              ></path>
            </svg>
          </div>
          <div class="dashboard-stat-card-body">
            <div class="dashboard-stat-card-value">
              {totalVisualizacoes.toLocaleString('pt-BR')}
            </div>
            <p class="dashboard-stat-card-description">De todos os produtos</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>
