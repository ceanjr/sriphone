---
// src/pages/catalogo-debug.astro
// VERS√ÉO DE DIAGN√ìSTICO COM LOGS VERBOSOS
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

const metaDescription = 'P√°gina de debug do cat√°logo';
---

<Layout title="Debug Cat√°logo | Sr. IPHONE" description={metaDescription}>
  <Header />

  <main class="catalogo-page" style="padding: 2rem; background: #000; color: #fff; min-height: 100vh;">
    <div style="max-width: 1200px; margin: 0 auto;">
      <h1 style="color: #ff0; font-size: 2rem; margin-bottom: 1rem;">üîç DIAGN√ìSTICO DO CAT√ÅLOGO</h1>

      <div id="debug-console" style="background: #1a1a1a; padding: 1.5rem; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
        <div style="color: #0f0; margin-bottom: 1rem;">‚úÖ HTML carregado com sucesso</div>
        <div id="debug-output"></div>
      </div>

      <div style="margin-top: 2rem; padding: 1.5rem; background: #2a2a2a; border-radius: 8px;">
        <h2 style="color: #ff0; margin-bottom: 1rem;">üìã Instru√ß√µes:</h2>
        <ol style="line-height: 1.8;">
          <li>Abra o DevTools (F12)</li>
          <li>V√° para a aba Console</li>
          <li>Observe os logs abaixo E no console do browser</li>
          <li>Identifique onde o erro ocorre</li>
          <li>Copie os logs e envie para an√°lise</li>
        </ol>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  // ============================================================================
  // DIAGN√ìSTICO EXTREMAMENTE VERBOSO
  // ============================================================================

  const debugOutput = document.getElementById('debug-output');
  const startTime = performance.now();

  function log(message: string, type: 'info' | 'success' | 'error' | 'warn' = 'info') {
    const timestamp = (performance.now() - startTime).toFixed(2);
    const colors = {
      info: '#0ff',
      success: '#0f0',
      error: '#f00',
      warn: '#ff0'
    };

    const logEntry = document.createElement('div');
    logEntry.style.color = colors[type];
    logEntry.style.marginBottom = '0.5rem';
    logEntry.textContent = `[${timestamp}ms] ${message}`;

    if (debugOutput) {
      debugOutput.appendChild(logEntry);
    }

    console.log(`[${timestamp}ms] ${message}`);
  }

  log('üöÄ INICIANDO DIAGN√ìSTICO...', 'info');
  log(`üìç URL: ${window.location.href}`, 'info');
  log(`üìç Mode: ${import.meta.env.MODE}`, 'info');
  log(`üìç DEV: ${import.meta.env.DEV}`, 'info');
  log(`üìç PROD: ${import.meta.env.PROD}`, 'info');

  // ============================================================================
  // TESTE 1: Verificar vari√°veis de ambiente
  // ============================================================================
  log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
  log('TESTE 1: Vari√°veis de Ambiente', 'warn');
  log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

  try {
    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
    const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

    if (supabaseUrl) {
      log(`‚úÖ PUBLIC_SUPABASE_URL: ${supabaseUrl.substring(0, 30)}...`, 'success');
    } else {
      log('‚ùå PUBLIC_SUPABASE_URL: UNDEFINED', 'error');
    }

    if (supabaseKey) {
      log(`‚úÖ PUBLIC_SUPABASE_ANON_KEY: ${supabaseKey.substring(0, 20)}...`, 'success');
    } else {
      log('‚ùå PUBLIC_SUPABASE_ANON_KEY: UNDEFINED', 'error');
    }
  } catch (error) {
    log(`‚ùå ERRO ao verificar env vars: ${error}`, 'error');
  }

  // ============================================================================
  // TESTE 2: Tentar importar m√≥dulo supabase
  // ============================================================================
  log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
  log('TESTE 2: Import do Supabase', 'warn');
  log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

  let supabaseImportSuccess = false;

  try {
    log('‚è≥ Tentando importar supabase...', 'info');

    import('../lib/supabase')
      .then((module) => {
        log('‚úÖ Supabase importado com sucesso!', 'success');
        log(`‚úÖ Exports: ${Object.keys(module).join(', ')}`, 'success');
        supabaseImportSuccess = true;

        // Continuar com pr√≥ximo teste
        testeImportsCatalogo();
      })
      .catch((error) => {
        log(`‚ùå ERRO ao importar supabase: ${error.message}`, 'error');
        log(`‚ùå Stack: ${error.stack}`, 'error');
        supabaseImportSuccess = false;
      });

  } catch (error: any) {
    log(`‚ùå EXCE√á√ÉO ao importar supabase: ${error.message}`, 'error');
  }

  // ============================================================================
  // TESTE 3: Imports dos m√≥dulos do cat√°logo
  // ============================================================================
  async function testeImportsCatalogo() {
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
    log('TESTE 3: Imports do Cat√°logo', 'warn');
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

    const imports = [
      { name: 'state', path: '../lib/catalog/core/state' },
      { name: 'config', path: '../lib/catalog/core/config' },
      { name: 'logic', path: '../lib/catalog/logic' },
      { name: 'renderer', path: '../lib/catalog/render/renderer' },
      { name: 'templates', path: '../lib/catalog/render/templates' },
      { name: 'handlers', path: '../lib/catalog/ui/handlers' },
      { name: 'events', path: '../lib/catalog/ui/events' },
      { name: 'imageLoader', path: '../lib/catalog/performance/imageLoader' },
      { name: 'metrics', path: '../lib/catalog/performance/metrics' },
      { name: 'utils', path: '../lib/catalog/utils' },
    ];

    for (const imp of imports) {
      try {
        log(`‚è≥ Importando ${imp.name}...`, 'info');
        const module = await import(imp.path);
        log(`‚úÖ ${imp.name} importado! Exports: ${Object.keys(module).join(', ')}`, 'success');
      } catch (error: any) {
        log(`‚ùå ERRO ao importar ${imp.name}: ${error.message}`, 'error');
      }
    }

    // Teste final
    testeDOMElements();
  }

  // ============================================================================
  // TESTE 4: Elementos DOM
  // ============================================================================
  function testeDOMElements() {
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
    log('TESTE 4: Elementos DOM', 'warn');
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

    const elements = [
      'debug-console',
      'debug-output',
    ];

    elements.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        log(`‚úÖ Elemento #${id} encontrado`, 'success');
      } else {
        log(`‚ùå Elemento #${id} N√ÉO encontrado`, 'error');
      }
    });

    // Teste Service Worker
    testeServiceWorker();
  }

  // ============================================================================
  // TESTE 5: Service Worker
  // ============================================================================
  function testeServiceWorker() {
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
    log('TESTE 5: Service Worker', 'warn');
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

    if ('serviceWorker' in navigator) {
      log('‚úÖ Service Worker API dispon√≠vel', 'success');

      navigator.serviceWorker.getRegistrations().then(registrations => {
        if (registrations.length > 0) {
          log(`‚ö†Ô∏è ATEN√á√ÉO: ${registrations.length} Service Worker(s) registrado(s)!`, 'warn');
          registrations.forEach((reg, i) => {
            log(`  SW ${i + 1}: ${reg.scope}`, 'warn');
          });
          log('‚ö†Ô∏è Isso pode estar causando problemas em dev!', 'warn');
        } else {
          log('‚úÖ Nenhum Service Worker registrado', 'success');
        }
      });

      // Verificar caches
      if ('caches' in window) {
        caches.keys().then(cacheNames => {
          if (cacheNames.length > 0) {
            log(`‚ö†Ô∏è ATEN√á√ÉO: ${cacheNames.length} cache(s) ativo(s)!`, 'warn');
            cacheNames.forEach((name, i) => {
              log(`  Cache ${i + 1}: ${name}`, 'warn');
            });
          } else {
            log('‚úÖ Nenhum cache ativo', 'success');
          }
        });
      }
    } else {
      log('‚ÑπÔ∏è Service Worker API n√£o dispon√≠vel', 'info');
    }

    // Finalizar diagn√≥stico
    finalizarDiagnostico();
  }

  // ============================================================================
  // FINALIZA√á√ÉO
  // ============================================================================
  function finalizarDiagnostico() {
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
    log('DIAGN√ìSTICO COMPLETO', 'success');
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

    const totalTime = performance.now() - startTime;
    log(`‚è±Ô∏è Tempo total: ${totalTime.toFixed(2)}ms`, 'info');

    log('', 'info');
    log('üìã PR√ìXIMOS PASSOS:', 'warn');
    log('1. Verifique os erros em vermelho acima', 'info');
    log('2. Copie todos os logs deste painel', 'info');
    log('3. Verifique tamb√©m o Console do DevTools (F12)', 'info');
    log('4. Envie os logs para an√°lise', 'info');
  }

  // ============================================================================
  // CAPTURA DE ERROS GLOBAIS
  // ============================================================================
  window.addEventListener('error', (event) => {
    log(`‚ùå ERRO GLOBAL: ${event.message}`, 'error');
    log(`   Arquivo: ${event.filename}`, 'error');
    log(`   Linha: ${event.lineno}:${event.colno}`, 'error');
  });

  window.addEventListener('unhandledrejection', (event) => {
    log(`‚ùå PROMISE REJEITADA: ${event.reason}`, 'error');
  });

  log('‚úÖ Listeners de erro configurados', 'success');
</script>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: #000;
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
</style>
