---
import Layout from './Layout.astro';
import Sidebar from '../components/admin/Sidebar.astro';
import MobileNav from '../components/admin/MobileNav.astro';
import Toast from '../components/admin/Toast.astro';
import '../styles/admin.css';
import { verifyAuth } from '../lib/auth';

interface Props {
  title: string;
  description?: string;
}

const { title, description = 'Painel administrativo Sr. IPHONE VCA' } =
  Astro.props;

// Prote√ß√£o de rota admin
console.log('[AdminLayout] Iniciando verifica√ß√£o de autentica√ß√£o...');
const currentPath = Astro.url.pathname;
const isLoginPage =
  currentPath === '/admin/login' || currentPath === '/admin/login/';

console.log('[AdminLayout] Caminho atual:', currentPath);
console.log('[AdminLayout] √â p√°gina de login?', isLoginPage);

try {
  const isAuthenticated = await verifyAuth(
    Astro.cookies,
    Astro.request.headers.get('Authorization'),
  );
  console.log('[AdminLayout] Resultado da autentica√ß√£o:', isAuthenticated);

  if (!isAuthenticated && !isLoginPage) {
    console.log(
      '[AdminLayout] N√£o autenticado, redirecionando para /admin/login',
    );
    return Astro.redirect('/admin/login');
  }
} catch (err) {
  console.log('[AdminLayout] Erro na verifica√ß√£o de autentica√ß√£o:', err);
  if (!isLoginPage) {
    return Astro.redirect('/admin/login');
  }
}
---

<Layout title={title} description={description}>
  <div class="admin-layout">
    <!-- Sidebar Desktop -->
    <aside class="admin-sidebar">
      <Sidebar />
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <slot />
    </main>
    <!-- Mobile Navigation -->
  </div>
  <MobileNav />

  <!-- Toast Notifications -->
  <Toast />

  <!-- Script de diagn√≥stico inline -->
  <script is:inline>
    (function() {
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üîç [ADMIN LAYOUT] Script iniciado');
      console.log('üîç [ADMIN LAYOUT] URL:', window.location.href);
      console.log('üîç [ADMIN LAYOUT] Timestamp:', new Date().toISOString());
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

      // Interceptar todos os clicks em links para debug
      document.addEventListener('click', function(e) {
        const target = e.target;
        const link = target.closest('a');

        if (link && link.href) {
          console.log('üîó [NAVIGATION] Link clicado:', link.href);
          console.log('üîó [NAVIGATION] Text:', link.textContent?.trim());
          console.log('üîó [NAVIGATION] Target:', link.target);
        }
      }, true);

      // Log quando a p√°gina est√° pronta para navegar
      window.addEventListener('load', () => {
        console.log('‚úÖ [ADMIN LAYOUT] P√°gina completamente carregada');
      });
    })();
  </script>
</Layout>
