---
import Layout from './Layout.astro';
import Sidebar from '../components/admin/Sidebar.astro';
import MobileNav from '../components/admin/MobileNav.astro';
import Toast from '../components/admin/Toast.astro';
import ConfirmModal from '../components/admin/ConfirmModal.astro';
import '../styles/admin.css';
import { verifyAuth } from '../lib/auth';

interface Props {
  title: string;
  description?: string;
}

const { title, description = 'Painel administrativo Sr. IPHONE VCA' } =
  Astro.props;

// Proteção de rota admin
console.log('[AdminLayout] Iniciando verificação de autenticação...');
const token =
  Astro.cookies.get('sb-access-token')?.value ||
  Astro.request.headers.get('Authorization');
console.log('[AdminLayout] Token encontrado:', token);
try {
  const isAuthenticated = await verifyAuth(
    Astro.cookies,
    Astro.request.headers.get('Authorization'),
  );
  console.log('[AdminLayout] Resultado da autenticação:', isAuthenticated);
  if (!isAuthenticated && Astro.request.url !== '/admin/login') {
    console.log(
      '[AdminLayout] Não autenticado, redirecionando para /admin/login',
    );
    return Astro.redirect('/admin/login');
  }
} catch (err) {
  console.log('[AdminLayout] Erro na verificação de autenticação:', err);
  return Astro.redirect('/admin/login');
}
---

---

<Layout title={title} description={description}>
  <div class="admin-layout">
    <!-- Sidebar Desktop -->
    <aside class="admin-sidebar">
      <Sidebar />
    </aside>

    <!-- Mobile Navigation -->
    <MobileNav />

    <!-- Main Content -->
    <main class="admin-main">
      <slot />
    </main>
  </div>

  <!-- Toast Notifications -->
  <Toast />

  <!-- Confirm Modal -->
  <ConfirmModal />
</Layout>
