<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Limpar Cache - Sr. IPHONE VCA</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    h1 {
      margin: 0 0 20px 0;
      font-size: 24px;
    }
    button {
      background: #fff;
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 12px;
    }
    button:hover {
      background: #e0e0e0;
    }
    #log {
      background: #000;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-line {
      margin-bottom: 8px;
      padding: 4px 0;
      border-bottom: 1px solid #333;
    }
    .success { color: #4ade80; }
    .error { color: #ef4444; }
    .info { color: #60a5fa; }
    .warning { color: #fbbf24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üßπ Limpar Cache Completo</h1>
    <p>Use este utilit√°rio para for√ßar limpeza completa de todos os caches.</p>

    <button onclick="clearEverything()">üöÄ LIMPAR TUDO E RECARREGAR</button>
    <button onclick="unregisterServiceWorker()">üîß Desregistrar Service Worker</button>
    <button onclick="clearLocalStorage()">üíæ Limpar localStorage</button>
    <button onclick="clearCaches()">üóëÔ∏è Limpar Caches</button>
    <button onclick="showCacheInfo()">‚ÑπÔ∏è Mostrar Info de Cache</button>

    <div id="log"></div>
  </div>

  <script>
    const logEl = document.getElementById('log');

    function log(message, type = 'info') {
      const line = document.createElement('div');
      line.className = `log-line ${type}`;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    async function clearEverything() {
      log('üöÄ Iniciando limpeza completa...', 'info');

      // 1. Desregistrar Service Worker
      await unregisterServiceWorker();

      // 2. Limpar localStorage
      await clearLocalStorage();

      // 3. Limpar todos os caches
      await clearCaches();

      log('‚úÖ Limpeza completa conclu√≠da!', 'success');
      log('üîÑ Recarregando em 2 segundos...', 'info');

      setTimeout(() => {
        window.location.href = '/admin/login';
      }, 2000);
    }

    async function unregisterServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          log(`üìã Encontrados ${registrations.length} service workers`, 'info');

          for (const registration of registrations) {
            await registration.unregister();
            log('‚úÖ Service Worker desregistrado', 'success');
          }
        } catch (error) {
          log(`‚ùå Erro ao desregistrar SW: ${error.message}`, 'error');
        }
      } else {
        log('‚ö†Ô∏è Service Worker n√£o suportado', 'warning');
      }
    }

    async function clearLocalStorage() {
      try {
        const itemCount = localStorage.length;
        log(`üìã Limpando ${itemCount} itens do localStorage...`, 'info');

        // Listar todos os itens antes de limpar
        const items = [];
        for (let i = 0; i < localStorage.length; i++) {
          items.push(localStorage.key(i));
        }
        items.forEach(key => log(`  - ${key}`, 'info'));

        localStorage.clear();
        log('‚úÖ localStorage limpo', 'success');

        // Limpar tamb√©m sessionStorage
        sessionStorage.clear();
        log('‚úÖ sessionStorage limpo', 'success');

        // Limpar cookies do Supabase
        const cookies = ['sb-access-token', 'sb-refresh-token', 'sb-auth-token'];
        cookies.forEach(name => {
          document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
          log(`‚úÖ Cookie limpo: ${name}`, 'success');
        });
      } catch (error) {
        log(`‚ùå Erro ao limpar localStorage: ${error.message}`, 'error');
      }
    }

    async function clearCaches() {
      if ('caches' in window) {
        try {
          const cacheNames = await caches.keys();
          log(`üìã Encontrados ${cacheNames.length} caches`, 'info');

          for (const cacheName of cacheNames) {
            await caches.delete(cacheName);
            log(`‚úÖ Cache deletado: ${cacheName}`, 'success');
          }
        } catch (error) {
          log(`‚ùå Erro ao limpar caches: ${error.message}`, 'error');
        }
      } else {
        log('‚ö†Ô∏è Cache API n√£o suportada', 'warning');
      }
    }

    async function showCacheInfo() {
      log('‚ÑπÔ∏è Informa√ß√µes do sistema:', 'info');
      log(`URL atual: ${window.location.href}`, 'info');
      log(`User Agent: ${navigator.userAgent}`, 'info');

      // localStorage
      if (typeof localStorage !== 'undefined') {
        log(`\nüì¶ localStorage (${localStorage.length} itens):`, 'info');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          const preview = value.length > 50 ? value.substring(0, 50) + '...' : value;
          log(`  ${key}: ${preview}`, 'info');
        }
      }

      // Caches
      if ('caches' in window) {
        const cacheNames = await caches.keys();
        log(`\nüóÑÔ∏è Caches (${cacheNames.length}):`, 'info');
        cacheNames.forEach(name => log(`  - ${name}`, 'info'));
      }

      // Service Workers
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        log(`\n‚öôÔ∏è Service Workers (${registrations.length}):`, 'info');
        registrations.forEach((reg, i) => {
          log(`  ${i + 1}. Scope: ${reg.scope}`, 'info');
          log(`     Active: ${reg.active ? 'SIM' : 'N√ÉO'}`, 'info');
        });
      }

      // Cookies
      log(`\nüç™ Cookies:`, 'info');
      const cookies = document.cookie.split(';');
      cookies.forEach(cookie => {
        const [name] = cookie.split('=');
        log(`  - ${name.trim()}`, 'info');
      });
    }

    // Executar ao carregar
    log('üîß Utilit√°rio de limpeza carregado', 'success');
    log('Clique em um dos bot√µes acima para executar a a√ß√£o desejada', 'info');
  </script>
</body>
</html>
